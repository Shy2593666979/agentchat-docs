# 服务管理

<cite>
**本文档引用的文件**
- [start.sh](https://github.com/Shy2593666979/AgentChat/docker/start.sh)
- [stop.sh](https://github.com/Shy2593666979/AgentChat/docker/stop.sh)
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml)
- [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml)
- [Dockerfile](https://github.com/Shy2593666979/AgentChat/docker/Dockerfile)
- [docker.env.example](https://github.com/Shy2593666979/AgentChat/docker/docker.env.example)
- [nginx.conf](https://github.com/Shy2593666979/AgentChat/docker/nginx.conf)
- [README.md](https://github.com/Shy2593666979/AgentChat/docker/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心服务组件](#核心服务组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [服务启动管理](#服务启动管理)
7. [服务停止管理](#服务停止管理)
8. [配置文件管理](#配置文件管理)
9. [健康检查机制](#健康检查机制)
10. [日志监控与诊断](#日志监控与诊断)
11. [常见问题排查](#常见问题排查)
12. [性能监控与优化](#性能监控与优化)
13. [总结](#总结)

## 简介

AgentChat 是一个基于 Docker 容器化的智能对话平台，采用微服务架构设计。本指南详细介绍了服务的启动、停止、重启和状态监控操作，以及相关的配置管理和故障排除方法。

## 项目结构概览

AgentChat 的服务管理主要集中在 `docker/` 目录下，包含以下核心文件：

```mermaid
graph TB
subgraph "Docker 服务管理"
A[start.sh] --> B[服务启动脚本]
C[stop.sh] --> D[服务停止脚本]
E[docker-compose.yml] --> F[开发环境配置]
G[docker-compose.prod.yml] --> H[生产环境配置]
I[Dockerfile] --> J[后端镜像构建]
K[network.conf] --> L[Nginx 反向代理]
end
subgraph "配置文件"
M[docker.env.example] --> N[环境变量模板]
end
A --> E
C --> E
E --> G
```

**图表来源**
- [start.sh](https://github.com/Shy2593666979/AgentChat/docker/start.sh#L1-L52)
- [stop.sh](https://github.com/Shy2593666979/AgentChat/docker/stop.sh#L1-L35)
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L1-L126)
- [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52)

## 核心服务组件

AgentChat 包含以下核心服务组件：

| 服务名称 | 容器名称 | 端口 | 功能描述 | 健康检查 |
|---------|---------|------|----------|----------|
| MySQL数据库 | agentchat-mysql | 3306 | 主数据库存储 | mysqladmin ping |
| Redis缓存 | agentchat-redis | 6379 | 缓存和会话存储 | redis-cli ping |
| 后端API | agentchat-backend | 7860 | FastAPI应用服务 | curl health check |
| 前端开发 | agentchat-frontend | 8090 | Vue3开发服务器 | curl health check |

**章节来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L8-L126)

## 架构概览

AgentChat 采用多层架构设计，支持开发和生产两种环境：

```mermaid
graph TB
subgraph "客户端层"
A[Web浏览器] --> B[Nginx反向代理]
end
subgraph "负载均衡层"
B --> C[前端服务:8090]
B --> D[后端服务:7860]
end
subgraph "应用服务层"
C --> E[Vue3前端应用]
D --> F[FastAPI后端服务]
end
subgraph "数据存储层"
F --> G[MySQL数据库:3306]
F --> H[Redis缓存:6379]
end
subgraph "网络层"
I[agentchat-network] --> C
I --> D
I --> E
I --> F
I --> G
I --> H
end
```

**图表来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L3-L6)
- [nginx.conf](https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L67-L101)

## 详细组件分析

### 后端服务组件

后端服务基于 FastAPI 框架构建，采用 Uvicorn 作为 ASGI 服务器：

```mermaid
classDiagram
class BackendService {
+string container_name : agentchat-backend
+string image : python : 3.12-slim
+string[] depends_on : mysql, redis
+HealthCheck healthcheck
+EnvironmentVariables environment
+start() void
+restart() void
+stop() void
+getStatus() ServiceStatus
}
class HealthCheck {
+string[] test : curl health endpoint
+Duration interval : 30s
+Duration timeout : 10s
+int retries : 3
}
class EnvironmentVariables {
+string DATABASE_URL
+string REDIS_URL
+string APP_ENV
+string JWT_SECRET_KEY
+string[] AI_API_KEYS
}
BackendService --> HealthCheck
BackendService --> EnvironmentVariables
```

**图表来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L51-L93)
- [Dockerfile](https://github.com/Shy2593666979/AgentChat/docker/Dockerfile#L1-L39)

### 数据库服务组件

MySQL 和 Redis 服务提供数据持久化和缓存功能：

```mermaid
sequenceDiagram
participant BC as Backend Container
participant MC as MySQL Container
participant RC as Redis Container
BC->>MC : 连接数据库 (3306)
MC-->>BC : 数据库就绪
BC->>RC : 连接缓存 (6379)
RC-->>BC : 缓存就绪
BC->>MC : 执行健康检查
MC-->>BC : PING响应
BC->>RC : 执行健康检查
RC-->>BC : PING响应
```

**图表来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L8-L49)

**章节来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L8-L93)

## 服务启动管理

### 启动脚本分析

启动脚本 `start.sh` 提供了完整的服务启动流程：

```mermaid
flowchart TD
A[开始启动] --> B{检查docker.env文件}
B --> |不存在| C[复制配置模板]
B --> |存在| D[创建必要目录]
C --> D
D --> E[构建并启动服务]
E --> F[等待10秒]
F --> G[检查服务状态]
G --> H[显示访问信息]
H --> I[结束]
style A fill:#e1f5fe
style I fill:#c8e6c9
```

**图表来源**
- [start.sh](https://github.com/Shy2593666979/AgentChat/docker/start.sh#L1-L52)

### 启动流程详解

1. **环境变量检查**：自动检测并创建环境变量配置文件
2. **目录创建**：初始化数据和日志目录
3. **服务构建**：使用 Docker Compose 构建并启动所有服务
4. **健康检查**：等待服务启动并验证状态

### 启动命令使用

```bash
# 进入docker目录
cd docker

# 设置执行权限
chmod +x start.sh stop.sh

# 启动所有服务
./start.sh
```

**章节来源**
- [start.sh](https://github.com/Shy2593666979/AgentChat/docker/start.sh#L1-L52)

## 服务停止管理

### 停止脚本分析

停止脚本提供了安全的服务终止机制：

```mermaid
flowchart TD
A[开始停止] --> B[停止所有容器]
B --> C[询问是否删除数据]
C --> |是| D[清理数据卷]
C --> |否| E[保留数据]
D --> F[清理构建缓存]
E --> G[显示重新启动提示]
F --> G
G --> H[结束]
style A fill:#ffebee
style H fill:#c8e6c9
```

**图表来源**
- [stop.sh](https://github.com/Shy2593666979/AgentChat/docker/stop.sh#L1-L35)

### 停止选项说明

| 选项 | 功能描述 | 数据处理 |
|------|----------|----------|
| 停止容器 | 正常关闭所有服务 | 保留 |
| 删除数据 | 清理所有数据卷 | 删除 |
| 清理缓存 | 移除构建缓存 | 删除 |

**章节来源**
- [stop.sh](https://github.com/Shy2593666979/AgentChat/docker/stop.sh#L1-L35)

## 配置文件管理

### 环境变量配置

AgentChat 使用 `.env` 文件管理环境变量：

```mermaid
graph LR
subgraph "配置分类"
A[AI模型配置] --> B[OpenAI API Key]
A --> C[Anthropic API Key]
A --> D[通义千问 API Key]
E[数据库配置] --> F[MySQL 密码]
E --> G[Redis 密码]
H[安全配置] --> I[JWT Secret Key]
J[应用配置] --> K[应用环境]
J --> L[日志级别]
end
```

**图表来源**
- [docker.env.example](https://github.com/Shy2593666979/AgentChat/docker/docker.env.example#L1-L73)

### 配置文件结构

| 配置类别 | 关键字 | 默认值 | 说明 |
|---------|--------|--------|------|
| AI模型 | OPENAI_API_KEY | - | OpenAI API 密钥 |
| 数据库 | MYSQL_ROOT_PASSWORD | 123456 | MySQL root 密码 |
| 安全 | JWT_SECRET_KEY | - | JWT 加密密钥 |
| 应用 | APP_ENV | development | 应用环境类型 |

**章节来源**
- [docker.env.example](https://github.com/Shy2593666979/AgentChat/docker/docker.env.example#L1-L73)

## 健康检查机制

### 服务健康检查配置

每个服务都配置了相应的健康检查机制：

```mermaid
graph TB
subgraph "健康检查类型"
A[MySQL健康检查] --> B[mysqladmin ping]
C[Redis健康检查] --> D[redis-cli ping]
E[后端健康检查] --> F[curl /health]
G[前端健康检查] --> H[curl /]
end
subgraph "检查参数"
I[间隔时间: 30s/60s]
J[超时时间: 10s/30s]
K[重试次数: 3次]
L[启动期: 40s/30s]
end
```

**图表来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L26-L118)
- [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L14-L34)

### 健康检查策略

| 服务类型 | 检查方式 | 检查频率 | 超时时间 | 重试次数 |
|---------|----------|----------|----------|----------|
| 数据库服务 | 命令行工具 | 30秒 | 20秒 | 10次 |
| 缓存服务 | CLI工具 | 30秒 | 10秒 | 3次 |
| Web服务 | HTTP请求 | 30/60秒 | 10/30秒 | 3次 |

**章节来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L26-L118)
- [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L14-L52)

## 日志监控与诊断

### 日志查看命令

AgentChat 提供了多种日志查看方式：

```mermaid
flowchart LR
A[docker-compose logs] --> B[查看所有服务日志]
A --> C[查看特定服务日志]
A --> D[实时跟踪日志]
B --> E[docker-compose logs -f]
C --> F[docker-compose logs -f backend]
D --> G[--tail=100 参数]
style A fill:#e3f2fd
style B fill:#f3e5f5
```

### 日志管理命令

| 命令 | 功能 | 使用场景 |
|------|------|----------|
| `docker-compose logs -f` | 实时跟踪所有日志 | 服务监控 |
| `docker-compose logs -f backend` | 查看后端服务日志 | 后端问题排查 |
| `docker-compose logs -f frontend` | 查看前端服务日志 | 前端问题排查 |
| `docker-compose logs --tail=100 backend` | 查看最近100行日志 | 快速定位问题 |

### 容器状态监控

```bash
# 查看服务状态
docker-compose ps

# 查看容器资源使用情况
docker stats

# 查看特定容器统计信息
docker stats agentchat-backend agentchat-frontend
```

**章节来源**
- [start.sh](https://github.com/Shy2593666979/AgentChat/docker/start.sh#L45-L48)
- [README.md](https://github.com/Shy2593666979/AgentChat/docker/README.md#L115-L167)

## 常见问题排查

### 服务启动失败

```mermaid
flowchart TD
A[服务启动失败] --> B{检查日志}
B --> C[配置文件错误]
B --> D[端口冲突]
B --> E[依赖服务未就绪]
C --> F[检查docker.env配置]
D --> G[修改端口映射]
E --> H[等待健康检查]
F --> I[重新启动服务]
G --> I
H --> I
```

### 端口冲突解决

当遇到端口占用问题时：

```bash
# 检查端口占用
lsof -i :7860
lsof -i :8090

# 修改docker-compose.yml中的端口映射
ports:
  - "17860:7860"  # 改为其他端口
```

### 数据库连接问题

```bash
# 检查MySQL容器状态
docker-compose ps mysql

# 进入MySQL容器进行诊断
docker-compose exec mysql mysql -u root -p

# 重置数据库服务
docker-compose down mysql
docker volume rm docker_mysql_data
docker-compose up -d mysql
```

### API密钥配置问题

```bash
# 检查环境变量
docker-compose exec backend printenv | grep API_KEY

# 重新设置环境变量
vim docker.env
docker-compose restart backend
```

**章节来源**
- [README.md](https://github.com/Shy2593666979/AgentChat/docker/README.md#L170-L250)

## 性能监控与优化

### 资源监控

```bash
# 实时监控容器资源使用
docker stats

# 监控特定服务
docker stats agentchat-backend agentchat-frontend

# 查看容器网络状态
docker network ls
docker network inspect agentchat-network
```

### 性能优化建议

| 优化方面 | 建议配置 | 说明 |
|---------|----------|------|
| 内存限制 | Redis: 512MB, MySQL: 1GB | 防止内存溢出 |
| CPU核心数 | 后端: 4核 | 提高并发处理能力 |
| 网络带宽 | 根据需求调整 | 优化网络传输效率 |
| 存储I/O | SSD存储 | 提高数据读写速度 |

### 生产环境配置

生产环境使用专门的配置文件：

```mermaid
graph TB
subgraph "开发环境"
A[docker-compose.yml] --> B[开发服务配置]
C[热重载] --> D[快速开发]
end
subgraph "生产环境"
E[docker-compose.prod.yml] --> F[生产服务配置]
G[Gunicorn + Uvicorn] --> H[高性能部署]
end
style E fill:#e8f5e8
style G fill:#fff3e0
```

**图表来源**
- [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L1-L126)
- [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52)

**章节来源**
- [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52)
- [README.md](https://github.com/Shy2593666979/AgentChat/docker/README.md#L250-L272)

## 总结

AgentChat 的服务管理系统提供了完整的一站式解决方案，包括：

1. **自动化启动管理**：通过 `start.sh` 脚本实现一键启动
2. **灵活的配置管理**：支持开发和生产环境的不同配置
3. **完善的健康检查**：确保服务稳定运行
4. **全面的日志监控**：便于问题诊断和性能优化
5. **详细的故障排除**：提供常见问题的解决方案

通过遵循本指南中的最佳实践，可以确保 AgentChat 服务的稳定运行和高效管理。定期监控服务状态、及时处理异常情况，以及根据实际需求调整配置参数，都是维护系统稳定性的关键措施。