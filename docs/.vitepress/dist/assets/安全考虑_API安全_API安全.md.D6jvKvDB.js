import{_ as a,c as n,o as i,ag as l}from"./chunks/framework.7BqJGZTL.js";const E=JSON.parse('{"title":"AgentChat API安全架构文档","description":"","frontmatter":{},"headers":[],"relativePath":"安全考虑/API安全/API安全.md","filePath":"安全考虑/API安全/API安全.md","lastUpdated":1764244560000}'),e={name:"安全考虑/API安全/API安全.md"};function t(p,s,r,h,d,o){return i(),n("div",null,[...s[0]||(s[0]=[l(`<h1 id="agentchat-api安全架构文档" tabindex="-1">AgentChat API安全架构文档 <a class="header-anchor" href="#agentchat-api安全架构文档" aria-label="Permalink to &quot;AgentChat API安全架构文档&quot;">​</a></h1><cite> **本文档引用的文件** - [pyodide.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/tool.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/tool.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/tool.py) - [codeact_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/codeact_agent.py) - [tool.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/tool.json) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#概述">概述</a></li><li><a href="#沙箱执行环境架构">沙箱执行环境架构</a></li><li><a href="#权限控制系统">权限控制系统</a></li><li><a href="#资源限制机制">资源限制机制</a></li><li><a href="#工具调用api安全">工具调用API安全</a></li><li><a href="#安全风险与缓解措施">安全风险与缓解措施</a></li><li><a href="#最佳实践指南">最佳实践指南</a></li><li><a href="#总结">总结</a></li></ol><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>AgentChat采用了一套完整的API安全架构来保护系统免受恶意代码执行攻击。核心安全机制围绕着基于Deno子进程和WebAssembly技术的Pyodide沙箱环境构建，提供了细粒度的权限控制和资源限制功能。</p><p>该安全架构的主要特点包括：</p><ul><li>基于Deno的多层安全隔离</li><li>细粒度的权限控制系统</li><li>执行时间和内存限制</li><li>状态化和非状态化两种执行模式</li><li>完整的错误处理和监控机制</li></ul><h2 id="沙箱执行环境架构" tabindex="-1">沙箱执行环境架构 <a class="header-anchor" href="#沙箱执行环境架构" aria-label="Permalink to &quot;沙箱执行环境架构&quot;">​</a></h2><h3 id="pyodidesandbox类设计" tabindex="-1">PyodideSandbox类设计 <a class="header-anchor" href="#pyodidesandbox类设计" aria-label="Permalink to &quot;PyodideSandbox类设计&quot;">​</a></h3><p>AgentChat的核心安全机制由<code>PyodideSandbox</code>类实现，该类提供了异步和同步两种执行模式：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class BasePyodideSandbox {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+bool stateful</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+list permissions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(stateful, allow_env, allow_read, allow_write, allow_net, allow_run, allow_ffi)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_build_command(code, session_bytes, session_metadata, memory_limit_mb) list</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class PyodideSandbox {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+execute(code, session_bytes, session_metadata, timeout_seconds, memory_limit_mb) CodeExecutionResult</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+async execute_async()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class SyncPyodideSandbox {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+execute(code, session_bytes, session_metadata, timeout_seconds, memory_limit_mb) CodeExecutionResult</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class PyodideSandboxTool {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+bool stateful</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+float timeout_seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_sandbox PyodideSandbox</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_sync_sandbox SyncPyodideSandbox</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_run(code, state, tool_call_id, config, run_manager) Any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_arun(code, state, tool_call_id, config, run_manager) Any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BasePyodideSandbox &lt;|-- PyodideSandbox</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BasePyodideSandbox &lt;|-- SyncPyodideSandbox</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PyodideSandboxTool --&gt; PyodideSandbox : uses</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PyodideSandboxTool --&gt; SyncPyodideSandbox : uses</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L66-L737" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="deno子进程安全模型" tabindex="-1">Deno子进程安全模型 <a class="header-anchor" href="#deno子进程安全模型" aria-label="Permalink to &quot;Deno子进程安全模型&quot;">​</a></h3><p>沙箱通过以下方式确保安全性：</p><ol><li><strong>进程隔离</strong>：每个代码执行都在独立的Deno进程中进行</li><li><strong>WebAssembly边界</strong>：Python代码运行在Pyodide的WebAssembly环境中</li><li><strong>权限边界</strong>：Deno的安全模型限制了进程可以访问的资源</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L67-L88" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="权限控制系统" tabindex="-1">权限控制系统 <a class="header-anchor" href="#权限控制系统" aria-label="Permalink to &quot;权限控制系统&quot;">​</a></h2><h3 id="核心权限参数" tabindex="-1">核心权限参数 <a class="header-anchor" href="#核心权限参数" aria-label="Permalink to &quot;核心权限参数&quot;">​</a></h3><p>PyodideSandbox提供了六个主要的权限控制参数：</p><table tabindex="0"><thead><tr><th>权限类型</th><th>参数名</th><th>默认值</th><th>安全级别</th><th>用途</th></tr></thead><tbody><tr><td>环境变量访问</td><td>allow_env</td><td>False</td><td>最高</td><td>控制对系统环境变量的访问</td></tr><tr><td>文件读取权限</td><td>allow_read</td><td>False</td><td>高</td><td>限制文件系统读取操作</td></tr><tr><td>文件写入权限</td><td>allow_write</td><td>False</td><td>高</td><td>限制文件系统写入操作</td></tr><tr><td>网络访问</td><td>allow_net</td><td>False</td><td>中等</td><td>控制网络连接能力</td></tr><tr><td>子进程执行</td><td>allow_run</td><td>False</td><td>低</td><td>阻止新进程启动</td></tr><tr><td>外部函数接口</td><td>allow_ffi</td><td>False</td><td>极低</td><td>禁止系统级库调用</td></tr></tbody></table><h3 id="权限配置机制" tabindex="-1">权限配置机制 <a class="header-anchor" href="#权限配置机制" aria-label="Permalink to &quot;权限配置机制&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[权限配置] --&gt; B{权限类型判断}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |布尔值True| C[完全访问权限]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |布尔值False| D[无访问权限]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |字符串列表| E[受限访问权限]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; F[添加Deno标志]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; G[跳过权限设置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; H[验证路径有效性]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; I[构建命令行参数]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J[执行沙箱代码]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L42-L63" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="默认权限策略" tabindex="-1">默认权限策略 <a class="header-anchor" href="#默认权限策略" aria-label="Permalink to &quot;默认权限策略&quot;">​</a></h3><p>系统采用了最小权限原则，默认情况下所有权限都被禁用：</p><ul><li><strong>文件系统权限</strong>：默认允许访问<code>node_modules</code>目录</li><li><strong>网络权限</strong>：默认完全禁用</li><li><strong>环境变量</strong>：默认完全禁用</li><li><strong>子进程</strong>：默认完全禁用</li><li><strong>FFI</strong>：默认完全禁用</li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L177-L196" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="资源限制机制" tabindex="-1">资源限制机制 <a class="header-anchor" href="#资源限制机制" aria-label="Permalink to &quot;资源限制机制&quot;">​</a></h2><h3 id="执行超时控制" tabindex="-1">执行超时控制 <a class="header-anchor" href="#执行超时控制" aria-label="Permalink to &quot;执行超时控制&quot;">​</a></h3><p>系统实现了多层次的超时控制机制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as 客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Sandbox as 沙箱</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Deno as Deno进程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Monitor as 超时监控器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;Sandbox : 提交代码执行请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Deno : 启动Deno子进程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Monitor : 设置执行超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alt 正常执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Deno-&gt;&gt;Sandbox : 返回执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Client : 返回成功响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">else 超时发生</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Monitor-&gt;&gt;Deno : 发送终止信号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Deno-&gt;&gt;Sandbox : 进程被终止</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Client : 返回超时错误</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L296-L336" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="内存限制机制" tabindex="-1">内存限制机制 <a class="header-anchor" href="#内存限制机制" aria-label="Permalink to &quot;内存限制机制&quot;">​</a></h3><p>通过V8引擎的内存管理实现：</p><ol><li><strong>V8标志配置</strong>：使用<code>--max-old-space-size</code>参数限制内存使用</li><li><strong>动态调整</strong>：支持运行时动态设置内存限制</li><li><strong>强制回收</strong>：超过限制时触发垃圾回收机制</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L227-L228" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="工具调用api安全" tabindex="-1">工具调用API安全 <a class="header-anchor" href="#工具调用api安全" aria-label="Permalink to &quot;工具调用API安全&quot;">​</a></h2><h3 id="工具服务架构" tabindex="-1">工具服务架构 <a class="header-anchor" href="#工具服务架构" aria-label="Permalink to &quot;工具服务架构&quot;">​</a></h3><p>AgentChat提供了完整的工具管理API，包含以下安全特性：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;API层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[工具创建API]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B[工具查询API]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[工具更新API]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[工具删除API]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;服务层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[ToolService]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[权限验证]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[数据验证]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据库层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[工具DAO]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I[用户权限检查]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; H</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/tool.py#L9-L124" target="_blank" rel="noreferrer">tool.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/tool.py#L1-L86" target="_blank" rel="noreferrer">tool.py</a></li></ul><h3 id="用户权限验证" tabindex="-1">用户权限验证 <a class="header-anchor" href="#用户权限验证" aria-label="Permalink to &quot;用户权限验证&quot;">​</a></h3><p>系统实现了严格的权限控制：</p><ol><li><strong>管理员权限</strong>：系统管理员拥有最高权限</li><li><strong>用户权限</strong>：普通用户只能操作自己的工具</li><li><strong>权限继承</strong>：系统工具对所有用户可见但受权限控制</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/tool.py#L27-L31" target="_blank" rel="noreferrer">tool.py</a></li></ul><h3 id="代码执行流程" tabindex="-1">代码执行流程 <a class="header-anchor" href="#代码执行流程" aria-label="Permalink to &quot;代码执行流程&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant User as 用户</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant API as 工具API</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Service as 工具服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Sandbox as 代码沙箱</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Agent as 代码代理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User-&gt;&gt;API : 调用工具执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Service : 验证用户权限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;Service : 检查工具可用性</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;Agent : 创建代码上下文</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Sandbox : 执行Python代码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Agent : 返回执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Service : 处理执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;API : 返回最终结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;User : 响应执行状态</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/codeact_agent.py#L100-L136" target="_blank" rel="noreferrer">codeact_agent.py</a></li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/codeact_agent.py#L100-L136" target="_blank" rel="noreferrer">codeact_agent.py</a></li></ul><h2 id="安全风险与缓解措施" tabindex="-1">安全风险与缓解措施 <a class="header-anchor" href="#安全风险与缓解措施" aria-label="Permalink to &quot;安全风险与缓解措施&quot;">​</a></h2><h3 id="主要安全风险" tabindex="-1">主要安全风险 <a class="header-anchor" href="#主要安全风险" aria-label="Permalink to &quot;主要安全风险&quot;">​</a></h3><ol><li><p><strong>沙箱逃逸攻击</strong></p><ul><li>利用Deno或Pyodide的漏洞突破隔离</li><li>通过精心构造的代码尝试访问受限资源</li></ul></li><li><p><strong>资源耗尽攻击</strong></p><ul><li>无限循环导致CPU占用过高</li><li>内存泄漏导致系统内存耗尽</li></ul></li><li><p><strong>权限提升攻击</strong></p><ul><li>利用默认权限配置尝试获取更高权限</li><li>社会工程学诱导获得敏感权限</li></ul></li><li><p><strong>数据泄露风险</strong></p><ul><li>敏感信息意外输出到标准输出</li><li>临时文件中的敏感数据残留</li></ul></li></ol><h3 id="缓解措施" tabindex="-1">缓解措施 <a class="header-anchor" href="#缓解措施" aria-label="Permalink to &quot;缓解措施&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[安全风险] --&gt; B[防护措施]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A1[沙箱逃逸] --&gt; B1[定期更新Deno和Pyodide版本]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A1 --&gt; B2[严格权限配置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A1 --&gt; B3[进程监控和审计]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A2[资源耗尽] --&gt; B4[执行超时控制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A2 --&gt; B5[内存使用限制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A2 --&gt; B6[CPU使用监控]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A3[权限提升] --&gt; B7[最小权限原则]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A3 --&gt; B8[权限审计]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A3 --&gt; B9[定期安全评估]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A4[数据泄露] --&gt; B10[输出过滤]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A4 --&gt; B11[临时文件清理]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A4 --&gt; B12[日志脱敏]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="安全监控机制" tabindex="-1">安全监控机制 <a class="header-anchor" href="#安全监控机制" aria-label="Permalink to &quot;安全监控机制&quot;">​</a></h3><ol><li><strong>执行时间监控</strong>：实时跟踪代码执行时间</li><li><strong>内存使用监控</strong>：监控内存消耗趋势</li><li><strong>异常检测</strong>：识别可疑的执行模式</li><li><strong>审计日志</strong>：记录所有沙箱操作</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L283-L336" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="最佳实践指南" tabindex="-1">最佳实践指南 <a class="header-anchor" href="#最佳实践指南" aria-label="Permalink to &quot;最佳实践指南&quot;">​</a></h2><h3 id="沙箱配置最佳实践" tabindex="-1">沙箱配置最佳实践 <a class="header-anchor" href="#沙箱配置最佳实践" aria-label="Permalink to &quot;沙箱配置最佳实践&quot;">​</a></h3><ol><li><p><strong>权限最小化原则</strong></p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 推荐：仅开放必要的权限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sandbox </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PyodideSandbox(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/safe/path&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_net</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;api.example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    timeout_seconds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不推荐：过度开放权限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sandbox </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PyodideSandbox(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">allow_read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">allow_net</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li><li><p><strong>合理设置超时时间</strong></p><ul><li>简单计算：5-10秒</li><li>复杂算法：30-60秒</li><li>数据处理：60-120秒</li></ul></li><li><p><strong>内存限制建议</strong></p><ul><li>小型脚本：64MB-128MB</li><li>中等复杂度：256MB-512MB</li><li>大型应用：1GB以上</li></ul></li></ol><h3 id="开发安全规范" tabindex="-1">开发安全规范 <a class="header-anchor" href="#开发安全规范" aria-label="Permalink to &quot;开发安全规范&quot;">​</a></h3><ol><li><p><strong>输入验证</strong></p><ul><li>验证所有用户输入</li><li>过滤危险字符和序列</li><li>限制输入长度</li></ul></li><li><p><strong>输出控制</strong></p><ul><li>使用print()显式输出</li><li>避免f-string格式化</li><li>注意敏感信息泄露</li></ul></li><li><p><strong>错误处理</strong></p><ul><li>捕获并处理所有异常</li><li>提供有意义的错误信息</li><li>记录安全相关事件</li></ul></li></ol><h3 id="部署安全建议" tabindex="-1">部署安全建议 <a class="header-anchor" href="#部署安全建议" aria-label="Permalink to &quot;部署安全建议&quot;">​</a></h3><ol><li><p><strong>环境隔离</strong></p><ul><li>在专用容器中运行</li><li>使用非root用户权限</li><li>网络隔离配置</li></ul></li><li><p><strong>定期更新</strong></p><ul><li>及时更新Deno和Pyodide</li><li>应用安全补丁</li><li>监控安全公告</li></ul></li><li><p><strong>监控和审计</strong></p><ul><li>实施全面的日志记录</li><li>设置告警机制</li><li>定期安全审查</li></ul></li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L508-L520" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>AgentChat的API安全架构通过多层次的安全控制机制，为不受信任的代码执行提供了可靠的保护。核心优势包括：</p><ol><li><strong>完善的权限控制</strong>：六层权限体系确保最小权限原则</li><li><strong>有效的资源限制</strong>：超时和内存限制防止资源耗尽攻击</li><li><strong>灵活的执行模式</strong>：支持状态化和非状态化两种模式</li><li><strong>完整的工具管理</strong>：提供安全的工具生命周期管理</li><li><strong>强大的监控机制</strong>：实时监控和审计所有操作</li></ol><p>这套安全架构不仅保护了系统免受恶意攻击，还为开发者提供了安全可靠的代码执行环境。通过遵循最佳实践和持续的安全改进，AgentChat能够安全地支持各种复杂的代码执行需求。</p>`,82)])])}const k=a(e,[["render",t]]);export{E as __pageData,k as default};
