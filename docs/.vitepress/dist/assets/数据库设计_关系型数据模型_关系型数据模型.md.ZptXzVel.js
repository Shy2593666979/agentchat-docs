import{_ as a,c as e,o as n,ag as i}from"./chunks/framework.D0TaUBpX.js";const k=JSON.parse('{"title":"关系型数据模型","description":"","frontmatter":{},"headers":[],"relativePath":"数据库设计/关系型数据模型/关系型数据模型.md","filePath":"数据库设计/关系型数据模型/关系型数据模型.md","lastUpdated":1764244560000}'),l={name:"数据库设计/关系型数据模型/关系型数据模型.md"};function t(p,s,r,o,d,c){return n(),e("div",null,[...s[0]||(s[0]=[i(`<h1 id="关系型数据模型" tabindex="-1">关系型数据模型 <a class="header-anchor" href="#关系型数据模型" aria-label="Permalink to &quot;关系型数据模型&quot;">​</a></h1><cite> **本文档中引用的文件** - [base.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/base.py) - [user.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py) - [agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py) - [dialog.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py) - [message.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/message.py) - [knowledge.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge.py) - [knowledge_file.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge_file.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/tool.py) - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py) - [workspace_session.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/workspace_session.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#核心数据模型">核心数据模型</a></li><li><a href="#模型关系与er图">模型关系与ER图</a></li><li><a href="#orm映射与序列化机制">ORM映射与序列化机制</a></li><li><a href="#查询性能优化建议">查询性能优化建议</a></li><li><a href="#总结">总结</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>本项目采用SQLModel作为ORM框架，构建了一个完整的智能对话系统后端数据模型。模型涵盖了用户管理、智能体配置、对话会话、消息记录、知识库管理、工具定义、MCP服务配置和工作区会话等核心功能模块。所有模型均继承自<code>SQLModelSerializable</code>基类，实现了统一的序列化行为和敏感字段过滤机制。</p><h2 id="核心数据模型" tabindex="-1">核心数据模型 <a class="header-anchor" href="#核心数据模型" aria-label="Permalink to &quot;核心数据模型&quot;">​</a></h2><h3 id="用户模型-usertable" tabindex="-1">用户模型 (UserTable) <a class="header-anchor" href="#用户模型-usertable" aria-label="Permalink to &quot;用户模型 (UserTable)&quot;">​</a></h3><p>用户表存储系统用户的基本信息和认证数据。</p><p><strong>字段说明：</strong></p><ul><li><code>user_id</code>: 用户唯一标识符，主键</li><li><code>user_name</code>: 用户名，唯一索引</li><li><code>user_email</code>: 用户邮箱</li><li><code>user_avatar</code>: 用户头像URL</li><li><code>user_description</code>: 用户描述</li><li><code>user_password</code>: 加密后的密码（敏感信息）</li><li><code>delete</code>: 软删除标记</li><li><code>create_time</code>: 创建时间，默认当前时间戳</li><li><code>update_time</code>: 更新时间，自动更新为当前时间戳</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>user_id</code></li><li>唯一索引：<code>user_name</code></li><li>时间字段默认值：<code>CURRENT_TIMESTAMP</code></li></ul><p><strong>业务含义：</strong> 系统支持普通用户和管理员用户，通过<code>user_id</code>为&#39;0&#39;或&#39;1&#39;进行区分。密码字段经过加密处理，确保用户认证安全。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py#L18-L34" target="_blank" rel="noreferrer">user.py</a></li></ul><h3 id="智能体模型-agenttable" tabindex="-1">智能体模型 (AgentTable) <a class="header-anchor" href="#智能体模型-agenttable" aria-label="Permalink to &quot;智能体模型 (AgentTable)&quot;">​</a></h3><p>智能体表存储Agent的配置信息和元数据。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: Agent唯一标识符，主键</li><li><code>name</code>: Agent名称</li><li><code>description</code>: Agent描述</li><li><code>logo_url</code>: Agent图标URL</li><li><code>user_id</code>: 绑定的用户ID，索引</li><li><code>is_custom</code>: 是否为用户自定义Agent</li><li><code>system_prompt</code>: 系统提示词</li><li><code>llm_id</code>: 绑定的LLM模型ID</li><li><code>enable_memory</code>: 是否开启记忆功能</li><li><code>mcp_ids</code>: 绑定的MCP服务列表（JSON存储）</li><li><code>tool_ids</code>: 绑定的工具列表（JSON存储）</li><li><code>knowledge_ids</code>: 绑定的知识库列表（JSON存储）</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>id</code></li><li>索引：<code>user_id</code></li><li>JSON字段：<code>mcp_ids</code>, <code>tool_ids</code>, <code>knowledge_ids</code></li></ul><p><strong>业务含义：</strong> 每个用户可以创建多个自定义Agent，Agent可绑定多个工具、知识库和MCP服务。<code>is_custom</code>字段区分系统预设Agent和用户自定义Agent。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py#L11-L47" target="_blank" rel="noreferrer">agent.py</a></li></ul><h3 id="对话模型-dialogtable" tabindex="-1">对话模型 (DialogTable) <a class="header-anchor" href="#对话模型-dialogtable" aria-label="Permalink to &quot;对话模型 (DialogTable)&quot;">​</a></h3><p>对话表存储用户与Agent的会话信息。</p><p><strong>字段说明：</strong></p><ul><li><code>dialog_id</code>: 对话唯一标识符，主键</li><li><code>name</code>: 对话名称（绑定的Agent名称）</li><li><code>agent_id</code>: 绑定的Agent ID</li><li><code>agent_type</code>: Agent类型（Agent/MCPAgent）</li><li><code>user_id</code>: 用户ID</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>dialog_id</code></li><li>无额外索引</li></ul><p><strong>业务含义：</strong> 每个对话代表用户与特定Agent的一次会话。<code>agent_type</code>字段支持区分不同类型的智能体。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py#L12-L36" target="_blank" rel="noreferrer">dialog.py</a></li></ul><h3 id="消息模型-messagedowntable-messageliketable" tabindex="-1">消息模型 (MessageDownTable &amp; MessageLikeTable) <a class="header-anchor" href="#消息模型-messagedowntable-messageliketable" aria-label="Permalink to &quot;消息模型 (MessageDownTable &amp; MessageLikeTable)&quot;">​</a></h3><p>消息表存储用户与Agent的交互记录。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: 消息唯一标识符，主键</li><li><code>user_input</code>: 用户输入内容（Text类型）</li><li><code>agent_output</code>: Agent输出内容（Text类型）</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>id</code></li><li>文本字段：<code>user_input</code>, <code>agent_output</code>使用Text类型存储长文本</li></ul><p><strong>业务含义：</strong> 系统记录用户点赞和点踩的消息，用于反馈学习和模型优化。两个表结构相同，分别存储不同类型的反馈。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/message.py#L13-L58" target="_blank" rel="noreferrer">message.py</a></li></ul><h3 id="知识库模型-knowledgetable" tabindex="-1">知识库模型 (KnowledgeTable) <a class="header-anchor" href="#知识库模型-knowledgetable" aria-label="Permalink to &quot;知识库模型 (KnowledgeTable)&quot;">​</a></h3><p>知识库表存储知识库的元信息。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: 知识库唯一标识符，主键</li><li><code>name</code>: 知识库名称，唯一索引</li><li><code>description</code>: 知识库描述</li><li><code>user_id</code>: 创建用户ID，索引</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>id</code></li><li>唯一索引：<code>name</code></li><li>索引：<code>user_id</code></li></ul><p><strong>业务含义：</strong> 每个用户可以创建多个知识库，知识库名称全局唯一。<code>id</code>由<code>get_knowledge_id()</code>函数生成，格式为&quot;t_&quot;前缀加16位十六进制字符串。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge.py#L14-L37" target="_blank" rel="noreferrer">knowledge.py</a></li></ul><h3 id="知识文件模型-knowledgefiletable" tabindex="-1">知识文件模型 (KnowledgeFileTable) <a class="header-anchor" href="#知识文件模型-knowledgefiletable" aria-label="Permalink to &quot;知识文件模型 (KnowledgeFileTable)&quot;">​</a></h3><p>知识文件表存储知识库中文件的元数据。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: 文件唯一标识符，主键</li><li><code>file_name</code>: 文件名称，索引</li><li><code>knowledge_id</code>: 所属知识库ID，索引</li><li><code>status</code>: 文件解析状态（success/process/fail）</li><li><code>user_id</code>: 用户ID，索引</li><li><code>oss_url</code>: 文件在OSS中的存储路径</li><li><code>file_size</code>: 文件大小（字节）</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>id</code></li><li>索引：<code>file_name</code>, <code>knowledge_id</code>, <code>user_id</code></li></ul><p><strong>业务含义：</strong> 知识库可包含多个文件，每个文件有独立的解析状态。系统使用OSS存储原始文件，<code>status</code>字段跟踪文件处理进度。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge_file.py#L16-L41" target="_blank" rel="noreferrer">knowledge_file.py</a></li></ul><h3 id="工具模型-tooltable" tabindex="-1">工具模型 (ToolTable) <a class="header-anchor" href="#工具模型-tooltable" aria-label="Permalink to &quot;工具模型 (ToolTable)&quot;">​</a></h3><p>工具表存储可调用工具的定义。</p><p><strong>字段说明：</strong></p><ul><li><code>tool_id</code>: 工具唯一标识符，主键</li><li><code>zh_name</code>: 工具中文名称（显示给用户）</li><li><code>en_name</code>: 工具英文名称（大模型调用）</li><li><code>user_id</code>: 创建用户ID</li><li><code>logo_url</code>: 工具图标URL</li><li><code>description</code>: 工具描述（大模型调用依据）</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>tool_id</code></li></ul><p><strong>业务含义：</strong> 工具由用户创建，支持中英文双语名称。大模型根据<code>description</code>字段决定是否调用该工具。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/tool.py#L12-L36" target="_blank" rel="noreferrer">tool.py</a></li></ul><h3 id="mcp服务模型-mcpservertable" tabindex="-1">MCP服务模型 (MCPServerTable) <a class="header-anchor" href="#mcp服务模型-mcpservertable" aria-label="Permalink to &quot;MCP服务模型 (MCPServerTable)&quot;">​</a></h3><p>MCP服务表存储MCP服务的配置信息。</p><p><strong>字段说明：</strong></p><ul><li><code>mcp_server_id</code>: MCP服务唯一标识符，主键</li><li><code>server_name</code>: 服务名称</li><li><code>user_id</code>: 创建用户ID</li><li><code>user_name</code>: 创建者名称</li><li><code>description</code>: 服务描述</li><li><code>mcp_as_tool_name</code>: 作为子Agent使用时的名称</li><li><code>url</code>: 服务连接地址</li><li><code>type</code>: 连接类型（sse/websocket/stdio）</li><li><code>logo_url</code>: 服务图标URL</li><li><code>config</code>: 配置信息（JSON存储，如API密钥）</li><li><code>tools</code>: 工具列表（JSON存储）</li><li><code>params</code>: 输入参数（JSON存储）</li><li><code>config_enabled</code>: 是否需要用户单独配置参数</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>mcp_server_id</code></li><li><code>type</code>字段：VARCHAR(255)，非空</li></ul><p><strong>业务含义：</strong> MCP服务可作为子Agent集成到系统中，支持多种连接类型。<code>config</code>字段存储敏感配置信息。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py#L30-L62" target="_blank" rel="noreferrer">mcp_server.py</a></li></ul><h3 id="工作区会话模型-workspacesession" tabindex="-1">工作区会话模型 (WorkSpaceSession) <a class="header-anchor" href="#工作区会话模型-workspacesession" aria-label="Permalink to &quot;工作区会话模型 (WorkSpaceSession)&quot;">​</a></h3><p>工作区会话表存储工作区的会话状态。</p><p><strong>字段说明：</strong></p><ul><li><code>session_id</code>: 会话唯一标识符，主键</li><li><code>title</code>: 会话标题</li><li><code>agent</code>: 选用的智能体</li><li><code>user_id</code>: 用户ID</li><li><code>contexts</code>: 结构化对话上下文（JSON存储，包含tasks、questions、answers、guide_prompts）</li><li><code>update_time</code>: 修改时间</li><li><code>create_time</code>: 创建时间</li></ul><p><strong>约束：</strong></p><ul><li>主键：<code>session_id</code></li></ul><p><strong>业务含义：</strong> 工作区会话支持复杂的多轮对话和任务管理，<code>contexts</code>字段以JSON格式存储结构化的对话上下文。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/workspace_session.py#L22-L42" target="_blank" rel="noreferrer">workspace_session.py</a></li></ul><h2 id="模型关系与er图" tabindex="-1">模型关系与ER图 <a class="header-anchor" href="#模型关系与er图" aria-label="Permalink to &quot;模型关系与ER图&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">erDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_name UK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_email</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_avatar</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_password</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean delete</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean is_custom</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string system_prompt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string llm_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean enable_memory</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json mcp_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json tool_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json knowledge_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIALOG {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string dialog_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent_type</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MESSAGE_DOWN {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text user_input</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text agent_output</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MESSAGE_LIKE {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text user_input</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text agent_output</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KNOWLEDGE {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string name UK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KNOWLEDGE_FILE {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string file_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string knowledge_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string status</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string oss_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int file_size</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TOOL {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string tool_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string zh_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string en_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCP_SERVER {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string mcp_server_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string server_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string mcp_as_tool_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string type</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json config</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json tools</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json params</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean config_enabled</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WORKSPACE_SESSION {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string session_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string title</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json contexts</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ AGENT : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ DIALOG : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ KNOWLEDGE : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ KNOWLEDGE_FILE : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ TOOL : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ MCP_SERVER : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ WORKSPACE_SESSION : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT ||--o{ DIALOG : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT ||--o{ MESSAGE_DOWN : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT ||--o{ MESSAGE_LIKE : &quot;1:N&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KNOWLEDGE ||--o{ KNOWLEDGE_FILE : &quot;1:N&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py" target="_blank" rel="noreferrer">user.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py" target="_blank" rel="noreferrer">agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py" target="_blank" rel="noreferrer">dialog.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/message.py" target="_blank" rel="noreferrer">message.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge.py" target="_blank" rel="noreferrer">knowledge.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge_file.py" target="_blank" rel="noreferrer">knowledge_file.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/tool.py" target="_blank" rel="noreferrer">tool.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/workspace_session.py" target="_blank" rel="noreferrer">workspace_session.py</a></li></ul><h2 id="orm映射与序列化机制" tabindex="-1">ORM映射与序列化机制 <a class="header-anchor" href="#orm映射与序列化机制" aria-label="Permalink to &quot;ORM映射与序列化机制&quot;">​</a></h2><h3 id="sqlmodelserializable基类" tabindex="-1">SQLModelSerializable基类 <a class="header-anchor" href="#sqlmodelserializable基类" aria-label="Permalink to &quot;SQLModelSerializable基类&quot;">​</a></h3><p>所有模型均继承自<code>SQLModelSerializable</code>基类，该类提供了统一的序列化行为。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SQLModelSerializable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SQLModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model_config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ConfigDict(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">from_attributes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    hide_fields: ClassVar[list[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> to_dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.model_dump(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">exclude</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.hide_fields)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> column </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> getattr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, column)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isinstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value, datetime):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value.isoformat()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            result[column] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>关键特性：</strong></p><ul><li><code>model_config</code>: 启用<code>from_attributes=True</code>，支持从ORM对象直接创建模型实例</li><li><code>hide_fields</code>: 类变量，定义需要在序列化时隐藏的敏感字段</li><li><code>to_dict()</code>: 自定义序列化方法，自动排除<code>hide_fields</code>中的字段，并将<code>datetime</code>对象转换为ISO格式字符串</li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/base.py#L28-L43" target="_blank" rel="noreferrer">base.py</a></li></ul><h3 id="敏感信息过滤机制" tabindex="-1">敏感信息过滤机制 <a class="header-anchor" href="#敏感信息过滤机制" aria-label="Permalink to &quot;敏感信息过滤机制&quot;">​</a></h3><p>系统通过<code>hide_fields</code>字段实现敏感信息过滤。虽然在当前代码中该字段为空，但设计上支持在子类中定义需要隐藏的字段。</p><p><strong>实现方式：</strong></p><ol><li>在<code>to_dict()</code>方法中调用<code>model_dump(exclude=self.hide_fields)</code></li><li>动态排除<code>hide_fields</code>列表中的所有字段</li><li>特殊类型（如<code>datetime</code>）进行格式化处理</li></ol><p><strong>潜在应用：</strong></p><ul><li>在<code>UserTable</code>中设置<code>hide_fields = [&quot;user_password&quot;]</code></li><li>在<code>MCPServerTable</code>中设置<code>hide_fields = [&quot;config&quot;]</code></li><li>在<code>AgentTable</code>中设置<code>hide_fields = [&quot;system_prompt&quot;]</code></li></ul><h2 id="查询性能优化建议" tabindex="-1">查询性能优化建议 <a class="header-anchor" href="#查询性能优化建议" aria-label="Permalink to &quot;查询性能优化建议&quot;">​</a></h2><h3 id="索引策略" tabindex="-1">索引策略 <a class="header-anchor" href="#索引策略" aria-label="Permalink to &quot;索引策略&quot;">​</a></h3><p>根据当前模型定义和业务查询模式，建议以下索引优化：</p><p><strong>现有索引：</strong></p><ul><li><code>user.user_name</code>: 唯一索引，用于用户登录验证</li><li><code>agent.user_id</code>: 普通索引，用于查询用户的所有Agent</li><li><code>knowledge.name</code>: 唯一索引，确保知识库名称唯一</li><li><code>knowledge.user_id</code>: 普通索引，用于查询用户的知识库</li><li><code>knowledge_file.file_name</code>: 普通索引，用于文件名搜索</li><li><code>knowledge_file.knowledge_id</code>: 普通索引，用于查询知识库的文件</li><li><code>knowledge_file.user_id</code>: 普通索引，用于查询用户的文件</li></ul><p><strong>建议新增索引：</strong></p><ul><li><code>dialog.user_id</code>: 添加索引，优化用户对话列表查询</li><li><code>dialog.agent_id</code>: 添加索引，优化Agent对话统计</li><li><code>workspace_session.user_id</code>: 添加索引，优化用户工作区会话查询</li><li><code>message_down.create_time</code>: 添加索引，优化按时间查询消息</li><li><code>message_like.create_time</code>: 添加索引，优化按时间查询消息</li></ul><h3 id="数据分区建议" tabindex="-1">数据分区建议 <a class="header-anchor" href="#数据分区建议" aria-label="Permalink to &quot;数据分区建议&quot;">​</a></h3><p>对于高增长的表，建议实施数据分区策略：</p><p><strong>按时间分区：</strong></p><ul><li><code>message_down</code> 和 <code>message_like</code> 表：按月分区</li><li><code>dialog</code> 表：按周分区</li><li><code>workspace_session</code> 表：按月分区</li></ul><p><strong>分区键选择：</strong></p><ul><li>使用<code>create_time</code>作为分区键</li><li>分区粒度根据数据量和查询模式确定</li></ul><h3 id="json字段查询优化" tabindex="-1">JSON字段查询优化 <a class="header-anchor" href="#json字段查询优化" aria-label="Permalink to &quot;JSON字段查询优化&quot;">​</a></h3><p>对于存储JSON数据的字段（<code>mcp_ids</code>, <code>tool_ids</code>, <code>knowledge_ids</code>, <code>contexts</code>, <code>config</code>, <code>tools</code>, <code>params</code>），建议：</p><ol><li><strong>避免全表扫描：</strong> 在查询JSON字段时，结合其他索引字段使用</li><li><strong>使用JSON索引：</strong> 在支持的数据库中为常用查询路径创建GIN索引</li><li><strong>限制JSON大小：</strong> 设置合理的JSON字段大小限制，避免过大对象影响性能</li></ol><h3 id="查询模式优化" tabindex="-1">查询模式优化 <a class="header-anchor" href="#查询模式优化" aria-label="Permalink to &quot;查询模式优化&quot;">​</a></h3><p><strong>常见查询场景优化：</strong></p><ol><li><strong>用户相关查询：</strong> 确保所有<code>user_id</code>字段都有索引</li><li><strong>最近活动查询：</strong> 为<code>create_time</code>和<code>update_time</code>字段创建索引</li><li><strong>列表查询：</strong> 使用分页和适当的ORDER BY子句</li><li><strong>关联查询：</strong> 避免N+1查询问题，使用JOIN或批量查询</li></ol><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>本数据模型设计合理，覆盖了智能对话系统的核心功能需求。通过SQLModel实现了清晰的ORM映射，<code>SQLModelSerializable</code>基类提供了统一的序列化机制。模型间关系明确，支持用户与Agent的1:N关系、知识库与知识文件的1:N关系等业务需求。</p><p>建议在后续开发中：</p><ol><li>完善<code>hide_fields</code>机制，保护敏感信息</li><li>优化索引策略，提升查询性能</li><li>考虑大数据量下的分区策略</li><li>规范JSON字段的使用和查询</li></ol><p>整体架构具备良好的扩展性和维护性，为系统的稳定运行提供了坚实的数据基础。</p>`,130)])])}const E=a(l,[["render",t]]);export{k as __pageData,E as default};
