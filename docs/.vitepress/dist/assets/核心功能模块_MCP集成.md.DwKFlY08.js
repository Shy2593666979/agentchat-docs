import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.D0TaUBpX.js";const o=JSON.parse('{"title":"MCP集成","description":"","frontmatter":{},"headers":[],"relativePath":"核心功能模块/MCP集成.md","filePath":"核心功能模块/MCP集成.md","lastUpdated":1764244560000}'),l={name:"核心功能模块/MCP集成.md"};function p(t,s,r,h,c,E){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="mcp集成" tabindex="-1">MCP集成 <a class="header-anchor" href="#mcp集成" aria-label="Permalink to &quot;MCP集成&quot;">​</a></h1><cite> **本文档引用的文件** - [mcp_server.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json) - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py) - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_server.py) - [mcp_manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py) - [mcp_client.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py) - [multi_client.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py) - [tools.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/load_mcp/tools.py) - [prompts.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/load_mcp/prompts.py) - [sessions.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/sessions.py) - [mcp.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/mcp.py) - [mcp-server.vue](https://github.com/Shy2593666979/AgentChat/src/frontend/src/pages/mcp-server/mcp-server.vue) - [mcp_arxiv.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/arxiv/mcp_arxiv.py) - [main.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#引言">引言</a></li><li><a href="#mcp协议与系统定位">MCP协议与系统定位</a></li><li><a href="#mcp服务器配置与管理">MCP服务器配置与管理</a></li><li><a href="#mcp服务器启动流程">MCP服务器启动流程</a></li><li><a href="#mcp工具调用链路">MCP工具调用链路</a></li><li><a href="#前端界面集成">前端界面集成</a></li><li><a href="#故障诊断与优化策略">故障诊断与优化策略</a></li><li><a href="#结论">结论</a></li></ol><h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>MCP（Modular Cognitive Platform）集成是本系统的核心扩展机制，它作为连接外部服务的标准接口，允许系统通过标准化协议集成各种第三方服务和工具。本文档将深入解析MCP集成的设计原理与实现细节，涵盖从配置管理、服务器启动、工具调用到前端集成的完整流程，并提供故障诊断和优化建议。</p><h2 id="mcp协议与系统定位" tabindex="-1">MCP协议与系统定位 <a class="header-anchor" href="#mcp协议与系统定位" aria-label="Permalink to &quot;MCP协议与系统定位&quot;">​</a></h2><p>MCP协议是一种模块化认知平台协议，旨在为智能体系统提供一种标准化的方式来集成和调用外部服务。在本系统中，MCP扮演着连接器的角色，作为主系统与外部服务之间的桥梁。通过MCP协议，系统可以动态地发现、连接和调用各种外部工具和服务，从而极大地扩展了智能体的能力范围。</p><p>MCP协议支持多种传输方式，包括SSE（Server-Sent Events）、stdio、WebSocket和streamable HTTP，这使得它可以适应不同类型的外部服务。系统通过MCP协议实现了服务的即插即用，开发者可以轻松地将新的服务集成到系统中，而无需修改核心代码。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json#L1-L40" target="_blank" rel="noreferrer">mcp_server.json</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/mcp.py#L1-L46" target="_blank" rel="noreferrer">mcp.py</a></li></ul><h2 id="mcp服务器配置与管理" tabindex="-1">MCP服务器配置与管理 <a class="header-anchor" href="#mcp服务器配置与管理" aria-label="Permalink to &quot;MCP服务器配置与管理&quot;">​</a></h2><h3 id="配置文件结构" tabindex="-1">配置文件结构 <a class="header-anchor" href="#配置文件结构" aria-label="Permalink to &quot;配置文件结构&quot;">​</a></h3><p>MCP服务器的配置主要通过<code>mcp_server.json</code>文件进行管理。该文件是一个JSON数组，每个元素代表一个MCP服务器的配置。配置项包括：</p><ul><li><strong>server_name</strong>: 服务器名称</li><li><strong>url</strong>: 服务器地址</li><li><strong>type</strong>: 连接方式（SSE、Websocket等）</li><li><strong>config</strong>: 服务器配置信息</li><li><strong>params</strong>: 工具参数</li><li><strong>config_enabled</strong>: 是否需要配置</li><li><strong>logo_url</strong>: 服务器LOGO地址</li></ul><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;server_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;高德地图&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://mcp.api-inference.modelscope.net/77df8a09751e4c/sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;config&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {},</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;params&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {},</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;config_enabled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;logo_url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://agentchat.oss-cn-beijing.aliyuncs.com/icons/mcp/map.png&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="动态加载机制" tabindex="-1">动态加载机制 <a class="header-anchor" href="#动态加载机制" aria-label="Permalink to &quot;动态加载机制&quot;">​</a></h3><p>系统通过<code>MultiServerMCPClient</code>类实现MCP服务器的动态加载。该类支持在运行时添加和管理多个MCP服务器连接。通过<code>connections</code>字典，系统可以映射服务器名称到连接配置，实现灵活的服务器管理。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MultiServerMCPClient {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+connections : dict[str, Connection]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(connections : dict[str, Connection] | None)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session(server_name : str, auto_initialize : bool = True) AsyncIterator[ClientSession]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_tools(server_name : str | None = None) list[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_prompt(server_name : str, prompt_name : str, arguments : dict[str, Any] | None = None) list[HumanMessage | AIMessage]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_resources(server_name : str, uris : str | list[str] | None = None) list[Blob]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class Connection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&lt;interface&gt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StdioConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : Literal[&quot;stdio&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+command : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+args : list[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+env : dict[str, str] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+cwd : str | Path | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+encoding : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+encoding_error_handler : EncodingErrorHandler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs : dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class SSEConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : Literal[&quot;sse&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+headers : dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+timeout : float</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+sse_read_timeout : float</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs : dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+httpx_client_factory : McpHttpClientFactory | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+auth : httpx.Auth | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StreamableHttpConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : Literal[&quot;streamable_http&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+headers : dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+timeout : timedelta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+sse_read_timeout : timedelta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+terminate_on_close : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs : dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+httpx_client_factory : McpHttpClientFactory | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+auth : httpx.Auth | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class WebsocketConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : Literal[&quot;websocket&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs : dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiServerMCPClient --&gt; Connection : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StdioConnection --|&gt; Connection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SSEConnection --|&gt; Connection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StreamableHttpConnection --|&gt; Connection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WebsocketConnection --|&gt; Connection</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py#L42-L226" target="_blank" rel="noreferrer">multi_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/sessions.py#L60-L177" target="_blank" rel="noreferrer">sessions.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json#L1-L40" target="_blank" rel="noreferrer">mcp_server.json</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py#L42-L226" target="_blank" rel="noreferrer">multi_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/sessions.py#L60-L177" target="_blank" rel="noreferrer">sessions.py</a></li></ul><h2 id="mcp服务器启动流程" tabindex="-1">MCP服务器启动流程 <a class="header-anchor" href="#mcp服务器启动流程" aria-label="Permalink to &quot;MCP服务器启动流程&quot;">​</a></h2><h3 id="lark-mcp服务器" tabindex="-1">lark_mcp服务器 <a class="header-anchor" href="#lark-mcp服务器" aria-label="Permalink to &quot;lark_mcp服务器&quot;">​</a></h3><p>lark_mcp服务器的启动流程通过<code>main.py</code>文件定义。服务器使用Starlette框架创建Web应用，并通过FastMCP库注册MCP服务。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Main as main.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCP as FastMCP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Starlette as Starlette</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Server as MCP Server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Main-&gt;&gt;MCP : 初始化FastMCP(&quot;Lark MCP Server&quot;)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Main-&gt;&gt;MCP : register_mcp_server(mcp)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Main-&gt;&gt;Starlette : 创建Starlette应用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Starlette-&gt;&gt;Starlette : 添加健康检查路由</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Starlette-&gt;&gt;Starlette : 添加MCP SSE路由</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Main-&gt;&gt;Server : 解析命令行参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Server-&gt;&gt;Server : mcp.run(transport=args.transport)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py#L1-L31" target="_blank" rel="noreferrer">main.py</a></li></ul><h3 id="arxiv服务器" tabindex="-1">arxiv服务器 <a class="header-anchor" href="#arxiv服务器" aria-label="Permalink to &quot;arxiv服务器&quot;">​</a></h3><p>arxiv服务器的实现更为简洁，直接使用FastMCP装饰器定义工具函数。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Arxiv as mcp_arxiv.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant FastMCP as FastMCP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant ArxivAPI as ArxivAPIWrapper</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Arxiv-&gt;&gt;ArxivAPI : 初始化arxiv_wrapper</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Arxiv-&gt;&gt;FastMCP : 初始化mcp = FastMCP(&quot;MCP-Arxiv&quot;)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FastMCP-&gt;&gt;Arxiv : @mcp.tool()装饰get_arxiv函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Arxiv-&gt;&gt;Arxiv : 定义get_arxiv(query : str)函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Arxiv-&gt;&gt;ArxivAPI : 调用arxiv_wrapper.run(query)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Arxiv-&gt;&gt;FastMCP : 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Arxiv-&gt;&gt;FastMCP : mcp.run(transport=&#39;stdio&#39;)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/arxiv/mcp_arxiv.py#L1-L19" target="_blank" rel="noreferrer">mcp_arxiv.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py#L1-L31" target="_blank" rel="noreferrer">main.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/arxiv/mcp_arxiv.py#L1-L19" target="_blank" rel="noreferrer">mcp_arxiv.py</a></li></ul><h2 id="mcp工具调用链路" tabindex="-1">MCP工具调用链路 <a class="header-anchor" href="#mcp工具调用链路" aria-label="Permalink to &quot;MCP工具调用链路&quot;">​</a></h2><h3 id="工具调用完整链路" tabindex="-1">工具调用完整链路 <a class="header-anchor" href="#工具调用完整链路" aria-label="Permalink to &quot;工具调用完整链路&quot;">​</a></h3><p>MCP工具调用的完整链路从Agent决策开始，经过mcp_client发送请求，最终在远程MCP服务器执行并返回结果。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Agent as Agent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCPManager as MCPManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCPClient as MCPClient</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant RemoteServer as 远程MCP服务器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;MCPManager : 决策调用工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPClient : enter_mcp_server(server_path, server_env)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;RemoteServer : connect_to_server(mcp_server, server_env)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;RemoteServer : list_server_tools()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RemoteServer--&gt;&gt;MCPClient : 返回工具列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPManager : list_all_server_tools()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPManager : process_query(messages)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;RemoteServer : _chat_model(messages, available_tools)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RemoteServer--&gt;&gt;MCPManager : 返回响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPManager : 处理工具调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;RemoteServer : _get_tool_response(tool_name, tool_args)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RemoteServer--&gt;&gt;MCPManager : 返回工具执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager--&gt;&gt;Agent : 返回最终结果</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py#L13-L118" target="_blank" rel="noreferrer">mcp_manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py#L10-L53" target="_blank" rel="noreferrer">mcp_client.py</a></li></ul><h3 id="工具转换机制" tabindex="-1">工具转换机制 <a class="header-anchor" href="#工具转换机制" aria-label="Permalink to &quot;工具转换机制&quot;">​</a></h3><p>系统通过<code>load_mcp_tools</code>函数将MCP工具转换为LangChain工具，实现工具的标准化。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始]) --&gt; ListTools[&quot;调用_list_all_tools(session)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ListTools --&gt; CheckSession{&quot;session是否存在?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckSession --&gt; |是| CallListTools[&quot;调用session.list_tools()&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckSession --&gt; |否| CreateSession[&quot;创建新session&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CreateSession --&gt; Initialize[&quot;初始化session&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Initialize --&gt; CallListTools</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CallListTools --&gt; GetTools[&quot;获取工具列表&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GetTools --&gt; ConvertLoop[&quot;遍历工具列表&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ConvertLoop --&gt; ConvertTool[&quot;调用convert_mcp_tool_to_langchain_tool()&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ConvertTool --&gt; CreateStructuredTool[&quot;创建StructuredTool&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CreateStructuredTool --&gt; AddToResult[&quot;添加到结果列表&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AddToResult --&gt; MoreTools{&quot;还有更多工具?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MoreTools --&gt; |是| ConvertLoop</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MoreTools --&gt; |否| ReturnResult[&quot;返回LangChain工具列表&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnResult --&gt; End([结束])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/load_mcp/tools.py#L149-L182" target="_blank" rel="noreferrer">tools.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py#L13-L118" target="_blank" rel="noreferrer">mcp_manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py#L10-L53" target="_blank" rel="noreferrer">mcp_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/load_mcp/tools.py#L149-L182" target="_blank" rel="noreferrer">tools.py</a></li></ul><h2 id="前端界面集成" tabindex="-1">前端界面集成 <a class="header-anchor" href="#前端界面集成" aria-label="Permalink to &quot;前端界面集成&quot;">​</a></h2><h3 id="用户界面功能" tabindex="-1">用户界面功能 <a class="header-anchor" href="#用户界面功能" aria-label="Permalink to &quot;用户界面功能&quot;">​</a></h3><p>前端通过<code>mcp-server.vue</code>组件提供MCP服务的管理界面，用户可以查看、启用和配置MCP服务。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPServerPage {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+servers : MCPServer[]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+loading : boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+dialogVisible : boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+toolsDialogVisible : boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+configDialogVisible : boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+formLoading : boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+editingServer : MCPServer | null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+configuringServer : MCPServer | null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+selectedServerTools : MCPServerTool[]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+selectedServerName : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+jsonEditor : IStandaloneCodeEditor | null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+configStatus : {valid : boolean, message : string}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+formData : CreateMCPServerRequest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+userConfigData : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+formErrors : Record&lt;string, string&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+fetchServers() : Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleCreate() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleEdit(server : MCPServer) : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+closeDialog() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleSubmit() : Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+updateUserConfig() : Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleDelete(server : MCPServer) : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+viewTools(server : MCPServer) : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+closeToolsDialog() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleConfig(server : MCPServer) : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+initJsonEditor() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+validateJsonConfig() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+closeConfigDialog() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleConfigSubmit() : Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+insertExampleConfig() : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+handleImageError(event : Event) : void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+saveUserConfig() : Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPServer {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_server_id : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_name : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+type : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+config : any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+params : any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+config_enabled : boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+logo_url : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_id : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_name : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_time : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPServerTool {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+name : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+description : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+inputSchema : any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class CreateMCPServerRequest {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_name : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+type : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+config : any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPUserConfigUpdateRequest {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_id : string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+config : any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPServerPage --&gt; MCPServer : &quot;管理&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPServerPage --&gt; MCPServerTool : &quot;显示&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPServerPage --&gt; CreateMCPServerRequest : &quot;创建&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPServerPage --&gt; MCPUserConfigUpdateRequest : &quot;更新配置&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/frontend/src/pages/mcp-server/mcp-server.vue#L1-L800" target="_blank" rel="noreferrer">mcp-server.vue</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/frontend/src/pages/mcp-server/mcp-server.vue#L1-L800" target="_blank" rel="noreferrer">mcp-server.vue</a></li></ul><h2 id="故障诊断与优化策略" tabindex="-1">故障诊断与优化策略 <a class="header-anchor" href="#故障诊断与优化策略" aria-label="Permalink to &quot;故障诊断与优化策略&quot;">​</a></h2><h3 id="常见问题诊断" tabindex="-1">常见问题诊断 <a class="header-anchor" href="#常见问题诊断" aria-label="Permalink to &quot;常见问题诊断&quot;">​</a></h3><h4 id="mcp连接失败" tabindex="-1">MCP连接失败 <a class="header-anchor" href="#mcp连接失败" aria-label="Permalink to &quot;MCP连接失败&quot;">​</a></h4><p>当MCP连接失败时，可能的原因包括：</p><ul><li>服务器地址错误</li><li>网络连接问题</li><li>认证信息错误</li><li>服务器未启动</li></ul><p>诊断方法：</p><ol><li>检查服务器URL是否正确</li><li>使用健康检查接口验证服务器状态</li><li>检查网络连接和防火墙设置</li><li>验证认证信息是否正确</li></ol><h4 id="响应超时" tabindex="-1">响应超时 <a class="header-anchor" href="#响应超时" aria-label="Permalink to &quot;响应超时&quot;">​</a></h4><p>响应超时可能由以下原因引起：</p><ul><li>服务器处理时间过长</li><li>网络延迟过高</li><li>客户端超时设置过短</li></ul><p>解决方案：</p><ul><li>增加客户端超时设置</li><li>优化服务器性能</li><li>使用异步处理机制</li></ul><h3 id="优化策略" tabindex="-1">优化策略 <a class="header-anchor" href="#优化策略" aria-label="Permalink to &quot;优化策略&quot;">​</a></h3><h4 id="服务发现" tabindex="-1">服务发现 <a class="header-anchor" href="#服务发现" aria-label="Permalink to &quot;服务发现&quot;">​</a></h4><p>实现动态服务发现机制，通过服务注册中心自动发现可用的MCP服务器，减少手动配置。</p><h4 id="负载均衡" tabindex="-1">负载均衡 <a class="header-anchor" href="#负载均衡" aria-label="Permalink to &quot;负载均衡&quot;">​</a></h4><p>对于高可用性要求的场景，可以实现负载均衡策略，将请求分发到多个相同的MCP服务器实例。</p><h4 id="容错处理" tabindex="-1">容错处理 <a class="header-anchor" href="#容错处理" aria-label="Permalink to &quot;容错处理&quot;">​</a></h4><p>实现容错处理机制，包括：</p><ul><li>自动重试机制</li><li>降级策略</li><li>熔断机制</li><li>缓存机制</li></ul><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([请求开始]) --&gt; CheckCache{&quot;检查缓存?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckCache --&gt; |命中| ReturnCache[&quot;返回缓存结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckCache --&gt; |未命中| SendRequest[&quot;发送请求到MCP服务器&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SendRequest --&gt; CheckTimeout{&quot;超时?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckTimeout --&gt; |是| Retry{&quot;重试次数&lt;最大重试次数?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckTimeout --&gt; |否| ProcessResponse[&quot;处理响应&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Retry --&gt; |是| IncrementRetry[&quot;重试次数+1&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">IncrementRetry --&gt; SendRequest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Retry --&gt; |否| Fallback[&quot;执行降级策略&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Fallback --&gt; ReturnFallback[&quot;返回降级结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ProcessResponse --&gt; CheckError{&quot;响应错误?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckError --&gt; |是| Fallback</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckError --&gt; |否| UpdateCache[&quot;更新缓存&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UpdateCache --&gt; ReturnResult[&quot;返回结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnCache --&gt; End([结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnFallback --&gt; End</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnResult --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py#L67-L114" target="_blank" rel="noreferrer">mcp_manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py#L47-L48" target="_blank" rel="noreferrer">mcp_client.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py#L67-L114" target="_blank" rel="noreferrer">mcp_manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py#L47-L48" target="_blank" rel="noreferrer">mcp_client.py</a></li></ul><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>MCP集成通过标准化的协议和灵活的架构设计，为系统提供了强大的外部服务集成能力。从配置管理、服务器启动到工具调用，整个流程设计合理，易于扩展和维护。前端界面提供了友好的用户交互体验，使得MCP服务的管理变得简单直观。通过实施服务发现、负载均衡和容错处理等优化策略，可以进一步提升系统的稳定性和性能。</p>`,84)])])}const g=a(l,[["render",p]]);export{o as __pageData,g as default};
