import{_ as s,c as n,o as e,ag as r}from"./chunks/framework.7BqJGZTL.js";const k=JSON.parse('{"title":"RAG服务","description":"","frontmatter":{},"headers":[],"relativePath":"项目目录结构/后端目录结构/服务层/RAG服务.md","filePath":"项目目录结构/后端目录结构/服务层/RAG服务.md","lastUpdated":1764244560000}'),i={name:"项目目录结构/后端目录结构/服务层/RAG服务.md"};function t(l,a,p,h,c,g){return e(),n("div",null,[...a[0]||(a[0]=[r(`<h1 id="rag服务" tabindex="-1">RAG服务 <a class="header-anchor" href="#rag服务" aria-label="Permalink to &quot;RAG服务&quot;">​</a></h1><cite> **本文档引用的文件** - [rag_handler.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py) - [parser.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py) - [embedding.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/embedding.py) - [es_client.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/es_client.py) - [rerank.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/rerank.py) - [doc_parser/pdf.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/pdf.py) - [doc_parser/docx.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/docx.py) - [doc_parser/text.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/text.py) - [doc_parser/markdown.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/markdown.py) - [vector_db.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/milvus.py) - [retrieval.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/retrieval.py) - [chunk.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chunk.py) - [search.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/search.py) - [settings.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py) - [config.yaml](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#rag服务概述">RAG服务概述</a></li><li><a href="#核心工作流程">核心工作流程</a></li><li><a href="#文档解析与分块">文档解析与分块</a></li><li><a href="#向量化与嵌入模型">向量化与嵌入模型</a></li><li><a href="#elasticsearch语义搜索">Elasticsearch语义搜索</a></li><li><a href="#文档重排序机制">文档重排序机制</a></li><li><a href="#知识库增强回答链路">知识库增强回答链路</a></li><li><a href="#rag优化建议">RAG优化建议</a></li></ol><h2 id="rag服务概述" tabindex="-1">RAG服务概述 <a class="header-anchor" href="#rag服务概述" aria-label="Permalink to &quot;RAG服务概述&quot;">​</a></h2><p>RAG（Retrieval-Augmented Generation）服务是AgentChat系统中的核心组件，负责将外部知识库与大语言模型相结合，实现基于知识库的增强式问答。该服务通过协调文档解析、向量化、检索与重排序等环节，为用户提供准确、可靠的回答。系统采用混合检索策略，结合Elasticsearch的关键词搜索和Milvus的向量语义搜索，通过重排序算法提升检索结果的相关性。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py#L1-L152" target="_blank" rel="noreferrer">rag_handler.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L1-L50" target="_blank" rel="noreferrer">config.yaml</a></li></ul><h2 id="核心工作流程" tabindex="-1">核心工作流程 <a class="header-anchor" href="#核心工作流程" aria-label="Permalink to &quot;核心工作流程&quot;">​</a></h2><p>RAG服务的核心工作流程由<code>rag_handler.py</code>中的<code>RagHandler</code>类协调完成，主要包含查询重写、文档检索、重排序和结果拼接四个阶段。当用户发起查询时，系统首先通过查询重写模块生成多个相关查询，然后并行从Elasticsearch和Milvus中检索文档，对检索结果进行合并去重后，交由重排序模型进行相关性评分，最终返回最相关的文档内容。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant User as &quot;用户&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant RagHandler as &quot;RagHandler&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant QueryRewriter as &quot;查询重写器&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant ES as &quot;Elasticsearch&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Milvus as &quot;Milvus&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Reranker as &quot;重排序器&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User-&gt;&gt;RagHandler : 发起查询</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;QueryRewriter : 执行查询重写</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">QueryRewriter--&gt;&gt;RagHandler : 返回重写后的查询列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;ES : 执行关键词检索</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;Milvus : 执行向量检索</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ES--&gt;&gt;RagHandler : 返回检索结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Milvus--&gt;&gt;RagHandler : 返回检索结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;RagHandler : 合并并去重结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;Reranker : 执行重排序</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Reranker--&gt;&gt;RagHandler : 返回重排序结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;User : 返回最终答案</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>**Diagram sources **</p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py#L12-L148" target="_blank" rel="noreferrer">rag_handler.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/retrieval.py#L5-L46" target="_blank" rel="noreferrer">retrieval.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py#L12-L148" target="_blank" rel="noreferrer">rag_handler.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/retrieval.py#L5-L46" target="_blank" rel="noreferrer">retrieval.py</a></li></ul><h2 id="文档解析与分块" tabindex="-1">文档解析与分块 <a class="header-anchor" href="#文档解析与分块" aria-label="Permalink to &quot;文档解析与分块&quot;">​</a></h2><p>文档解析与分块是RAG服务的基础环节，由<code>parser.py</code>中的<code>DocParser</code>类负责协调。系统支持多种文档格式的解析，包括PDF、DOCX、PPTX、Excel、Markdown和Text等。对于不同格式的文档，系统采用相应的解析策略，最终都将文档转换为统一的文本格式进行处理。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[原始文档] --&gt; B{文档类型}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |PDF| C[pdf_parser]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |DOCX| D[docx_parser]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |Markdown| E[markdown_parser]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |Text| F[text_parser]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; G[转换为Markdown]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; H[转换为PDF]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; I[文本分块]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J[生成文档块]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>**Diagram sources **</p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L13-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/pdf.py#L18-L80" target="_blank" rel="noreferrer">doc_parser/pdf.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/docx.py#L5-L17" target="_blank" rel="noreferrer">doc_parser/docx.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/markdown.py#L8-L252" target="_blank" rel="noreferrer">doc_parser/markdown.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/text.py#L8-L86" target="_blank" rel="noreferrer">doc_parser/text.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L13-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/pdf.py#L18-L80" target="_blank" rel="noreferrer">doc_parser/pdf.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/docx.py#L5-L17" target="_blank" rel="noreferrer">doc_parser/docx.py</a></li></ul><h3 id="pdf文档解析" tabindex="-1">PDF文档解析 <a class="header-anchor" href="#pdf文档解析" aria-label="Permalink to &quot;PDF文档解析&quot;">​</a></h3><p>PDF文档解析采用<code>pymupdf4llm</code>库将PDF转换为Markdown格式，同时提取文档中的图片并上传至阿里云OSS。在转换过程中，系统会保持文档的原始布局和格式，确保转换后的Markdown文件能够准确反映原始PDF的内容结构。转换完成后，系统会调用<code>markdown_parser</code>对Markdown文件进行进一步的分块处理。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/pdf.py#L18-L80" target="_blank" rel="noreferrer">doc_parser/pdf.py</a></li></ul><h3 id="docx文档解析" tabindex="-1">DOCX文档解析 <a class="header-anchor" href="#docx文档解析" aria-label="Permalink to &quot;DOCX文档解析&quot;">​</a></h3><p>DOCX文档解析通过先将文档转换为PDF格式，然后复用PDF解析流程来实现。这种设计避免了重复开发文档解析逻辑，提高了代码的复用性。系统调用<code>convert_to_pdf</code>函数将DOCX文件转换为PDF，然后交由<code>pdf_parser</code>进行后续处理。这种方式确保了不同格式文档在处理流程上的一致性。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/docx.py#L5-L17" target="_blank" rel="noreferrer">doc_parser/docx.py</a></li></ul><h3 id="文本与markdown分块" tabindex="-1">文本与Markdown分块 <a class="header-anchor" href="#文本与markdown分块" aria-label="Permalink to &quot;文本与Markdown分块&quot;">​</a></h3><p>文本和Markdown文档的分块策略有所不同。对于纯文本文件，系统采用基于换行符的分块方法，确保每个块的大小不超过配置的<code>chunk_size</code>，同时保留<code>overlap_size</code>的重叠部分以维持上下文连贯性。对于Markdown文件，系统会解析文档的标题结构，将每个标题下的内容作为一个逻辑单元进行分块，并在每个块中包含完整的标题路径，以保持文档的层次结构信息。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/text.py#L8-L86" target="_blank" rel="noreferrer">doc_parser/text.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/markdown.py#L8-L252" target="_blank" rel="noreferrer">doc_parser/markdown.py</a></li></ul><h2 id="向量化与嵌入模型" tabindex="-1">向量化与嵌入模型 <a class="header-anchor" href="#向量化与嵌入模型" aria-label="Permalink to &quot;向量化与嵌入模型&quot;">​</a></h2><p>向量化是将文本内容转换为高维向量表示的过程，由<code>embedding.py</code>中的<code>get_embedding</code>函数实现。系统通过调用配置的嵌入模型API，将文档块和用户查询转换为向量，以便在向量数据库中进行相似性搜索。为了提高处理效率，系统对批量查询进行了优化，采用并发处理和批量请求的方式，有效降低了API调用的延迟。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[文本内容] --&gt; B[嵌入模型API]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C{请求大小}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; |单个或少量| D[直接请求]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; |大量| E[分批处理]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[创建信号量]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[并发处理批次]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; H[合并结果]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; I[返回向量]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J[向量表示]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>**Diagram sources **</p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/embedding.py#L11-L43" target="_blank" rel="noreferrer">embedding.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/embedding.py#L11-L43" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L1-L50" target="_blank" rel="noreferrer">config.yaml</a></li></ul><h2 id="elasticsearch语义搜索" tabindex="-1">Elasticsearch语义搜索 <a class="header-anchor" href="#elasticsearch语义搜索" aria-label="Permalink to &quot;Elasticsearch语义搜索&quot;">​</a></h2><p>Elasticsearch集成通过<code>es_client.py</code>中的<code>ESClient</code>类实现，为系统提供高效的关键词搜索能力。当启用Elasticsearch时，系统会同时在Elasticsearch和Milvus中执行检索，然后合并结果。Elasticsearch主要用于精确匹配和关键词搜索，而Milvus则负责语义相似性搜索，两者结合可以提供更全面的检索结果。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class ESClient {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+client Elasticsearch</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+insert_documents(index_name, chunks)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+index_documents(index_name, chunks)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+search_documents(query, index_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+search_documents_summary(query, index_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+delete_documents(file_id, index_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+close()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class ChunkModel {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+chunk_id str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+content str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+file_id str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+file_name str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+knowledge_id str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+summary str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+to_dict() dict</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class SearchModel {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+chunk_id str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+content str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+score float</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+file_id str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+file_name str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+knowledge_id str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+summary str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+to_dict() dict</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ESClient --&gt; ChunkModel : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ESClient --&gt; SearchModel : &quot;返回&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>**Diagram sources **</p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/es_client.py#L12-L199" target="_blank" rel="noreferrer">es_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chunk.py#L1-L20" target="_blank" rel="noreferrer">chunk.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/search.py#L2-L23" target="_blank" rel="noreferrer">search.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/es_client.py#L12-L199" target="_blank" rel="noreferrer">es_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chunk.py#L1-L20" target="_blank" rel="noreferrer">chunk.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/search.py#L2-L23" target="_blank" rel="noreferrer">search.py</a></li></ul><h2 id="文档重排序机制" tabindex="-1">文档重排序机制 <a class="header-anchor" href="#文档重排序机制" aria-label="Permalink to &quot;文档重排序机制&quot;">​</a></h2><p>文档重排序是提升检索结果质量的关键环节，由<code>rerank.py</code>中的<code>Reranker</code>类实现。系统将初步检索到的文档列表与原始查询一起发送给重排序模型，模型会为每个文档计算一个相关性分数。重排序模型能够更准确地理解查询与文档之间的语义关系，从而对检索结果进行重新排序，确保最相关的文档排在前面。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant RagHandler as &quot;RagHandler&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Reranker as &quot;Reranker&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant RerankModel as &quot;重排序模型&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RagHandler-&gt;&gt;Reranker : rerank_documents(query, documents)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Reranker-&gt;&gt;RerankModel : request_rerank(query, documents)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RerankModel--&gt;&gt;Reranker : 返回重排序结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Reranker-&gt;&gt;RagHandler : 返回重排序后的文档列表</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>**Diagram sources **</p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/rerank.py#L9-L52" target="_blank" rel="noreferrer">rerank.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/rerank.py#L9-L52" target="_blank" rel="noreferrer">rerank.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L1-L50" target="_blank" rel="noreferrer">config.yaml</a></li></ul><h2 id="知识库增强回答链路" tabindex="-1">知识库增强回答链路 <a class="header-anchor" href="#知识库增强回答链路" aria-label="Permalink to &quot;知识库增强回答链路&quot;">​</a></h2><p>知识库增强回答的完整链路展示了从用户提问到生成答案的全过程。当用户提出问题时，系统首先通过查询重写生成多个相关查询，然后在知识库中检索相关信息，对检索结果进行重排序后，将最相关的内容作为上下文提供给大语言模型，最终生成基于知识库的准确回答。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[用户提问] --&gt; B[查询重写]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[混合检索]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[结果合并与去重]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; E[文档重排序]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[结果过滤]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[生成最终答案]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; H[返回给用户]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>**Diagram sources **</p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py#L54-L145" target="_blank" rel="noreferrer">rag_handler.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/retrieval.py#L37-L46" target="_blank" rel="noreferrer">retrieval.py</a></li></ul><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py#L54-L145" target="_blank" rel="noreferrer">rag_handler.py</a></li></ul><h2 id="rag优化建议" tabindex="-1">RAG优化建议 <a class="header-anchor" href="#rag优化建议" aria-label="Permalink to &quot;RAG优化建议&quot;">​</a></h2><h3 id="分块策略优化" tabindex="-1">分块策略优化 <a class="header-anchor" href="#分块策略优化" aria-label="Permalink to &quot;分块策略优化&quot;">​</a></h3><p>合理的分块策略对RAG系统性能至关重要。对于技术文档和学术论文，建议采用较小的分块大小（256-512字符）以保持内容的精确性；对于小说和长篇文章，可以采用较大的分块大小（512-1024字符）以保持上下文连贯性。同时，应设置适当的重叠大小（128字符左右）以避免关键信息被切割。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/markdown.py#L9-L12" target="_blank" rel="noreferrer">doc_parser/markdown.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/text.py#L10-L11" target="_blank" rel="noreferrer">doc_parser/text.py</a></li></ul><h3 id="嵌入模型选择" tabindex="-1">嵌入模型选择 <a class="header-anchor" href="#嵌入模型选择" aria-label="Permalink to &quot;嵌入模型选择&quot;">​</a></h3><p>嵌入模型的选择直接影响检索质量。对于中文场景，应优先选择在中文语料上训练过的嵌入模型。同时，需要考虑模型的维度和性能平衡，过高的维度会增加存储和计算成本，而过低的维度可能无法充分表达语义信息。建议通过A/B测试选择最适合业务场景的嵌入模型。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/embedding.py#L7-L9" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L1-L50" target="_blank" rel="noreferrer">config.yaml</a></li></ul><h3 id="检索性能调优" tabindex="-1">检索性能调优 <a class="header-anchor" href="#检索性能调优" aria-label="Permalink to &quot;检索性能调优&quot;">​</a></h3><p>检索性能调优可以从多个方面入手。首先，合理配置Elasticsearch和Milvus的索引参数，如分片数、副本数等。其次，优化查询重写策略，避免生成过多无关的查询变体。最后，通过缓存机制减少重复查询的处理时间，特别是对于高频查询可以设置专门的缓存策略。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/es_client.py#L14-L19" target="_blank" rel="noreferrer">es_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py#L28-L34" target="_blank" rel="noreferrer">rag_handler.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L1-L50" target="_blank" rel="noreferrer">config.yaml</a></li></ul>`,75)])])}const o=s(i,[["render",t]]);export{k as __pageData,o as default};
