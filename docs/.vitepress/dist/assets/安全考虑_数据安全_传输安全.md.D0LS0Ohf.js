import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.D0TaUBpX.js";const E=JSON.parse('{"title":"传输安全","description":"","frontmatter":{},"headers":[],"relativePath":"安全考虑/数据安全/传输安全.md","filePath":"安全考虑/数据安全/传输安全.md","lastUpdated":1764244560000}'),l={name:"安全考虑/数据安全/传输安全.md"};function t(p,s,r,h,k,c){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="传输安全" tabindex="-1">传输安全 <a class="header-anchor" href="#传输安全" aria-label="Permalink to &quot;传输安全&quot;">​</a></h1><cite> **本文档引用的文件** - [nginx.conf](https://github.com/Shy2593666979/AgentChat/docker/nginx.conf) - [JWT.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/JWT.py) - [auth_jwt.py](https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py) - [config.py](https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/config.py) - [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml) - [config.yaml](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#引言">引言</a></li><li><a href="#nginx传输层安全配置">Nginx传输层安全配置</a></li><li><a href="#jwt令牌安全机制">JWT令牌安全机制</a></li><li><a href="#https与jwt协同安全策略">HTTPS与JWT协同安全策略</a></li><li><a href="#安全通信配置示例">安全通信配置示例</a></li><li><a href="#安全审计检查清单">安全审计检查清单</a></li></ol><h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>AgentChat系统通过Nginx反向代理和JWT令牌认证机制共同构建了完整的传输层安全体系。本系统采用Nginx作为前端反向代理服务器，负责处理所有客户端的HTTP/HTTPS请求，并通过JWT（JSON Web Token）实现用户身份认证和会话管理。尽管当前配置文件中未直接体现HTTPS强制重定向和SSL/TLS证书配置，但系统通过多层安全机制确保通信安全。本文将深入解析系统的传输层安全机制，包括Nginx的安全配置、JWT令牌的安全保障措施以及两者协同工作的安全策略。</p><h2 id="nginx传输层安全配置" tabindex="-1">Nginx传输层安全配置 <a class="header-anchor" href="#nginx传输层安全配置" aria-label="Permalink to &quot;Nginx传输层安全配置&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client[客户端] --&gt; Nginx[Nginx服务器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx --&gt; Backend[后端API服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;Nginx安全层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[HTTP监听 8090端口]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B[HTTP安全头设置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[静态资源缓存策略]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[隐藏服务器信息]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[禁止访问隐藏文件]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx --&gt; A</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx --&gt; B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx --&gt; C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx --&gt; D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx --&gt; E</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L1-L101" target="_blank" rel="noreferrer">nginx.conf</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L1-L101" target="_blank" rel="noreferrer">nginx.conf</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L101-L103" target="_blank" rel="noreferrer">docker-compose.yml</a></li></ul><p>AgentChat系统的Nginx配置实现了多层安全防护机制，确保前端通信的安全性。Nginx服务器监听8090端口处理所有前端请求，通过一系列安全配置保护系统免受常见Web攻击。</p><p>Nginx配置中包含了多项关键安全设置：通过<code>server_tokens off</code>指令隐藏服务器版本信息，防止攻击者利用已知漏洞；设置<code>X-Frame-Options DENY</code>防止点击劫持攻击；通过<code>X-Content-Type-Options nosniff</code>防止MIME类型嗅探攻击；配置<code>X-XSS-Protection &quot;1; mode=block&quot;</code>启用浏览器的XSS过滤功能。这些HTTP安全头的设置构成了第一道安全防线。</p><p>在文件访问控制方面，Nginx配置了<code>location ~ /\\.</code>规则，拒绝所有以点开头的隐藏文件访问，防止敏感配置文件（如.git、.env等）被意外暴露。同时，系统配置了健康检查端点<code>/health</code>，用于服务状态监控，该端点禁用了访问日志记录，减少日志文件的敏感信息暴露。</p><p>对于静态资源，Nginx实施了精细化的缓存策略：JavaScript、CSS、图片等静态资源设置1年的过期时间并标记为不可变，提高前端性能；而HTML文件则配置为不缓存，确保用户始终获取最新版本的应用程序。这种差异化的缓存策略在保证性能的同时，也确保了应用更新的及时性。</p><p>值得注意的是，当前Nginx配置仅监听HTTP端口8090，未配置HTTPS监听和HTTP到HTTPS的强制重定向。在生产环境中，建议补充SSL/TLS证书配置，启用HTTPS并设置HTTP到HTTPS的301重定向，以确保所有通信都通过加密通道进行。</p><h2 id="jwt令牌安全机制" tabindex="-1">JWT令牌安全机制 <a class="header-anchor" href="#jwt令牌安全机制" aria-label="Permalink to &quot;JWT令牌安全机制&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class AuthJWT {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_secret_key : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_algorithm : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_access_token_expires : timedelta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_refresh_token_expires : timedelta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_cookie_secure : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_cookie_csrf_protect : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_access_token(subject, fresh, algorithm, headers, expires_time, audience, user_claims) str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_refresh_token(subject, algorithm, headers, expires_time, audience, user_claims) str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+jwt_required(auth_from, token, websocket, csrf_token) None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+jwt_optional(auth_from, token, websocket, csrf_token) None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+jwt_refresh_token_required(auth_from, token, websocket, csrf_token) None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+fresh_jwt_required(auth_from, token, websocket, csrf_token) None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_create_token(subject, type_token, exp_time, fresh, algorithm, headers, issuer, audience, user_claims) str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_get_secret_key(algorithm, process) str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_verify_jwt_in_request(token, type_token, token_from, fresh) None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_verifying_token(encoded_token, issuer) None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_verified_token(encoded_token, issuer) Dict[str,Union[str,int,bool]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class Settings {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+authjwt_secret_key : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+authjwt_token_location : list</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+authjwt_cookie_csrf_protect : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AuthJWT &lt;|-- AuthConfig</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AuthConfig &lt;.. Settings : 使用配置</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L1-L849" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/config.py#L1-L85" target="_blank" rel="noreferrer">config.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/JWT.py#L1-L7" target="_blank" rel="noreferrer">JWT.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L1-L849" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/config.py#L1-L85" target="_blank" rel="noreferrer">config.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/JWT.py#L1-L7" target="_blank" rel="noreferrer">JWT.py</a></li></ul><p>AgentChat系统使用<code>fastapi-jwt-auth</code>库实现JWT令牌认证机制，通过多层安全措施保障令牌在传输过程中的安全性。JWT（JSON Web Token）是一种开放标准（RFC 7519），用于在各方之间安全地传输信息作为JSON对象。</p><p>系统采用HS256（HMAC SHA-256）作为默认的签名算法，这是一种对称加密算法，使用相同的密钥进行令牌的签名和验证。在<code>src/backend/fastapi_jwt_auth/config.py</code>文件中，<code>authjwt_algorithm</code>配置项默认设置为&quot;HS256&quot;，确保令牌的完整性和防篡改性。HS256算法通过密钥对令牌进行签名，任何对令牌内容的修改都会导致签名验证失败，从而防止令牌被篡改。</p><p>密钥管理是JWT安全的核心。系统通过<code>authjwt_secret_key</code>配置项管理签名密钥，在<code>src/backend/agentchat/api/JWT.py</code>文件中，该密钥默认设置为&#39;secret&#39;，但在生产环境中应通过环境变量或安全的密钥管理系统进行配置。在<code>docker-compose.yml</code>文件中，JWT密钥通过环境变量<code>JWT_SECRET_KEY</code>传递，其默认值为&quot;your-super-secret-jwt-key-change-in-production&quot;，明确提示在生产环境中必须更改此密钥。密钥的保密性至关重要，任何泄露都会导致整个认证系统的安全性崩溃。</p><p>令牌有效期控制是防止令牌长期暴露的关键机制。系统设置了合理的令牌过期时间：访问令牌（access token）默认有效期为15分钟，刷新令牌（refresh token）默认有效期为30天。这种短时效的访问令牌设计遵循了最小权限原则，即使令牌被截获，攻击者也只有很短的时间窗口可以利用。当访问令牌过期后，客户端可以使用刷新令牌获取新的访问令牌，而无需用户重新登录，平衡了安全性和用户体验。</p><p>为防止重放攻击，系统实现了多项防护策略。首先，每个令牌都包含唯一的JWT ID（jti）声明，通过<code>_get_jwt_identifier()</code>方法生成UUID，可用于实现令牌吊销机制。其次，系统支持CSRF（跨站请求伪造）保护，当<code>authjwt_cookie_csrf_protect</code>设置为True时，会在令牌中添加CSRF声明，并在Cookie中设置相应的CSRF令牌，防止跨站请求伪造攻击。此外，系统还支持令牌吊销列表（denylist），可通过<code>authjwt_denylist_enabled</code>配置启用，允许主动吊销已签发的令牌。</p><p>JWT在用户认证中的作用流程如下：用户登录成功后，服务器生成包含用户标识（subject）的访问令牌和刷新令牌，通过安全的HTTP Only Cookie返回给客户端；后续请求中，客户端在Cookie或Authorization头中携带访问令牌；服务器验证令牌的签名、有效期和声明，确认用户身份；当访问令牌过期时，客户端使用刷新令牌获取新的访问令牌；用户登出时，服务器将令牌加入吊销列表，确保令牌立即失效。</p><h2 id="https与jwt协同安全策略" tabindex="-1">HTTPS与JWT协同安全策略 <a class="header-anchor" href="#https与jwt协同安全策略" aria-label="Permalink to &quot;HTTPS与JWT协同安全策略&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as 客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Nginx as Nginx服务器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Backend as 后端服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Auth as JWT认证</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;Nginx : HTTP请求 (端口8090)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx-&gt;&gt;Backend : 转发请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Backend-&gt;&gt;Auth : 验证JWT令牌</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Auth--&gt;&gt;Backend : 认证结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Backend--&gt;&gt;Nginx : 响应数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Nginx--&gt;&gt;Client : 返回响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note over Client,Backend : 所有通信应通过HTTPS加密通道</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note over Auth : JWT令牌通过安全Cookie传输</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L67-L70" target="_blank" rel="noreferrer">nginx.conf</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L340-L352" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L58-L59" target="_blank" rel="noreferrer">docker-compose.yml</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L67-L70" target="_blank" rel="noreferrer">nginx.conf</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L340-L352" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L58-L59" target="_blank" rel="noreferrer">docker-compose.yml</a></li></ul><p>AgentChat系统的安全架构依赖于Nginx和JWT的协同工作，共同构建了完整的传输层安全体系。尽管当前配置存在安全改进空间，但系统设计体现了多层防御的安全理念。</p><p>在理想的安全配置中，Nginx应作为HTTPS终止点，负责SSL/TLS加密解密，将所有HTTP请求重定向到HTTPS，并通过安全的HTTP头强化通信安全。然而，当前<code>nginx.conf</code>配置仅监听HTTP端口8090，未配置HTTPS监听和重定向规则。这是一个显著的安全隐患，因为所有通信（包括JWT令牌）都以明文形式传输，极易受到中间人攻击（Man-in-the-Middle Attack）。</p><p>中间人攻击是未加密通信的主要威胁。攻击者可以在客户端和服务器之间拦截通信，窃取JWT令牌，然后冒充合法用户访问系统。为防止此类攻击，必须确保所有通信都通过HTTPS加密通道进行。在生产环境中，应在Nginx配置中添加HTTPS监听（通常为443端口），配置SSL/TLS证书，并设置HTTP到HTTPS的301重定向。</p><p>JWT令牌的安全传输依赖于HTTPS加密。在当前配置中，JWT令牌通过Cookie传输，<code>auth_jwt.py</code>中的<code>set_access_cookies</code>方法设置了<code>httponly=True</code>属性，防止JavaScript访问Cookie，抵御XSS攻击。然而，<code>_cookie_secure</code>配置项默认为False，这意味着Cookie可以在非HTTPS连接上传输。在安全配置中，必须将此选项设置为True，确保Cookie仅通过安全的HTTPS连接传输。</p><p>系统还应实施HTTP安全头来增强安全性。虽然当前Nginx配置已设置了<code>X-Frame-Options</code>、<code>X-Content-Type-Options</code>和<code>X-XSS-Protection</code>，但缺少<code>Strict-Transport-Security</code>（HSTS）头。HSTS头指示浏览器只能通过HTTPS与服务器通信，即使用户手动输入HTTP地址也会自动转换为HTTPS，有效防止SSL剥离攻击。</p><p>在部署架构上，<code>docker-compose.yml</code>文件显示前端服务监听8090端口，后端API服务监听7860端口。这种分离架构允许Nginx专注于前端请求处理和安全防护，而后端服务专注于业务逻辑。但在生产环境中，建议将Nginx配置为HTTPS终止点，后端服务与Nginx之间的通信可以使用内部网络或更轻量级的安全机制。</p><h2 id="安全通信配置示例" tabindex="-1">安全通信配置示例 <a class="header-anchor" href="#安全通信配置示例" aria-label="Permalink to &quot;安全通信配置示例&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;生产环境安全配置&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[HTTPS监听 443端口]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B[HTTP到HTTPS重定向]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[SSL/TLS证书配置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[安全Cookie设置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[HSTS头设置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[JWT短时效令牌]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[密钥安全管理]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; G</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L67-L70" target="_blank" rel="noreferrer">nginx.conf</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L349-L351" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/config.py#L35-L36" target="_blank" rel="noreferrer">config.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L67-L70" target="_blank" rel="noreferrer">nginx.conf</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L349-L351" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/config.py#L35-L36" target="_blank" rel="noreferrer">config.py</a></li></ul><p>以下是AgentChat系统推荐的生产环境安全通信配置示例，结合了Nginx和JWT的最佳实践：</p><p><strong>Nginx HTTPS配置示例：</strong></p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agentchat.example.com;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> https://$server_name$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ssl http2;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agentchat.example.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/etc/nginx/ssl/agentchat.crt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_certificate_key </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/etc/nginx/ssl/agentchat.key;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_protocols </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TLSv1.2 TLSv1.3;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_ciphers </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_prefer_server_ciphers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Strict-Transport-Security </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;max-age=31536000; includeSubDomains&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> always;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Frame-Options DENY;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Content-Type-Options nosniff;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-XSS-Protection </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1; mode=block&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://backend:7860;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host $host;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Real-IP $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Forwarded-Proto $scheme;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>JWT安全配置示例：</strong></p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Settings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BaseSettings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_secret_key: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;JWT_SECRET_KEY&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;strong-secret-key-change-in-production&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_token_location: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cookies&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_cookie_csrf_protect: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_cookie_secure: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_cookie_samesite: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;lax&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_algorithm: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;HS256&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_access_token_expires: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 900</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 15分钟</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authjwt_refresh_token_expires: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2592000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 30天</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>Docker环境变量配置：</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  JWT_SECRET_KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${JWT_SECRET_KEY}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 其他安全相关环境变量</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此配置示例实现了全面的安全防护：HTTP到HTTPS的强制重定向确保所有通信都通过加密通道；TLSv1.2+协议和强加密套件防止降级攻击；HSTS头防止SSL剥离；安全Cookie设置（Secure、HttpOnly、SameSite）防止令牌泄露；合理的令牌有效期平衡安全与用户体验；密钥通过环境变量管理，避免硬编码。</p><h2 id="安全审计检查清单" tabindex="-1">安全审计检查清单 <a class="header-anchor" href="#安全审计检查清单" aria-label="Permalink to &quot;安全审计检查清单&quot;">​</a></h2><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L1-L101" target="_blank" rel="noreferrer">nginx.conf</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py#L1-L849" target="_blank" rel="noreferrer">auth_jwt.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/config.py#L1-L85" target="_blank" rel="noreferrer">config.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L69-L70" target="_blank" rel="noreferrer">docker-compose.yml</a></li></ul><p>以下是AgentChat系统传输层安全的审计检查清单，用于评估和验证系统的安全性：</p><h3 id="nginx配置审计" tabindex="-1">Nginx配置审计 <a class="header-anchor" href="#nginx配置审计" aria-label="Permalink to &quot;Nginx配置审计&quot;">​</a></h3><ul><li>[ ] 是否配置了HTTPS监听（443端口）？</li><li>[ ] 是否设置了HTTP到HTTPS的301重定向？</li><li>[ ] 是否正确配置了SSL/TLS证书和私钥？</li><li>[ ] 是否使用了安全的TLS协议版本（TLSv1.2或更高）？</li><li>[ ] 是否配置了强加密套件（如ECDHE-RSA-AES256-GCM-SHA512）？</li><li>[ ] 是否设置了HSTS头（Strict-Transport-Security）？</li><li>[ ] 是否隐藏了服务器版本信息（server_tokens off）？</li><li>[ ] 是否设置了X-Frame-Options防止点击劫持？</li><li>[ ] 是否设置了X-Content-Type-Options防止MIME嗅探？</li><li>[ ] 是否设置了X-XSS-Protection启用XSS过滤？</li><li>[ ] 是否禁止了隐藏文件的访问？</li><li>[ ] 是否对静态资源实施了适当的缓存策略？</li></ul><h3 id="jwt配置审计" tabindex="-1">JWT配置审计 <a class="header-anchor" href="#jwt配置审计" aria-label="Permalink to &quot;JWT配置审计&quot;">​</a></h3><ul><li>[ ] JWT密钥是否通过环境变量或安全密钥管理系统配置？</li><li>[ ] JWT密钥是否足够长且随机（建议至少32字符）？</li><li>[ ] 是否使用了安全的签名算法（如HS256、RS256）？</li><li>[ ] 访问令牌有效期是否合理（建议15-30分钟）？</li><li>[ ] 刷新令牌有效期是否合理（建议7-30天）？</li><li>[ ] 是否启用了令牌吊销机制？</li><li>[ ] Cookie是否设置了Secure属性（仅HTTPS传输）？</li><li>[ ] Cookie是否设置了HttpOnly属性（防止JavaScript访问）？</li><li>[ ] Cookie是否设置了SameSite属性（建议Lax或Strict）？</li><li>[ ] 是否启用了CSRF保护机制？</li><li>[ ] 是否验证了令牌的签发者（issuer）和受众（audience）？</li><li>[ ] 是否实现了适当的错误处理和日志记录？</li></ul><h3 id="部署与运维审计" tabindex="-1">部署与运维审计 <a class="header-anchor" href="#部署与运维审计" aria-label="Permalink to &quot;部署与运维审计&quot;">​</a></h3><ul><li>[ ] 生产环境是否使用了独立的、强随机的JWT密钥？</li><li>[ ] 是否定期轮换JWT密钥？</li><li>[ ] 是否监控和记录认证相关的安全事件？</li><li>[ ] 是否定期更新和修补Nginx和依赖库？</li><li>[ ] 是否实施了网络隔离，限制后端服务的直接访问？</li><li>[ ] 是否配置了适当的防火墙规则？</li><li>[ ] 是否实施了入侵检测和防御系统？</li><li>[ ] 是否定期进行安全审计和渗透测试？</li></ul><p>通过系统性地检查以上项目，可以确保AgentChat系统的传输层安全达到生产环境的要求，有效防止中间人攻击、会话劫持和其他常见的Web安全威胁。</p>`,66)])])}const d=a(l,[["render",t]]);export{E as __pageData,d as default};
