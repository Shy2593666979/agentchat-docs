import{_ as a,c as e,o as n,ag as i}from"./chunks/framework.D0TaUBpX.js";const k=JSON.parse('{"title":"数据层","description":"","frontmatter":{},"headers":[],"relativePath":"项目目录结构/后端目录结构/数据层.md","filePath":"项目目录结构/后端目录结构/数据层.md","lastUpdated":1764244560000}'),l={name:"项目目录结构/后端目录结构/数据层.md"};function t(r,s,p,h,d,o){return n(),e("div",null,[...s[0]||(s[0]=[i(`<h1 id="数据层" tabindex="-1">数据层 <a class="header-anchor" href="#数据层" aria-label="Permalink to &quot;数据层&quot;">​</a></h1><cite> **本文档中引用的文件** - [user.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py) - [agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py) - [history.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py) - [base.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/base.py) - [user.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/user.py) - [agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/agent.py) - [session.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/session.py) - [init_data.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/init_data.py) - [__init__.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/__init__.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#项目结构">项目结构</a></li><li><a href="#数据模型设计">数据模型设计</a></li><li><a href="#数据访问对象dao模式">数据访问对象（DAO）模式</a></li><li><a href="#数据库会话管理">数据库会话管理</a></li><li><a href="#应用启动数据初始化">应用启动数据初始化</a></li><li><a href="#数据流示例根据用户id获取agent列表">数据流示例：根据用户ID获取Agent列表</a></li><li><a href="#数据库扩展指南">数据库扩展指南</a></li></ol><h2 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-label="Permalink to &quot;项目结构&quot;">​</a></h2><p>AgentChat项目的数据层主要位于<code>src/backend/agentchat/database/</code>目录下，包含三个核心子模块：<code>models</code>（数据模型）、<code>dao</code>（数据访问对象）和会话管理组件。该设计遵循清晰的分层架构，将数据定义、数据操作和数据库连接管理分离。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据层组件&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Models[models/ 数据模型]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DAO[dao/ 数据访问对象]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session[session.py 会话管理]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitData[init_data.py 初始化]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Models --&gt; DAO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session --&gt; DAO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitData --&gt; DAO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitData --&gt; Models</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models" target="_blank" rel="noreferrer">src/backend/agentchat/database/models</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao" target="_blank" rel="noreferrer">src/backend/agentchat/database/dao</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/session.py" target="_blank" rel="noreferrer">src/backend/agentchat/database/session.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/init_data.py" target="_blank" rel="noreferrer">src/backend/agentchat/database/init_data.py</a></li></ul><h2 id="数据模型设计" tabindex="-1">数据模型设计 <a class="header-anchor" href="#数据模型设计" aria-label="Permalink to &quot;数据模型设计&quot;">​</a></h2><p>数据模型基于SQLModel库定义，位于<code>src/backend/agentchat/database/models/</code>目录中。所有模型均继承自<code>SQLModelSerializable</code>基类，实现了统一的序列化行为。</p><h3 id="基类设计" tabindex="-1">基类设计 <a class="header-anchor" href="#基类设计" aria-label="Permalink to &quot;基类设计&quot;">​</a></h3><p><code>base.py</code>文件定义了<code>SQLModelSerializable</code>基类，为所有数据模型提供通用功能：</p><ul><li><strong>序列化支持</strong>：通过<code>to_dict()</code>方法将模型实例转换为字典，自动处理<code>datetime</code>类型的序列化。</li><li><strong>字段隐藏</strong>：通过<code>hide_fields</code>类变量定义不应暴露的敏感字段（如API密钥）。</li><li><strong>ORM配置</strong>：启用<code>from_attributes=True</code>以支持从数据库记录直接构建模型实例。</li></ul><p><strong>数据模型基类来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/base.py#L28-L43" target="_blank" rel="noreferrer">base.py</a></li></ul><h3 id="核心数据模型" tabindex="-1">核心数据模型 <a class="header-anchor" href="#核心数据模型" aria-label="Permalink to &quot;核心数据模型&quot;">​</a></h3><h4 id="用户模型-user" tabindex="-1">用户模型 (User) <a class="header-anchor" href="#用户模型-user" aria-label="Permalink to &quot;用户模型 (User)&quot;">​</a></h4><p><code>user.py</code>中的<code>UserTable</code>类定义了用户实体，其主要特性包括：</p><ul><li><strong>主键</strong>：<code>user_id</code>作为主键，类型为字符串。</li><li><strong>唯一约束</strong>：<code>user_name</code>字段具有唯一性约束和索引。</li><li><strong>时间戳</strong>：包含<code>create_time</code>和<code>update_time</code>字段，利用数据库的<code>CURRENT_TIMESTAMP</code>自动填充和更新。</li><li><strong>软删除</strong>：通过<code>delete</code>布尔字段实现软删除机制。</li><li><strong>常量定义</strong>：文件中定义了<code>SystemUser</code>和<code>AdminUser</code>常量，用于标识系统用户和管理员。</li></ul><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class UserTable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_email : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_avatar : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_description : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_password : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+delete : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>用户模型来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py#L18-L35" target="_blank" rel="noreferrer">user.py</a></li></ul><h4 id="agent模型" tabindex="-1">Agent模型 <a class="header-anchor" href="#agent模型" aria-label="Permalink to &quot;Agent模型&quot;">​</a></h4><p><code>agent.py</code>中的<code>AgentTable</code>类定义了Agent实体，其关键设计如下：</p><ul><li><strong>主键生成</strong>：<code>id</code>字段使用<code>uuid4().hex</code>作为默认工厂函数，生成唯一的字符串ID。</li><li><strong>JSON字段</strong>：<code>mcp_ids</code>、<code>tool_ids</code>和<code>knowledge_ids</code>字段使用<code>sa_column=Column(JSON)</code>映射到数据库的JSON类型，用于存储字符串列表。</li><li><strong>外键关联</strong>：<code>user_id</code>字段通过索引关联到<code>UserTable</code>，表示Agent的拥有者。</li><li><strong>配置注入</strong>：<code>logo_url</code>字段的默认值从<code>app_settings</code>中获取，实现了配置与代码的解耦。</li></ul><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class AgentTable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+description : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+logo_url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+is_custom : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+system_prompt : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+llm_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+enable_memory : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_ids : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+tool_ids : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+knowledge_ids : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>Agent模型来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py#L11-L47" target="_blank" rel="noreferrer">agent.py</a></li></ul><h4 id="聊天历史模型" tabindex="-1">聊天历史模型 <a class="header-anchor" href="#聊天历史模型" aria-label="Permalink to &quot;聊天历史模型&quot;">​</a></h4><p><code>history.py</code>中的<code>HistoryTable</code>类定义了聊天历史记录：</p><ul><li><strong>内容存储</strong>：<code>content</code>字段使用<code>Text</code>类型，适合存储较长的文本消息。</li><li><strong>角色枚举</strong>：<code>role</code>字段使用<code>Literal[&quot;assistant&quot;, &quot;system&quot;, &quot;user&quot;]</code>进行类型限制。</li><li><strong>事件记录</strong>：<code>events</code>字段为JSON类型，用于存储AI回复过程中的事件信息。</li></ul><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class HistoryTable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+content : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+dialog_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+role : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+events : List[dict]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>聊天历史模型来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py#L12-L37" target="_blank" rel="noreferrer">history.py</a></li></ul><h2 id="数据访问对象-dao-模式" tabindex="-1">数据访问对象（DAO）模式 <a class="header-anchor" href="#数据访问对象-dao-模式" aria-label="Permalink to &quot;数据访问对象（DAO）模式&quot;">​</a></h2><p>DAO模式通过<code>src/backend/agentchat/database/dao/</code>目录下的模块实现，为上层服务提供封装的数据库操作接口。</p><h3 id="userdao实现" tabindex="-1">UserDao实现 <a class="header-anchor" href="#userdao实现" aria-label="Permalink to &quot;UserDao实现&quot;">​</a></h3><p><code>dao/user.py</code>中的<code>UserDao</code>类提供了对<code>UserTable</code>的CRUD操作：</p><ul><li><strong>查询方法</strong>：<code>get_user()</code>、<code>get_user_by_username()</code>等方法根据不同条件查询用户。</li><li><strong>分页查询</strong>：<code>filter_users()</code>和<code>get_all_users()</code>支持分页，通过<code>offset</code>和<code>limit</code>实现。</li><li><strong>创建与更新</strong>：<code>create_user()</code>、<code>add_user_and_default_role()</code>等方法封装了用户创建逻辑。</li><li><strong>会话管理</strong>：所有方法都通过<code>session_getter()</code>上下文管理器获取数据库会话，确保会话的正确开启和关闭。</li></ul><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class UserDao {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_user(user_id) UserTable</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_user_by_username(user_name) UserTable</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_user_by_ids(user_ids) List[UserTable]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+filter_users(user_ids, keyword, page, limit) (List[UserTable], int)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_user(user_id, user_name, ...) void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_user_info(user_id, user_avatar, ...) void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_all_users(page, limit) List[UserTable]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>UserDao来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/user.py#L7-L119" target="_blank" rel="noreferrer">user.py</a></li></ul><h3 id="agentdao实现" tabindex="-1">AgentDao实现 <a class="header-anchor" href="#agentdao实现" aria-label="Permalink to &quot;AgentDao实现&quot;">​</a></h3><p>虽然未直接读取<code>agent.py</code>，但根据项目结构和命名规范，<code>dao/agent.py</code>应提供类似的CRUD接口，如<code>get_agent_by_user_id()</code>、<code>create_agent()</code>等，供上层服务调用。</p><p><strong>DAO模式来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/user.py" target="_blank" rel="noreferrer">user.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/agent.py" target="_blank" rel="noreferrer">agent.py</a></li></ul><h2 id="数据库会话管理" tabindex="-1">数据库会话管理 <a class="header-anchor" href="#数据库会话管理" aria-label="Permalink to &quot;数据库会话管理&quot;">​</a></h2><p><code>session.py</code>文件负责管理数据库会话的生命周期，是数据层与数据库引擎之间的桥梁。</p><h3 id="同步会话管理" tabindex="-1">同步会话管理 <a class="header-anchor" href="#同步会话管理" aria-label="Permalink to &quot;同步会话管理&quot;">​</a></h3><p><code>session_getter()</code>是一个同步上下文管理器：</p><ul><li><strong>会话创建</strong>：使用全局的<code>engine</code>（来自<code>database/__init__.py</code>）创建<code>Session</code>实例。</li><li><strong>异常处理</strong>：在发生异常时自动执行<code>rollback()</code>，并重新抛出异常。</li><li><strong>资源清理</strong>：在<code>finally</code>块中确保会话被<code>close()</code>，防止资源泄漏。</li></ul><h3 id="异步会话管理" tabindex="-1">异步会话管理 <a class="header-anchor" href="#异步会话管理" aria-label="Permalink to &quot;异步会话管理&quot;">​</a></h3><p><code>async_session_getter()</code>提供异步支持：</p><ul><li><strong>异步会话</strong>：使用<code>async_engine</code>创建<code>AsyncSession</code>实例。</li><li><strong>异步操作</strong>：<code>rollback()</code>和<code>close()</code>操作使用<code>await</code>关键字，符合异步编程范式。</li></ul><p>这种设计使得DAO层可以同时支持同步和异步的数据库操作。</p><p><strong>会话管理来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/session.py#L12-L36" target="_blank" rel="noreferrer">session.py</a></li></ul><h2 id="应用启动数据初始化" tabindex="-1">应用启动数据初始化 <a class="header-anchor" href="#应用启动数据初始化" aria-label="Permalink to &quot;应用启动数据初始化&quot;">​</a></h2><p><code>init_data.py</code>文件在应用启动时执行，负责初始化数据库表和默认数据。</p><h3 id="初始化流程" tabindex="-1">初始化流程 <a class="header-anchor" href="#初始化流程" aria-label="Permalink to &quot;初始化流程&quot;">​</a></h3><ol><li><strong>创建数据表</strong>：<code>init_database()</code>调用<code>SQLModel.metadata.create_all(engine)</code>，根据模型定义创建所有缺失的表。</li><li><strong>初始化默认数据</strong>：<code>init_default_agent()</code>是核心初始化函数，它会检查数据库中是否存在数据，若无则执行： <ul><li><code>insert_tools_to_mysql()</code>：从<code>config/tool.json</code>加载默认工具配置并存入数据库。</li><li><code>insert_llm_to_mysql()</code>：从<code>app_settings</code>读取默认LLM配置并创建记录。</li><li><code>insert_agent_to_mysql()</code>：为每个工具创建一个对应的默认Agent。</li></ul></li></ol><h3 id="mcp-server初始化" tabindex="-1">MCP Server初始化 <a class="header-anchor" href="#mcp-server初始化" aria-label="Permalink to &quot;MCP Server初始化&quot;">​</a></h3><p><code>update_system_mcp_server()</code>函数负责MCP Server的初始化和更新：</p><ul><li><strong>首次加载</strong>：如果数据库中没有MCP Server记录，则从<code>config/mcp_server.json</code>加载默认配置。</li><li><strong>定期更新</strong>：如果已有记录，则根据策略（如超过七天）决定是否从配置文件更新。</li></ul><p>这种机制确保了系统拥有可用的默认配置，同时允许动态更新。</p><p><strong>初始化来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/init_data.py#L21-L169" target="_blank" rel="noreferrer">init_data.py</a></li></ul><h2 id="数据流示例-根据用户id获取agent列表" tabindex="-1">数据流示例：根据用户ID获取Agent列表 <a class="header-anchor" href="#数据流示例-根据用户id获取agent列表" aria-label="Permalink to &quot;数据流示例：根据用户ID获取Agent列表&quot;">​</a></h2><p>以下是从DAO调用到SQL执行的完整数据流分析：</p><ol><li><strong>服务层调用</strong>：上层服务（如<code>api/services/agent.py</code>）调用<code>AgentDao.get_agents_by_user_id(user_id)</code>。</li><li><strong>DAO层处理</strong>：<code>AgentDao</code>方法内部： <ul><li>调用<code>session_getter()</code>获取一个数据库会话。</li><li>构造SQLModel查询语句，例如<code>select(AgentTable).where(AgentTable.user_id == user_id)</code>。</li><li>通过会话的<code>exec()</code>方法执行查询。</li><li>将查询结果（<code>AgentTable</code>实例列表）返回给服务层。</li></ul></li><li><strong>会话管理</strong>：<code>session_getter()</code>确保会话在查询结束后被正确关闭。</li><li><strong>SQL执行</strong>：SQLModel将Python查询转换为原生SQL（如<code>SELECT * FROM agent WHERE user_id = ?</code>），并通过数据库引擎发送给MySQL执行。</li><li><strong>结果返回</strong>：数据库返回结果集，SQLModel将其映射回<code>AgentTable</code>对象列表。</li></ol><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Service as &quot;服务层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant DAO as &quot;AgentDao&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Session as &quot;session_getter&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Engine as &quot;SQLModel引擎&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant DB as &quot;MySQL数据库&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;DAO : get_agents_by_user_id(user_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DAO-&gt;&gt;Session : with session_getter()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session-&gt;&gt;Session : 创建Session实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DAO-&gt;&gt;DAO : 构造查询语句</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DAO-&gt;&gt;Engine : session.exec(statement)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Engine-&gt;&gt;DB : 发送SQL : SELECT * FROM agent WHERE user_id = ?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB--&gt;&gt;Engine : 返回结果集</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Engine--&gt;&gt;DAO : 映射为AgentTable对象列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DAO--&gt;&gt;Service : 返回Agent列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session-&gt;&gt;Session : 关闭Session</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>数据流来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/agent.py" target="_blank" rel="noreferrer">agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/session.py" target="_blank" rel="noreferrer">session.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py" target="_blank" rel="noreferrer">agent.py</a></li></ul><h2 id="数据库扩展指南" tabindex="-1">数据库扩展指南 <a class="header-anchor" href="#数据库扩展指南" aria-label="Permalink to &quot;数据库扩展指南&quot;">​</a></h2><p>新增数据模型及对应的DAO操作遵循以下步骤：</p><h3 id="_1-定义新的数据模型" tabindex="-1">1. 定义新的数据模型 <a class="header-anchor" href="#_1-定义新的数据模型" aria-label="Permalink to &quot;1. 定义新的数据模型&quot;">​</a></h3><p>在<code>models/</code>目录下创建新的Python文件（如<code>new_model.py</code>），定义继承自<code>SQLModelSerializable</code>的模型类：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sqlmodel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Field, SQLModel</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agentchat.database.models.base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SQLModelSerializable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NewModelTable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SQLModelSerializable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">table</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    __tablename__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;new_model&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Field(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">default_factory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=lambda</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: uuid4().hex, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">primary_key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Field(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ... 其他字段</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-在models-init-py中注册-可选" tabindex="-1">2. 在<code>models/__init__.py</code>中注册（可选） <a class="header-anchor" href="#_2-在models-init-py中注册-可选" aria-label="Permalink to &quot;2. 在\`models/__init__.py\`中注册（可选）&quot;">​</a></h3><p>如果需要在其他地方方便地导入，可以在<code>__init__.py</code>中添加导入语句。</p><h3 id="_3-创建对应的dao" tabindex="-1">3. 创建对应的DAO <a class="header-anchor" href="#_3-创建对应的dao" aria-label="Permalink to &quot;3. 创建对应的DAO&quot;">​</a></h3><p>在<code>dao/</code>目录下创建<code>new_model.py</code>，定义<code>NewModelDao</code>类：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agentchat.database.models.new_model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NewModelTable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sqlmodel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Session, select</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agentchat.database.session </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session_getter</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NewModelDao</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    @</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">classmethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_by_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cls, id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; NewModelTable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session_getter() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            statement </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> select(NewModelTable).where(NewModelTable.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session.exec(statement).first()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    @</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">classmethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cls, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kwargs):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session_getter() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            instance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NewModelTable(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kwargs)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            session.add(instance)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            session.commit()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            session.refresh(instance)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> instance</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ... 实现其他CRUD方法</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_4-更新初始化脚本-如需要" tabindex="-1">4. 更新初始化脚本（如需要） <a class="header-anchor" href="#_4-更新初始化脚本-如需要" aria-label="Permalink to &quot;4. 更新初始化脚本（如需要）&quot;">​</a></h3><p>如果新模型需要默认数据，修改<code>init_data.py</code>，添加相应的初始化函数，并在<code>init_default_agent()</code>或类似函数中调用。</p><p>完成以上步骤后，新的数据模型即可在服务层通过DAO进行安全、封装的访问。</p><p><strong>扩展指南来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/base.py" target="_blank" rel="noreferrer">base.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py" target="_blank" rel="noreferrer">user.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/user.py" target="_blank" rel="noreferrer">user.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/init_data.py" target="_blank" rel="noreferrer">init_data.py</a></li></ul>`,89)])])}const g=a(l,[["render",t]]);export{k as __pageData,g as default};
