import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.7BqJGZTL.js";const g=JSON.parse('{"title":"监控与维护","description":"","frontmatter":{},"headers":[],"relativePath":"部署指南/运维管理/监控与维护.md","filePath":"部署指南/运维管理/监控与维护.md","lastUpdated":1764244560000}'),l={name:"部署指南/运维管理/监控与维护.md"};function t(p,s,r,h,d,k){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="监控与维护" tabindex="-1">监控与维护 <a class="header-anchor" href="#监控与维护" aria-label="Permalink to &quot;监控与维护&quot;">​</a></h1><cite> **本文档引用的文件** - [nginx.conf](https://github.com/Shy2593666979/AgentChat/docker/nginx.conf) - [docker-compose.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml) - [trace_id_middleware.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/trace_id_middleware.py) - [usage_stats.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/usage_stats.py) - [usage_stats.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/usage_stats.py) - [usage_stats.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/usage_stats.py) - [usage_stats.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/usage_stats.py) - [usage_stats.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/usage_stats.py) - [usage_metadata.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/callbacks/usage_metadata.py) - [main.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py) - [settings.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py) - [README.md](https://github.com/Shy2593666979/AgentChat/README.md) - [docker/README.md](https://github.com/Shy2593666979/AgentChat/docker/README.md) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#系统概述">系统概述</a></li><li><a href="#监控架构">监控架构</a></li><li><a href="#nginx日志监控">Nginx日志监控</a></li><li><a href="#docker容器监控">Docker容器监控</a></li><li><a href="#应用中间件监控">应用中间件监控</a></li><li><a href="#使用统计服务">使用统计服务</a></li><li><a href="#健康检查机制">健康检查机制</a></li><li><a href="#性能监控与告警">性能监控与告警</a></li><li><a href="#日志管理策略">日志管理策略</a></li><li><a href="#故障排除指南">故障排除指南</a></li></ol><h2 id="系统概述" tabindex="-1">系统概述 <a class="header-anchor" href="#系统概述" aria-label="Permalink to &quot;系统概述&quot;">​</a></h2><p>AgentChat是一个现代化的智能对话系统，采用前后端分离架构，集成了多种AI模型和服务。系统包含以下核心组件：</p><ul><li><strong>前端服务</strong>：基于Vue 3的现代化用户界面</li><li><strong>后端服务</strong>：FastAPI构建的高性能API服务</li><li><strong>数据库层</strong>：MySQL + Redis + 向量数据库</li><li><strong>代理服务</strong>：Nginx反向代理和负载均衡</li></ul><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;客户端层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[Web浏览器] --&gt; B[移动端应用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;代理层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[Nginx] --&gt; D[健康检查]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;应用层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[前端服务&lt;br/&gt;Vue 3 + FastAPI] --&gt; F[后端API]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[中间件层]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[MySQL] --&gt; I[Redis缓存]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J[向量数据库]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; J</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L1-L126" target="_blank" rel="noreferrer">docker-compose.yml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py#L1-L108" target="_blank" rel="noreferrer">main.py</a></li></ul><h2 id="监控架构" tabindex="-1">监控架构 <a class="header-anchor" href="#监控架构" aria-label="Permalink to &quot;监控架构&quot;">​</a></h2><p>系统采用多层次监控架构，涵盖基础设施、应用服务和业务指标三个维度。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;基础设施监控&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A1[Docker容器] --&gt; A2[系统资源]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A2 --&gt; A3[网络状态]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;应用监控&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B1[FastAPI服务] --&gt; B2[中间件链]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B2 --&gt; B3[业务指标]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;业务监控&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C1[使用统计] --&gt; C2[Token消耗]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C2 --&gt; C3[请求追踪]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A1 --&gt; D[监控面板]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B1 --&gt; D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C1 --&gt; D</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L26-L92" target="_blank" rel="noreferrer">docker-compose.yml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py#L28-L48" target="_blank" rel="noreferrer">main.py</a></li></ul><h2 id="nginx日志监控" tabindex="-1">Nginx日志监控 <a class="header-anchor" href="#nginx日志监控" aria-label="Permalink to &quot;Nginx日志监控&quot;">​</a></h2><p>Nginx作为反向代理服务器，提供详细的访问日志和错误日志，支持实时监控和分析。</p><h3 id="日志配置" tabindex="-1">日志配置 <a class="header-anchor" href="#日志配置" aria-label="Permalink to &quot;日志配置&quot;">​</a></h3><p>系统配置了专门的日志格式，包含以下关键信息：</p><ul><li>客户端IP地址</li><li>请求方法和URL路径</li><li>HTTP状态码</li><li>响应大小</li><li>用户代理信息</li><li>请求耗时</li></ul><h3 id="日志轮转策略" tabindex="-1">日志轮转策略 <a class="header-anchor" href="#日志轮转策略" aria-label="Permalink to &quot;日志轮转策略&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Nginx日志轮转配置示例</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/var/log/nginx/*.log</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    daily</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    missingok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    rotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    compress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    delaycompress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    notifempty</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 644</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    postrotate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    endscript</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="关键监控指标" tabindex="-1">关键监控指标 <a class="header-anchor" href="#关键监控指标" aria-label="Permalink to &quot;关键监控指标&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指标名称</th><th>描述</th><th>监控阈值</th></tr></thead><tbody><tr><td>请求响应时间</td><td>平均请求处理时间</td><td>&gt;500ms</td></tr><tr><td>错误率</td><td>4xx/5xx状态码比例</td><td>&gt;5%</td></tr><tr><td>并发连接数</td><td>当前活跃连接数</td><td>&gt;1000</td></tr><tr><td>带宽使用率</td><td>网络传输速率</td><td>&gt;80%</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L18-L24" target="_blank" rel="noreferrer">nginx.conf</a></li></ul><h2 id="docker容器监控" tabindex="-1">Docker容器监控 <a class="header-anchor" href="#docker容器监控" aria-label="Permalink to &quot;Docker容器监控&quot;">​</a></h2><p>Docker Compose配置了完整的健康检查机制，确保各服务组件的正常运行。</p><h3 id="服务健康检查" tabindex="-1">服务健康检查 <a class="header-anchor" href="#服务健康检查" aria-label="Permalink to &quot;服务健康检查&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Docker as Docker Engine</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Health as Health Check</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Service as 应用服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Docker-&gt;&gt;Health : 定期检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Health-&gt;&gt;Service : 发送健康请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service--&gt;&gt;Health : 返回状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Health--&gt;&gt;Docker : 更新容器状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note over Docker,Service : 检查间隔：30秒&lt;br/&gt;超时时间：10秒&lt;br/&gt;重试次数：3次</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L26-L92" target="_blank" rel="noreferrer">docker-compose.yml</a></li></ul><h3 id="容器资源监控" tabindex="-1">容器资源监控 <a class="header-anchor" href="#容器资源监控" aria-label="Permalink to &quot;容器资源监控&quot;">​</a></h3><table tabindex="0"><thead><tr><th>服务组件</th><th>CPU使用率</th><th>内存使用率</th><th>磁盘I/O</th><th>网络I/O</th></tr></thead><tbody><tr><td>MySQL</td><td>&lt; 70%</td><td>&lt; 80%</td><td>&lt; 100MB/s</td><td>&lt; 50MB/s</td></tr><tr><td>Redis</td><td>&lt; 50%</td><td>&lt; 60%</td><td>&lt; 50MB/s</td><td>&lt; 20MB/s</td></tr><tr><td>Backend</td><td>&lt; 80%</td><td>&lt; 70%</td><td>&lt; 20MB/s</td><td>&lt; 30MB/s</td></tr><tr><td>Frontend</td><td>&lt; 30%</td><td>&lt; 40%</td><td>&lt; 10MB/s</td><td>&lt; 10MB/s</td></tr></tbody></table><h3 id="容器状态管理" tabindex="-1">容器状态管理 <a class="header-anchor" href="#容器状态管理" aria-label="Permalink to &quot;容器状态管理&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看所有服务状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看特定服务日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 监控容器资源使用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stats</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> agentchat-backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> agentchat-frontend</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L115-L165" target="_blank" rel="noreferrer">docker-compose.yml</a></li></ul><h2 id="应用中间件监控" tabindex="-1">应用中间件监控 <a class="header-anchor" href="#应用中间件监控" aria-label="Permalink to &quot;应用中间件监控&quot;">​</a></h2><p>系统通过中间件层实现全面的请求追踪和性能监控。</p><h3 id="traceid中间件" tabindex="-1">TraceID中间件 <a class="header-anchor" href="#traceid中间件" aria-label="Permalink to &quot;TraceID中间件&quot;">​</a></h3><p>TraceID中间件为每个请求生成唯一的跟踪标识符，支持分布式追踪和问题定位。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as 客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Middleware as TraceID中间件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Logger as 日志系统</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Service as 业务服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;Middleware : HTTP请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware-&gt;&gt;Middleware : 生成TraceID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware-&gt;&gt;Logger : 记录请求开始</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware-&gt;&gt;Service : 转发请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service--&gt;&gt;Middleware : 响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware-&gt;&gt;Logger : 记录响应信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware--&gt;&gt;Client : 返回响应</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/trace_id_middleware.py#L12-L32" target="_blank" rel="noreferrer">trace_id_middleware.py</a></li></ul><h3 id="中间件功能特性" tabindex="-1">中间件功能特性 <a class="header-anchor" href="#中间件功能特性" aria-label="Permalink to &quot;中间件功能特性&quot;">​</a></h3><table tabindex="0"><thead><tr><th>功能</th><th>描述</th><th>实现位置</th></tr></thead><tbody><tr><td>请求追踪</td><td>为每个请求生成唯一ID</td><td>TraceIDMiddleware</td></tr><tr><td>性能监控</td><td>记录请求处理时间</td><td>日志记录</td></tr><tr><td>异常捕获</td><td>捕获并记录异常信息</td><td>异常处理</td></tr><tr><td>响应头注入</td><td>添加TraceID到响应头</td><td>响应处理</td></tr></tbody></table><h3 id="白名单中间件" tabindex="-1">白名单中间件 <a class="header-anchor" href="#白名单中间件" aria-label="Permalink to &quot;白名单中间件&quot;">​</a></h3><p>提供安全访问控制，支持IP白名单和API路径白名单配置。</p><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/trace_id_middleware.py#L1-L32" target="_blank" rel="noreferrer">trace_id_middleware.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py#L41-L46" target="_blank" rel="noreferrer">main.py</a></li></ul><h2 id="使用统计服务" tabindex="-1">使用统计服务 <a class="header-anchor" href="#使用统计服务" aria-label="Permalink to &quot;使用统计服务&quot;">​</a></h2><p>系统提供完整的使用统计功能，支持按Agent、模型、时间维度的详细分析。</p><h3 id="统计数据模型" tabindex="-1">统计数据模型 <a class="header-anchor" href="#统计数据模型" aria-label="Permalink to &quot;统计数据模型&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">erDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USAGE_STATS {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string model</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int input_tokens</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int output_tokens</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string username</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string email</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent_name PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MODEL {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string model_name PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string provider</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string version</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ USAGE_STATS : generates</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT ||--o{ USAGE_STATS : uses</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MODEL ||--o{ USAGE_STATS : invokes</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/usage_stats.py#L1-L33" target="_blank" rel="noreferrer">usage_stats.py</a></li></ul><h3 id="统计服务功能" tabindex="-1">统计服务功能 <a class="header-anchor" href="#统计服务功能" aria-label="Permalink to &quot;统计服务功能&quot;">​</a></h3><table tabindex="0"><thead><tr><th>功能模块</th><th>API端点</th><th>描述</th></tr></thead><tbody><tr><td>Token统计</td><td><code>/api/v1/usage</code></td><td>按Agent/模型统计Token使用量</td></tr><tr><td>调用次数统计</td><td><code>/api/v1/usage_count</code></td><td>统计API调用次数</td></tr><tr><td>模型列表</td><td><code>/api/v1/usage/models_list</code></td><td>获取可用模型列表</td></tr><tr><td>Agent列表</td><td><code>/api/v1/usage/agents_list</code></td><td>获取可用Agent列表</td></tr></tbody></table><h3 id="数据聚合算法" tabindex="-1">数据聚合算法 <a class="header-anchor" href="#数据聚合算法" aria-label="Permalink to &quot;数据聚合算法&quot;">​</a></h3><p>系统支持按时间维度的数据聚合：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[原始统计数据] --&gt; B{时间过滤}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |按天| C[日统计数据]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |按周| D[周统计数据]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |按月| E[月统计数据]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; F[Token汇总]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[Agent维度聚合]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; H[Model维度聚合]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; I[最终统计报表]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/usage_stats.py#L44-L96" target="_blank" rel="noreferrer">usage_stats.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/usage_stats.py#L1-L135" target="_blank" rel="noreferrer">usage_stats.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/usage_stats.py#L1-L60" target="_blank" rel="noreferrer">usage_stats.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/usage_stats.py#L1-L158" target="_blank" rel="noreferrer">usage_stats.py</a></li></ul><h2 id="健康检查机制" tabindex="-1">健康检查机制 <a class="header-anchor" href="#健康检查机制" aria-label="Permalink to &quot;健康检查机制&quot;">​</a></h2><p>系统实现了多层次的健康检查机制，确保服务的高可用性。</p><h3 id="服务健康检查-1" tabindex="-1">服务健康检查 <a class="header-anchor" href="#服务健康检查-1" aria-label="Permalink to &quot;服务健康检查&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;健康检查层次&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[容器级别] --&gt; B[服务级别]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[应用级别]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[业务级别]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;检查内容&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[进程存活] --&gt; F[端口监听]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[数据库连接]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; H[外部服务调用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A -.-&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B -.-&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C -.-&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D -.-&gt; H</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="健康检查配置" tabindex="-1">健康检查配置 <a class="header-anchor" href="#健康检查配置" aria-label="Permalink to &quot;健康检查配置&quot;">​</a></h3><table tabindex="0"><thead><tr><th>服务</th><th>检查端点</th><th>检查频率</th><th>超时时间</th><th>重试次数</th></tr></thead><tbody><tr><td>Backend</td><td><code>/health</code></td><td>30秒</td><td>10秒</td><td>3次</td></tr><tr><td>Frontend</td><td><code>/</code></td><td>30秒</td><td>10秒</td><td>3次</td></tr><tr><td>MySQL</td><td><code>mysqladmin ping</code></td><td>30秒</td><td>20秒</td><td>10次</td></tr><tr><td>Redis</td><td><code>redis-cli ping</code></td><td>30秒</td><td>10秒</td><td>3次</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L26-L92" target="_blank" rel="noreferrer">docker-compose.yml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py#L23-L27" target="_blank" rel="noreferrer">main.py</a></li></ul><h2 id="性能监控与告警" tabindex="-1">性能监控与告警 <a class="header-anchor" href="#性能监控与告警" aria-label="Permalink to &quot;性能监控与告警&quot;">​</a></h2><h3 id="关键性能指标" tabindex="-1">关键性能指标 <a class="header-anchor" href="#关键性能指标" aria-label="Permalink to &quot;关键性能指标&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指标类型</th><th>监控指标</th><th>正常范围</th><th>告警阈值</th><th>处理建议</th></tr></thead><tbody><tr><td>响应时间</td><td>API平均响应时间</td><td>&lt;200ms</td><td>&gt;500ms</td><td>优化数据库查询</td></tr><tr><td>吞吐量</td><td>每秒请求数</td><td>&gt;100 req/s</td><td>&lt;50 req/s</td><td>扩容或优化</td></tr><tr><td>错误率</td><td>5xx错误比例</td><td>&lt;1%</td><td>&gt;5%</td><td>检查服务状态</td></tr><tr><td>资源使用</td><td>CPU使用率</td><td>&lt;70%</td><td>&gt;85%</td><td>升级硬件或优化</td></tr><tr><td>内存使用</td><td>内存使用率</td><td>&lt;80%</td><td>&gt;90%</td><td>增加内存或优化</td></tr></tbody></table><h3 id="prometheus集成配置" tabindex="-1">Prometheus集成配置 <a class="header-anchor" href="#prometheus集成配置" aria-label="Permalink to &quot;Prometheus集成配置&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># prometheus.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">global</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  scrape_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">scrape_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;agentchat&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localhost:9090&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metrics_path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/metrics&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    scrape_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30s</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="grafana仪表板配置" tabindex="-1">Grafana仪表板配置 <a class="header-anchor" href="#grafana仪表板配置" aria-label="Permalink to &quot;Grafana仪表板配置&quot;">​</a></h3><p>建议监控面板包含以下图表：</p><ul><li><strong>系统概览</strong>：CPU、内存、磁盘使用率</li><li><strong>应用性能</strong>：请求响应时间、吞吐量</li><li><strong>业务指标</strong>：Token使用量、API调用统计</li><li><strong>错误监控</strong>：错误率趋势、异常告警</li></ul><h2 id="日志管理策略" tabindex="-1">日志管理策略 <a class="header-anchor" href="#日志管理策略" aria-label="Permalink to &quot;日志管理策略&quot;">​</a></h2><h3 id="日志级别配置" tabindex="-1">日志级别配置 <a class="header-anchor" href="#日志级别配置" aria-label="Permalink to &quot;日志级别配置&quot;">​</a></h3><table tabindex="0"><thead><tr><th>级别</th><th>用途</th><th>示例场景</th></tr></thead><tbody><tr><td>DEBUG</td><td>详细调试信息</td><td>开发阶段问题排查</td></tr><tr><td>INFO</td><td>一般信息记录</td><td>请求处理、定时任务</td></tr><tr><td>WARNING</td><td>警告信息</td><td>性能警告、配置问题</td></tr><tr><td>ERROR</td><td>错误信息</td><td>异常处理、系统错误</td></tr><tr><td>CRITICAL</td><td>严重错误</td><td>服务不可用、数据丢失</td></tr></tbody></table><h3 id="日志轮转配置" tabindex="-1">日志轮转配置 <a class="header-anchor" href="#日志轮转配置" aria-label="Permalink to &quot;日志轮转配置&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /etc/logrotate.d/agentchat</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/var/log/agentchat/*.log</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    daily</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    missingok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    rotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    compress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    delaycompress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    notifempty</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 644</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> agentchat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> agentchat</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    postrotate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> supervisorctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    endscript</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="日志分析工具" tabindex="-1">日志分析工具 <a class="header-anchor" href="#日志分析工具" aria-label="Permalink to &quot;日志分析工具&quot;">​</a></h3><p>推荐使用以下工具进行日志分析：</p><ul><li><strong>ELK Stack</strong>：Elasticsearch + Logstash + Kibana</li><li><strong>Fluentd</strong>：日志收集和转发</li><li><strong>Graylog</strong>：集中式日志管理</li><li><strong>Splunk</strong>：商业级日志分析平台</li></ul><h2 id="故障排除指南" tabindex="-1">故障排除指南 <a class="header-anchor" href="#故障排除指南" aria-label="Permalink to &quot;故障排除指南&quot;">​</a></h2><h3 id="常见问题诊断" tabindex="-1">常见问题诊断 <a class="header-anchor" href="#常见问题诊断" aria-label="Permalink to &quot;常见问题诊断&quot;">​</a></h3><h4 id="_1-服务启动失败" tabindex="-1">1. 服务启动失败 <a class="header-anchor" href="#_1-服务启动失败" aria-label="Permalink to &quot;1. 服务启动失败&quot;">​</a></h4><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查容器状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看详细日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /app/config.yaml</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-数据库连接问题" tabindex="-1">2. 数据库连接问题 <a class="header-anchor" href="#_2-数据库连接问题" aria-label="Permalink to &quot;2. 数据库连接问题&quot;">​</a></h4><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查MySQL容器状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 进入MySQL容器测试连接</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查数据库配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DATABASE</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_3-性能问题排查" tabindex="-1">3. 性能问题排查 <a class="header-anchor" href="#_3-性能问题排查" aria-label="Permalink to &quot;3. 性能问题排查&quot;">​</a></h4><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 监控系统资源</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stats</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 分析慢查询</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;SHOW PROCESSLIST;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查Redis性能</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> info</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="故障恢复流程" tabindex="-1">故障恢复流程 <a class="header-anchor" href="#故障恢复流程" aria-label="Permalink to &quot;故障恢复流程&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[发现问题] --&gt; B{问题类型}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |服务不可用| C[重启服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |性能下降| D[扩容资源]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |数据损坏| E[数据恢复]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; F[验证服务状态]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G{问题解决?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; |是| H[恢复正常监控]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; |否| I[升级处理级别]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J[联系技术支持]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="监控告警配置" tabindex="-1">监控告警配置 <a class="header-anchor" href="#监控告警配置" aria-label="Permalink to &quot;监控告警配置&quot;">​</a></h3><p>建议配置以下告警规则：</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">agentchat_alerts</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">alert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">HighCPUUsage</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        expr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cpu_usage &gt; 85</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5m</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">alert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">HighMemoryUsage</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        expr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">memory_usage &gt; 90</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3m</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">alert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ServiceDown</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        expr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">up{job=&quot;agentchat&quot;} == 0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1m</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/README.md#L170-L235" target="_blank" rel="noreferrer">docker/README.md</a></li></ul><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>AgentChat系统提供了完整的监控与维护解决方案，通过多层次的监控架构、详细的日志记录、智能的使用统计和完善的健康检查机制，确保系统的稳定运行和高效维护。建议运维团队定期检查监控指标，及时处理告警信息，并根据业务发展需求调整监控策略和资源配置。</p>`,107)])])}const b=a(l,[["render",t]]);export{g as __pageData,b as default};
