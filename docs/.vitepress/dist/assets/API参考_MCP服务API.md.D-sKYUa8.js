import{_ as a,c as n,o as e,ag as i}from"./chunks/framework.7BqJGZTL.js";const g=JSON.parse('{"title":"MCP服务API","description":"","frontmatter":{},"headers":[],"relativePath":"API参考/MCP服务API.md","filePath":"API参考/MCP服务API.md","lastUpdated":1764244560000}'),p={name:"API参考/MCP服务API.md"};function l(r,s,t,h,c,E){return e(),n("div",null,[...s[0]||(s[0]=[i(`<h1 id="mcp服务api" tabindex="-1">MCP服务API <a class="header-anchor" href="#mcp服务api" aria-label="Permalink to &quot;MCP服务API&quot;">​</a></h1><cite> **本文档引用的文件** - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py) - [mcp_chat.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py) - [mcp_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_agent.py) - [mcp_user_config.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_user_config.py) - [mcp_stdio_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_stdio_server.py) - [v1/mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_server.py) - [v1/mcp_chat.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_chat.py) - [v1/mcp_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_agent.py) - [v1/mcp_stdio_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_stdio_server.py) - [config/mcp_server.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json) - [mcp_servers/lark_mcp/main.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py) - [mcp_servers/weather/mcp_weather.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py) - [services/mcp/manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py) - [schema/mcp.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/mcp.py) - [database/models/mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#介绍">介绍</a></li><li><a href="#项目结构">项目结构</a></li><li><a href="#核心组件">核心组件</a></li><li><a href="#架构概述">架构概述</a></li><li><a href="#详细组件分析">详细组件分析</a></li><li><a href="#依赖分析">依赖分析</a></li><li><a href="#性能考虑">性能考虑</a></li><li><a href="#故障排除指南">故障排除指南</a></li><li><a href="#结论">结论</a></li></ol><h2 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-label="Permalink to &quot;介绍&quot;">​</a></h2><p>MCP（Modular Capability Provider）服务API是AgentChat系统的核心扩展机制，它允许通过模块化能力提供者来扩展Agent的功能边界。该系统通过标准化的API接口实现了MCP服务器的注册、发现和状态查询，支持通过mcp_chat端点与MCP Agent进行交互。系统内置了Lark-MCP和Weather-MCP等服务，并提供了灵活的配置流程和动态加载机制，使开发者能够轻松集成新的MCP服务。</p><p><strong>MCP协议</strong>在系统中扮演着关键角色，它定义了能力提供者与主Agent之间的通信标准，使得各种外部服务能够以统一的方式被集成和调用。这种架构设计不仅提高了系统的可扩展性，还增强了功能的灵活性和可维护性。</p><h2 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-label="Permalink to &quot;项目结构&quot;">​</a></h2><p>MCP服务在AgentChat项目中具有清晰的目录结构和组织方式，主要分布在<code>src/backend/agentchat/</code>目录下。系统采用分层架构设计，将API接口、服务逻辑、数据模型和具体实现分离，便于维护和扩展。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;API接口层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[v1/mcp_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B[v1/mcp_chat.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[v1/mcp_agent.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[v1/mcp_stdio_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;服务逻辑层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[api/services/mcp_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[api/services/mcp_chat.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[api/services/mcp_agent.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[api/services/mcp_user_config.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I[api/services/mcp_stdio_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;核心管理层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J[services/mcp/manager.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K[services/mcp/multi_client.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据模型层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L[database/models/mcp_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">M[schema/mcp.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;MCP实现层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N[mcp_servers/lark_mcp/]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">O[mcp_servers/weather/]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">P[mcp_servers/arxiv/]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;配置层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Q[config/mcp_server.json]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J --&gt; K</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">O --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">P --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Q --&gt; E</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_server.py" target="_blank" rel="noreferrer">v1/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">api/services/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py" target="_blank" rel="noreferrer">database/models/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/mcp.py" target="_blank" rel="noreferrer">schema/mcp.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json" target="_blank" rel="noreferrer">config/mcp_server.json</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/" target="_blank" rel="noreferrer">src/backend/agentchat/</a></li></ul><h2 id="核心组件" tabindex="-1">核心组件 <a class="header-anchor" href="#核心组件" aria-label="Permalink to &quot;核心组件&quot;">​</a></h2><p>MCP服务API的核心组件包括MCP服务器管理、MCP聊天代理、MCP用户配置和MCP标准IO服务器等服务。这些组件共同构成了MCP系统的功能基础，实现了从服务注册到实际调用的完整流程。</p><p>MCP服务器管理服务（MCPService）负责处理MCP服务器的创建、更新、删除和查询操作，是MCP系统的核心管理组件。MCP聊天代理服务（MCPChatAgent）则负责与MCP服务器进行实际交互，处理用户的请求并返回结果。MCP用户配置服务（MCPUserConfigService）管理用户特定的配置信息，而MCP标准IO服务器服务（MCPServerService）则专门处理通过标准输入输出方式连接的MCP服务器。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_user_config.py" target="_blank" rel="noreferrer">mcp_user_config.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_stdio_server.py" target="_blank" rel="noreferrer">mcp_stdio_server.py</a></li></ul><h2 id="架构概述" tabindex="-1">架构概述 <a class="header-anchor" href="#架构概述" aria-label="Permalink to &quot;架构概述&quot;">​</a></h2><p>MCP服务API采用分层架构设计，从上到下分为API接口层、服务逻辑层、核心管理层、数据模型层和MCP实现层。这种分层设计确保了系统的高内聚低耦合特性，使得各组件能够独立开发和维护。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;前端&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[用户界面]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;API接口层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B[/mcp_server]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[/mcp_chat]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[/mcp_agent]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[/mcp_stdio_server]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;服务逻辑层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[MCPService]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[MCPChatAgent]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[MCPAgentService]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I[MCPServerService]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;核心管理层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J[MCPManager]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K[MultiServerMCPClient]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据访问层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L[MCPServerDao]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">M[MCPUserConfigDao]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据存储&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N[数据库]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;MCP实现&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">O[Lark-MCP]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">P[Weather-MCP]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Q[Arxiv-MCP]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J --&gt; K</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K --&gt; O</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K --&gt; P</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K --&gt; Q</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L --&gt; N</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">M --&gt; N</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_server.py" target="_blank" rel="noreferrer">v1/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_chat.py" target="_blank" rel="noreferrer">v1/mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_agent.py" target="_blank" rel="noreferrer">v1/mcp_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_stdio_server.py" target="_blank" rel="noreferrer">v1/mcp_stdio_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">api/services/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">api/services/mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_agent.py" target="_blank" rel="noreferrer">api/services/mcp_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_stdio_server.py" target="_blank" rel="noreferrer">api/services/mcp_stdio_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/mcp_server.py" target="_blank" rel="noreferrer">database/dao/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/mcp_user_config.py" target="_blank" rel="noreferrer">database/dao/mcp_user_config.py</a></li></ul><h2 id="详细组件分析" tabindex="-1">详细组件分析 <a class="header-anchor" href="#详细组件分析" aria-label="Permalink to &quot;详细组件分析&quot;">​</a></h2><h3 id="mcp服务器管理分析" tabindex="-1">MCP服务器管理分析 <a class="header-anchor" href="#mcp服务器管理分析" aria-label="Permalink to &quot;MCP服务器管理分析&quot;">​</a></h3><p>MCP服务器管理组件提供了完整的CRUD（创建、读取、更新、删除）操作接口，允许用户注册、发现和管理MCP服务器。该组件通过<code>/api/v1/mcp_server</code>端点暴露RESTful API，支持服务器的注册、查询、更新和删除操作。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPService {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_mcp_server(server_name, user_id, user_name, url, type, config, tools, params, config_enabled, logo_url, mcp_as_tool_name, description)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_mcp_server_from_id(mcp_server_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_mcp_server(mcp_server_id, server_name, url, type, mcp_as_tool_name, description, config, tools, params, logo_url)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_server_from_tool_name(tool_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+delete_server_from_id(mcp_server_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+verify_user_permission(server_id, user_id, action)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_all_servers(user_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_server_need_update()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_mcp_tools_info(server_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_mcp_server_ids_from_name(mcp_servers_name, user_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPServerTable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_server_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+description : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_as_tool_name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+type : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+logo_url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+config : List[dict]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+tools : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+params : List[dict]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+config_enabled : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_time : datetime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPBaseConfig {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+personal_config : Optional[Dict[str, Any]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPSSEConfig {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : Literal[&quot;sse&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+headers : Optional[Dict[str, Any]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+timeout : Optional[float]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+sse_read_timeout : Optional[float]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs : Optional[Dict[str, Any]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPWebsocketConfig {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport : Literal[&quot;websocket&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs : Optional[Dict[str, Any]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPService --&gt; MCPServerTable : &quot;操作&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPService --&gt; MCPBaseConfig : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPSSEConfig --|&gt; MCPBaseConfig : &quot;继承&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPWebsocketConfig --|&gt; MCPBaseConfig : &quot;继承&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py" target="_blank" rel="noreferrer">database/models/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/mcp.py" target="_blank" rel="noreferrer">schema/mcp.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py" target="_blank" rel="noreferrer">database/models/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/mcp.py" target="_blank" rel="noreferrer">schema/mcp.py</a></li></ul><h3 id="mcp聊天代理分析" tabindex="-1">MCP聊天代理分析 <a class="header-anchor" href="#mcp聊天代理分析" aria-label="Permalink to &quot;MCP聊天代理分析&quot;">​</a></h3><p>MCP聊天代理组件负责处理与MCP服务器的实际交互，通过<code>mcp_chat</code>端点接收用户请求，调用相应的MCP服务并返回结果。该组件利用MCPManager来管理多个MCP服务器的连接和调用，实现了对多个MCP服务的并发处理。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 前端 as 前端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant API as /mcp_chat API</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCPChatAgent as MCPChatAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCPManager as MCPManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCPClient as MultiServerMCPClient</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant LarkMCP as Lark-MCP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant WeatherMCP as Weather-MCP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">前端-&gt;&gt;API : POST /mcp_chat</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;MCPChatAgent : 创建实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPChatAgent-&gt;&gt;MCPManager : 初始化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPClient : 建立连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;LarkMCP : 连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;WeatherMCP : 连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient--&gt;&gt;MCPManager : 连接成功</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager--&gt;&gt;MCPChatAgent : 初始化完成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPChatAgent-&gt;&gt;MCPManager : process_query()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPClient : get_tools()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;LarkMCP : 查询工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;WeatherMCP : 查询工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LarkMCP--&gt;&gt;MCPClient : 返回工具列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WeatherMCP--&gt;&gt;MCPClient : 返回工具列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient--&gt;&gt;MCPManager : 返回所有工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager--&gt;&gt;MCPChatAgent : 返回工具信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPChatAgent-&gt;&gt;MCPManager : 调用工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager-&gt;&gt;MCPClient : 并发调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;LarkMCP : 调用工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient-&gt;&gt;WeatherMCP : 调用工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LarkMCP--&gt;&gt;MCPClient : 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WeatherMCP--&gt;&gt;MCPClient : 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient--&gt;&gt;MCPManager : 汇总结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager--&gt;&gt;MCPChatAgent : 返回最终结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPChatAgent--&gt;&gt;API : 返回响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API--&gt;&gt;前端 : 流式响应</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_chat.py" target="_blank" rel="noreferrer">v1/mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py" target="_blank" rel="noreferrer">services/mcp/multi_client.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_chat.py" target="_blank" rel="noreferrer">v1/mcp_chat.py</a></li></ul><h3 id="mcp服务配置与动态加载机制" tabindex="-1">MCP服务配置与动态加载机制 <a class="header-anchor" href="#mcp服务配置与动态加载机制" aria-label="Permalink to &quot;MCP服务配置与动态加载机制&quot;">​</a></h3><p>MCP服务的配置流程和动态加载机制是系统灵活性的关键。系统支持通过配置文件和API两种方式配置MCP服务，其中<code>config/mcp_server.json</code>文件定义了预置的MCP服务，而API则允许用户动态注册新的MCP服务。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始]) --&gt; CheckConfig[&quot;检查配置文件&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckConfig --&gt; ConfigExists{&quot;配置文件存在?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ConfigExists --&gt; |是| LoadConfig[&quot;加载config/mcp_server.json&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ConfigExists --&gt; |否| CreateDefault[&quot;创建默认配置&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LoadConfig --&gt; ParseConfig[&quot;解析配置&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CreateDefault --&gt; ParseConfig</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ParseConfig --&gt; RegisterServers[&quot;注册MCP服务器&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RegisterServers --&gt; InitManager[&quot;初始化MCPManager&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitManager --&gt; LoadTools[&quot;加载MCP工具&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LoadTools --&gt; DynamicRegister[&quot;等待动态注册&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DynamicRegister --&gt; UserRequest[&quot;接收用户请求&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UserRequest --&gt; CheckType{&quot;请求类型?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckType --&gt; |注册新服务| HandleRegister[&quot;处理注册请求&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckType --&gt; |调用服务| HandleCall[&quot;处理调用请求&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HandleRegister --&gt; Validate[&quot;验证服务信息&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validate --&gt; DiscoverTools[&quot;发现服务工具&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DiscoverTools --&gt; StoreConfig[&quot;存储配置&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StoreConfig --&gt; UpdateManager[&quot;更新MCPManager&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UpdateManager --&gt; ReturnSuccess[&quot;返回成功&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HandleCall --&gt; FindServer[&quot;查找MCP服务器&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FindServer --&gt; CallTool[&quot;调用MCP工具&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CallTool --&gt; ReturnResult[&quot;返回结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnSuccess --&gt; End([结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnResult --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json" target="_blank" rel="noreferrer">config/mcp_server.json</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_server.py" target="_blank" rel="noreferrer">v1/mcp_server.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json" target="_blank" rel="noreferrer">config/mcp_server.json</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li></ul><h3 id="内置mcp服务示例分析" tabindex="-1">内置MCP服务示例分析 <a class="header-anchor" href="#内置mcp服务示例分析" aria-label="Permalink to &quot;内置MCP服务示例分析&quot;">​</a></h3><p>系统提供了多个内置MCP服务示例，如Lark-MCP和Weather-MCP，这些示例展示了如何开发和集成MCP服务。这些服务遵循MCP协议标准，通过FastMCP框架实现，能够与主系统无缝集成。</p><h4 id="lark-mcp服务分析" tabindex="-1">Lark-MCP服务分析 <a class="header-anchor" href="#lark-mcp服务分析" aria-label="Permalink to &quot;Lark-MCP服务分析&quot;">​</a></h4><p>Lark-MCP服务是一个典型的MCP实现，它通过飞书API提供日历、聊天、文档等企业协作功能。该服务使用Starlette框架构建Web应用，通过SSE（Server-Sent Events）协议与主系统通信。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class LarkMCP {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+main.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_server.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_tool/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class main {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+app : Starlette</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp : FastMCP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+health_check()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class mcp_server {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+register_mcp_server(mcp)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class mcp_tool {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+calendar/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+calendar_event/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+chat_member/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+document/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+folder/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+message/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_info/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+utils/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LarkMCP --&gt; main</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LarkMCP --&gt; mcp_server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LarkMCP --&gt; mcp_tool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">main --&gt; mcp_server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mcp_server --&gt; main.mcp</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py" target="_blank" rel="noreferrer">mcp_servers/lark_mcp/main.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/mcp_server.py" target="_blank" rel="noreferrer">mcp_servers/lark_mcp/mcp_server.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py" target="_blank" rel="noreferrer">mcp_servers/lark_mcp/main.py</a></li></ul><h4 id="weather-mcp服务分析" tabindex="-1">Weather-MCP服务分析 <a class="header-anchor" href="#weather-mcp服务分析" aria-label="Permalink to &quot;Weather-MCP服务分析&quot;">​</a></h4><p>Weather-MCP服务是一个简单的天气查询服务，它展示了如何通过HTTP API调用外部服务并返回结构化结果。该服务使用标准输入输出（stdio）方式与主系统通信，适合运行在本地环境。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPWeather {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_weather.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class mcp_weather {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp : FastMCP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+weather_api_key : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+weather_endpoint : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_weather(location)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+WEATHER_PROMPT : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+MESSAGE_PROMPT : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPWeather --&gt; mcp_weather</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mcp_weather : @mcp.tool()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mcp_weather : get_weather(location)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py" target="_blank" rel="noreferrer">mcp_servers/weather/mcp_weather.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py" target="_blank" rel="noreferrer">mcp_servers/weather/mcp_weather.py</a></li></ul><h2 id="依赖分析" tabindex="-1">依赖分析 <a class="header-anchor" href="#依赖分析" aria-label="Permalink to &quot;依赖分析&quot;">​</a></h2><p>MCP服务API的组件之间存在复杂的依赖关系，这些依赖关系确保了系统的功能完整性和数据一致性。通过分析这些依赖，可以更好地理解系统的架构和工作原理。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[v1/mcp_server.py] --&gt; B[api/services/mcp_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; C[schema/mcp.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; D[database/dao/mcp_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; E[services/mcp/manager.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; F[database/models/mcp_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[v1/mcp_chat.py] --&gt; H[api/services/mcp_chat.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I[services/mcp/manager.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; J[api/services/history.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; K[api/services/rag_handler.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L[v1/mcp_agent.py] --&gt; M[api/services/mcp_agent.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">M --&gt; N[database/dao/mcp_agent.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">O[v1/mcp_stdio_server.py] --&gt; P[api/services/mcp_stdio_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">P --&gt; Q[database/dao/mcp_stdio_server.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; R[services/mcp/multi_client.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">R --&gt; S[mcp_servers/lark_mcp/main.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">R --&gt; T[mcp_servers/weather/mcp_weather.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; U[config/mcp_server.json]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; V[api/services/llm.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style A fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style G fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style L fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style O fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style B fill:#bbf,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style H fill:#bbf,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style M fill:#bbf,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style P fill:#bbf,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style I fill:#f96,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style R fill:#f96,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style D fill:#6f9,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style Q fill:#6f9,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style F fill:#696,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style S fill:#9f9,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style T fill:#9f9,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style U fill:#ff9,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef api fill:#f9f,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef service fill:#bbf,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef manager fill:#f96,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef dao fill:#6f9,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef model fill:#696,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef mcp fill:#9f9,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDef config fill:#ff9,stroke:#333,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class A,G,L,O api</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class B,H,M,P service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class I,R manager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class D,Q dao</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class F model</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class S,T mcp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class U config</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p><strong>图源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_server.py" target="_blank" rel="noreferrer">v1/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_chat.py" target="_blank" rel="noreferrer">v1/mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_agent.py" target="_blank" rel="noreferrer">v1/mcp_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_stdio_server.py" target="_blank" rel="noreferrer">v1/mcp_stdio_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">api/services/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">api/services/mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_agent.py" target="_blank" rel="noreferrer">api/services/mcp_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_stdio_server.py" target="_blank" rel="noreferrer">api/services/mcp_stdio_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py" target="_blank" rel="noreferrer">services/mcp/multi_client.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/mcp_server.py" target="_blank" rel="noreferrer">database/dao/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/mcp_stdio_server.py" target="_blank" rel="noreferrer">database/dao/mcp_stdio_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py" target="_blank" rel="noreferrer">database/models/mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py" target="_blank" rel="noreferrer">mcp_servers/lark_mcp/main.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py" target="_blank" rel="noreferrer">mcp_servers/weather/mcp_weather.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json" target="_blank" rel="noreferrer">config/mcp_server.json</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/" target="_blank" rel="noreferrer">src/backend/agentchat/api/v1/</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/" target="_blank" rel="noreferrer">src/backend/agentchat/api/services/</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/" target="_blank" rel="noreferrer">src/backend/agentchat/services/mcp/</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/" target="_blank" rel="noreferrer">src/backend/agentchat/database/dao/</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/" target="_blank" rel="noreferrer">src/backend/agentchat/database/models/</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/" target="_blank" rel="noreferrer">src/backend/agentchat/mcp_servers/</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/" target="_blank" rel="noreferrer">src/backend/agentchat/config/</a></li></ul><h2 id="性能考虑" tabindex="-1">性能考虑 <a class="header-anchor" href="#性能考虑" aria-label="Permalink to &quot;性能考虑&quot;">​</a></h2><p>MCP服务API在设计时充分考虑了性能因素，采用了多种优化策略来确保系统的高效运行。系统通过异步IO和并发处理来提高响应速度，利用缓存机制减少重复计算，并通过连接池管理来优化资源使用。</p><p>在MCPManager中，系统使用<code>asyncio.gather</code>来并发执行多个MCP工具调用，这大大提高了多工具调用的效率。同时，系统还实现了工具列表的缓存，避免了每次调用都需要重新发现工具的开销。对于频繁访问的MCP服务器配置信息，系统也采用了内存缓存策略，减少了数据库查询的次数。</p><p>此外，系统支持SSE（Server-Sent Events）和WebSocket等流式传输协议，能够实现低延迟的实时通信。对于需要处理大量数据的场景，系统还提供了流式响应支持，避免了内存溢出的风险。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py" target="_blank" rel="noreferrer">services/mcp/manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">api/services/mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/mcp_chat.py" target="_blank" rel="noreferrer">v1/mcp_chat.py</a></li></ul><h2 id="故障排除指南" tabindex="-1">故障排除指南 <a class="header-anchor" href="#故障排除指南" aria-label="Permalink to &quot;故障排除指南&quot;">​</a></h2><p>在使用MCP服务API时，可能会遇到各种问题。以下是一些常见问题及其解决方案：</p><ol><li><p><strong>MCP服务器注册失败</strong>：检查URL是否正确，确保MCP服务器正在运行并可访问。如果需要认证，确保在配置中提供了正确的API密钥。</p></li><li><p><strong>MCP工具调用超时</strong>：检查网络连接，确保MCP服务器响应时间在合理范围内。可以通过增加超时设置来解决此问题。</p></li><li><p><strong>权限错误</strong>：确保用户具有操作MCP服务器的权限。普通用户只能管理自己创建的服务器，而管理员用户可以管理所有服务器。</p></li><li><p><strong>配置信息丢失</strong>：检查<code>config/mcp_server.json</code>文件是否正确，确保所有必需的配置项都已提供。</p></li><li><p><strong>工具发现失败</strong>：确保MCP服务器正确实现了MCP协议，暴露了正确的工具列表端点。</p></li></ol><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_chat.py" target="_blank" rel="noreferrer">mcp_chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_user_config.py" target="_blank" rel="noreferrer">mcp_user_config.py</a></li></ul><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>MCP服务API为AgentChat系统提供了一个强大而灵活的扩展机制，通过模块化能力提供者的方式，极大地扩展了Agent的功能边界。该系统设计精良，具有清晰的分层架构和良好的可扩展性，支持多种通信协议和部署方式。</p><p>通过MCP协议，系统能够无缝集成各种外部服务，从企业协作工具到天气查询服务，再到学术文献检索，展现了其强大的适应能力。系统的配置流程和动态加载机制使得新服务的集成变得简单快捷，而丰富的内置服务示例则为开发者提供了良好的参考。</p><p>未来，可以进一步优化MCP服务的发现和注册机制，增加服务健康检查功能，并提供更完善的监控和日志系统，以提高系统的可靠性和可维护性。</p>`,84)])])}const b=a(p,[["render",l]]);export{g as __pageData,b as default};
