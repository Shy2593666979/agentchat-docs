import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.D0TaUBpX.js";const k=JSON.parse('{"title":"输入验证与防注入安全机制","description":"","frontmatter":{},"headers":[],"relativePath":"安全考虑/API安全/输入验证与防注入.md","filePath":"安全考虑/API安全/输入验证与防注入.md","lastUpdated":1764244560000}'),l={name:"安全考虑/API安全/输入验证与防注入.md"};function p(t,s,r,h,E,c){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="输入验证与防注入安全机制" tabindex="-1">输入验证与防注入安全机制 <a class="header-anchor" href="#输入验证与防注入安全机制" aria-label="Permalink to &quot;输入验证与防注入安全机制&quot;">​</a></h1><cite> **本文档引用的文件** - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/tool.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/tool.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/tool.py) - [pyodide.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py) - [white_list_middleware.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py) - [settings.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py) - [tool.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/tool.json) - [test_tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/test/test_tool.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#系统架构概览">系统架构概览</a></li><li><a href="#pydantic模型验证机制">Pydantic模型验证机制</a></li><li><a href="#白名单中间件安全控制">白名单中间件安全控制</a></li><li><a href="#沙箱安全隔离机制">沙箱安全隔离机制</a></li><li><a href="#代码执行安全防护">代码执行安全防护</a></li><li><a href="#常见攻击防护策略">常见攻击防护策略</a></li><li><a href="#最佳实践指南">最佳实践指南</a></li><li><a href="#总结">总结</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>AgentChat系统是一个复杂的AI代理平台，其中工具调用API的安全性至关重要。本文档深入分析了系统中针对工具调用API的输入验证与防注入安全机制，包括结构化验证、权限控制、沙箱隔离等多个层面的安全防护措施。</p><h2 id="系统架构概览" tabindex="-1">系统架构概览 <a class="header-anchor" href="#系统架构概览" aria-label="Permalink to &quot;系统架构概览&quot;">​</a></h2><p>AgentChat系统采用分层安全架构，通过多道防线确保代码执行的安全性：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;前端层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UI[用户界面]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validation[前端验证]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;API网关层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Router[路由处理器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware[中间件]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WhiteList[白名单检查]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;业务逻辑层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service[服务层]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Schema[数据验证]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Permission[权限检查]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;安全执行层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox[沙箱环境]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Isolation[进程隔离]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionControl[权限控制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;资源层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FileSystem[文件系统]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Network[网络访问]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Memory[内存管理]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UI --&gt; Router</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validation --&gt; Router</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Router --&gt; Middleware</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Middleware --&gt; WhiteList</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WhiteList --&gt; Service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service --&gt; Schema</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Schema --&gt; Permission</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Permission --&gt; Sandbox</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox --&gt; Isolation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Isolation --&gt; PermissionControl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionControl --&gt; FileSystem</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionControl --&gt; Network</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionControl --&gt; Memory</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/tool.py#L1-L86" target="_blank" rel="noreferrer">tool.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py#L1-L50" target="_blank" rel="noreferrer">white_list_middleware.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L1-L737" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="pydantic模型验证机制" tabindex="-1">Pydantic模型验证机制 <a class="header-anchor" href="#pydantic模型验证机制" aria-label="Permalink to &quot;Pydantic模型验证机制&quot;">​</a></h2><h3 id="结构化输入验证" tabindex="-1">结构化输入验证 <a class="header-anchor" href="#结构化输入验证" aria-label="Permalink to &quot;结构化输入验证&quot;">​</a></h3><p>系统通过Pydantic模型对用户提交的工具创建和更新请求进行严格的结构化验证：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class ToolCreateRequest {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str zh_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str en_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+validate_length()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+validate_format()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class ToolUpdateRequest {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str tool_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[str] zh_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[str] en_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[str] description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[str] logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+validate_optional_fields()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class BaseModel {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&lt;abstract&gt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Field() validation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+validate() bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ToolCreateRequest --|&gt; BaseModel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ToolUpdateRequest --|&gt; BaseModel</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/tool.py#L5-L16" target="_blank" rel="noreferrer">tool.py</a></li></ul><h3 id="验证规则详解" tabindex="-1">验证规则详解 <a class="header-anchor" href="#验证规则详解" aria-label="Permalink to &quot;验证规则详解&quot;">​</a></h3><table tabindex="0"><thead><tr><th>字段</th><th>验证规则</th><th>安全目的</th></tr></thead><tbody><tr><td>zh_name</td><td>min_length=2, max_length=10</td><td>限制中文名称长度，防止缓冲区溢出</td></tr><tr><td>en_name</td><td>min_length=2, max_length=10</td><td>限制英文名称长度，确保格式一致性</td></tr><tr><td>description</td><td>max_length=300</td><td>控制描述长度，防止超长输入</td></tr><tr><td>logo_url</td><td>无特殊限制</td><td>URL验证由FastAPI自动处理</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/tool.py#L5-L16" target="_blank" rel="noreferrer">tool.py</a></li></ul><h3 id="服务层验证逻辑" tabindex="-1">服务层验证逻辑 <a class="header-anchor" href="#服务层验证逻辑" aria-label="Permalink to &quot;服务层验证逻辑&quot;">​</a></h3><p>工具服务层实现了完整的权限验证和数据验证流程：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as 客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant API as API层</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Service as 服务层</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant DB as 数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Validator as 验证器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;API : 提交工具请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Validator : Pydantic验证</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validator--&gt;&gt;API : 验证结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Service : 调用服务方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;Service : 权限检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;DB : 数据操作</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB--&gt;&gt;Service : 操作结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service--&gt;&gt;API : 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API--&gt;&gt;Client : 响应</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/tool.py#L12-L40" target="_blank" rel="noreferrer">tool.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/tool.py#L13-L86" target="_blank" rel="noreferrer">tool.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/tool.py#L12-L124" target="_blank" rel="noreferrer">tool.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/tool.py#L13-L86" target="_blank" rel="noreferrer">tool.py</a></li></ul><h2 id="白名单中间件安全控制" tabindex="-1">白名单中间件安全控制 <a class="header-anchor" href="#白名单中间件安全控制" aria-label="Permalink to &quot;白名单中间件安全控制&quot;">​</a></h2><h3 id="ip过滤机制" tabindex="-1">IP过滤机制 <a class="header-anchor" href="#ip过滤机制" aria-label="Permalink to &quot;IP过滤机制&quot;">​</a></h3><p>白名单中间件提供了基于路径的访问控制机制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([请求开始]) --&gt; InitCheck{中间件初始化?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitCheck --&gt; |否| LoadConfig[加载配置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitCheck --&gt; |是| PathCheck[路径检查]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LoadConfig --&gt; PathCheck</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PathCheck --&gt; ExactMatch{精确匹配?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExactMatch --&gt; |是| AllowAccess[允许访问]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExactMatch --&gt; |否| PrefixCheck[前缀匹配]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PrefixCheck --&gt; PrefixMatch{前缀匹配?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PrefixMatch --&gt; |是| AllowAccess</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PrefixMatch --&gt; |否| DenyAccess[拒绝访问]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AllowAccess --&gt; NextMiddleware[下一个中间件]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DenyAccess --&gt; ErrorResponse[返回错误]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NextMiddleware --&gt; End([请求结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ErrorResponse --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py#L23-L30" target="_blank" rel="noreferrer">white_list_middleware.py</a></li></ul><h3 id="路径匹配策略" tabindex="-1">路径匹配策略 <a class="header-anchor" href="#路径匹配策略" aria-label="Permalink to &quot;路径匹配策略&quot;">​</a></h3><p>白名单中间件支持多种路径匹配模式：</p><table tabindex="0"><thead><tr><th>匹配类型</th><th>示例</th><th>用途</th></tr></thead><tbody><tr><td>精确匹配</td><td><code>/api/v1/tool/create</code></td><td>关键API端点保护</td></tr><tr><td>前缀匹配</td><td><code>/api/v1/tool/*</code></td><td>整个工具模块保护</td></tr><tr><td>通配符匹配</td><td><code>/api/v1/*/create</code></td><td>动态路径保护</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py#L7-L31" target="_blank" rel="noreferrer">white_list_middleware.py</a></li></ul><h3 id="中间件配置" tabindex="-1">中间件配置 <a class="header-anchor" href="#中间件配置" aria-label="Permalink to &quot;中间件配置&quot;">​</a></h3><p>中间件通过应用设置动态加载白名单配置：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class WhitelistChecker {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Set[str] exact_paths</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[str] prefix_paths</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(whitelist_paths)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+is_whitelisted(path) bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class WhitelistMiddleware {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[WhitelistChecker] whitelist_checker</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+dispatch(request, call_next)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class Settings {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[str] whitelist_paths</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+load_configuration()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WhitelistMiddleware --&gt; WhitelistChecker</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WhitelistChecker --&gt; Settings</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py#L7-L50" target="_blank" rel="noreferrer">white_list_middleware.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py#L14" target="_blank" rel="noreferrer">settings.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py#L33-L50" target="_blank" rel="noreferrer">white_list_middleware.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py#L14" target="_blank" rel="noreferrer">settings.py</a></li></ul><h2 id="沙箱安全隔离机制" tabindex="-1">沙箱安全隔离机制 <a class="header-anchor" href="#沙箱安全隔离机制" aria-label="Permalink to &quot;沙箱安全隔离机制&quot;">​</a></h2><h3 id="deno沙箱架构" tabindex="-1">Deno沙箱架构 <a class="header-anchor" href="#deno沙箱架构" aria-label="Permalink to &quot;Deno沙箱架构&quot;">​</a></h3><p>AgentChat系统采用Deno作为Python代码执行的沙箱环境，提供强大的安全隔离能力：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;主机系统&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HostOS[操作系统]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Python[Python代码]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Network[网络接口]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FileSystem[文件系统]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;Deno运行时&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DenoProcess[Deno进程]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Pyodide[Pyodide引擎]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WASM[WebAssembly]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;安全边界&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionFlags[权限标志]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ProcessIsolation[进程隔离]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ResourceLimits[资源限制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Python --&gt; DenoProcess</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DenoProcess --&gt; PermissionFlags</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionFlags --&gt; ProcessIsolation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ProcessIsolation --&gt; ResourceLimits</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ResourceLimits --&gt; Pyodide</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Pyodide --&gt; WASM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WASM --&gt; HostOS</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L67-L88" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="权限控制系统" tabindex="-1">权限控制系统 <a class="header-anchor" href="#权限控制系统" aria-label="Permalink to &quot;权限控制系统&quot;">​</a></h3><p>沙箱提供了细粒度的权限控制机制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class BasePyodideSandbox {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+bool stateful</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[str] permissions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(allow_env, allow_read, allow_write, allow_net, allow_run, allow_ffi)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+build_permission_flag(flag, value)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class PyodideSandboxTool {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+bool stateful</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+list[str]|bool allow_net</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+float timeout_seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+execute(code, timeout_seconds)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_run(code, state, tool_call_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class CodeExecutionResult {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Any result</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str stdout</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str stderr</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Status status</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+float execution_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BasePyodideSandbox --&gt; PyodideSandboxTool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PyodideSandboxTool --&gt; CodeExecutionResult</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L66-L159" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L508-L532" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="默认安全配置" tabindex="-1">默认安全配置 <a class="header-anchor" href="#默认安全配置" aria-label="Permalink to &quot;默认安全配置&quot;">​</a></h3><p>系统采用最小权限原则，默认禁用所有危险权限：</p><table tabindex="0"><thead><tr><th>权限类型</th><th>默认配置</th><th>安全级别</th></tr></thead><tbody><tr><td>allow_env</td><td>False</td><td>最高安全</td></tr><tr><td>allow_read</td><td>[&quot;node_modules&quot;]</td><td>受限访问</td></tr><tr><td>allow_write</td><td>[&quot;node_modules&quot;]</td><td>受限访问</td></tr><tr><td>allow_net</td><td>False</td><td>禁用网络</td></tr><tr><td>allow_run</td><td>False</td><td>禁用子进程</td></tr><tr><td>allow_ffi</td><td>False</td><td>禁用FFI</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L177-L186" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="代码执行安全防护" tabindex="-1">代码执行安全防护 <a class="header-anchor" href="#代码执行安全防护" aria-label="Permalink to &quot;代码执行安全防护&quot;">​</a></h2><h3 id="执行时间限制" tabindex="-1">执行时间限制 <a class="header-anchor" href="#执行时间限制" aria-label="Permalink to &quot;执行时间限制&quot;">​</a></h3><p>系统为代码执行设置了严格的时间限制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant User as 用户</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Tool as 沙箱工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Sandbox as 沙箱环境</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Timer as 计时器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User-&gt;&gt;Tool : 提交代码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Tool-&gt;&gt;Sandbox : 创建执行进程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Timer : 启动计时器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Sandbox : 执行代码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Timer-&gt;&gt;Timer : 检查超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alt 执行超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Timer-&gt;&gt;Sandbox : 终止进程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox--&gt;&gt;Tool : 返回超时错误</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">else 正常执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox--&gt;&gt;Tool : 返回执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Tool--&gt;&gt;User : 返回结果</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L296-L337" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="内存使用监控" tabindex="-1">内存使用监控 <a class="header-anchor" href="#内存使用监控" aria-label="Permalink to &quot;内存使用监控&quot;">​</a></h3><p>沙箱环境支持内存使用限制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始执行]) --&gt; CheckMemory{检查内存限制}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckMemory --&gt; |启用| SetLimit[设置V8内存限制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckMemory --&gt; |禁用| Execute[直接执行]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SetLimit --&gt; Execute</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Execute --&gt; Monitor[监控内存使用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Monitor --&gt; MemoryOK{内存正常?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MemoryOK --&gt; |是| Continue[继续执行]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MemoryOK --&gt; |超限| KillProcess[终止进程]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Continue --&gt; Success[执行成功]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KillProcess --&gt; MemoryError[内存不足错误]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Success --&gt; End([结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MemoryError --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L226-L229" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L257-L346" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L355-L442" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="常见攻击防护策略" tabindex="-1">常见攻击防护策略 <a class="header-anchor" href="#常见攻击防护策略" aria-label="Permalink to &quot;常见攻击防护策略&quot;">​</a></h2><h3 id="命令注入防护" tabindex="-1">命令注入防护 <a class="header-anchor" href="#命令注入防护" aria-label="Permalink to &quot;命令注入防护&quot;">​</a></h3><p>系统通过以下机制防止命令注入攻击：</p><ol><li><strong>进程隔离</strong>：使用子进程执行代码，避免直接调用系统命令</li><li><strong>权限限制</strong>：默认禁用<code>allow_run</code>权限</li><li><strong>参数验证</strong>：严格验证所有输入参数</li></ol><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Input[用户输入] --&gt; Validate[参数验证]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validate --&gt; Sanitize[输入清理]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sanitize --&gt; Sandbox[沙箱执行]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox --&gt; Output[安全输出]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;防护措施&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ProcessIsolation[进程隔离]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PermissionControl[权限控制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Timeout[超时控制]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox -.-&gt; ProcessIsolation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox -.-&gt; PermissionControl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox -.-&gt; Timeout</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L394-L403" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="xss防护策略" tabindex="-1">XSS防护策略 <a class="header-anchor" href="#xss防护策略" aria-label="Permalink to &quot;XSS防护策略&quot;">​</a></h3><p>虽然主要关注后端安全，但前端也实现了相应的防护措施：</p><table tabindex="0"><thead><tr><th>防护层级</th><th>实现方式</th><th>安全效果</th></tr></thead><tbody><tr><td>前端验证</td><td>JSON解析优化</td><td>防止恶意脚本注入</td></tr><tr><td>后端验证</td><td>Pydantic模型</td><td>结构化数据验证</td></tr><tr><td>中间件过滤</td><td>白名单机制</td><td>访问控制</td></tr><tr><td>沙箱隔离</td><td>进程隔离</td><td>代码执行隔离</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L394-L403" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="网络安全防护" tabindex="-1">网络安全防护 <a class="header-anchor" href="#网络安全防护" aria-label="Permalink to &quot;网络安全防护&quot;">​</a></h3><p>对于网络访问控制，系统提供了灵活的配置选项：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;网络访问控制&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DisableNet[禁用网络]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AllowSpecific[允许特定域名]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AllowAll[允许所有网络]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;安全考虑&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InternalRisk[内部网络风险]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExternalRisk[外部威胁]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DataLeakage[数据泄露风险]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DisableNet --&gt; InternalRisk</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AllowSpecific --&gt; ExternalRisk</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AllowAll --&gt; DataLeakage</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L138-L143" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L549-L554" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="最佳实践指南" tabindex="-1">最佳实践指南 <a class="header-anchor" href="#最佳实践指南" aria-label="Permalink to &quot;最佳实践指南&quot;">​</a></h2><h3 id="开发阶段安全实践" tabindex="-1">开发阶段安全实践 <a class="header-anchor" href="#开发阶段安全实践" aria-label="Permalink to &quot;开发阶段安全实践&quot;">​</a></h3><ol><li><p><strong>输入验证</strong></p><ul><li>使用Pydantic模型进行结构化验证</li><li>设置合理的长度和格式限制</li><li>实施类型检查和范围验证</li></ul></li><li><p><strong>权限设计</strong></p><ul><li>遵循最小权限原则</li><li>明确区分不同级别的访问权限</li><li>实施细粒度的权限控制</li></ul></li><li><p><strong>代码审查</strong></p><ul><li>定期审查安全配置</li><li>测试边界条件和异常情况</li><li>验证权限控制的有效性</li></ul></li></ol><h3 id="运维阶段安全实践" tabindex="-1">运维阶段安全实践 <a class="header-anchor" href="#运维阶段安全实践" aria-label="Permalink to &quot;运维阶段安全实践&quot;">​</a></h3><ol><li><p><strong>监控和审计</strong></p><ul><li>监控异常访问模式</li><li>记录和分析安全事件</li><li>定期评估安全配置</li></ul></li><li><p><strong>更新和维护</strong></p><ul><li>及时更新依赖组件</li><li>应用最新的安全补丁</li><li>优化性能和安全性</li></ul></li><li><p><strong>应急响应</strong></p><ul><li>制定安全事件响应计划</li><li>建立快速修复机制</li><li>进行定期安全演练</li></ul></li></ol><h3 id="配置安全建议" tabindex="-1">配置安全建议 <a class="header-anchor" href="#配置安全建议" aria-label="Permalink to &quot;配置安全建议&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;生产环境配置&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ProdEnv[生产环境]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StrictMode[严格模式]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MinimalPerms[最小权限]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;开发环境配置&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DevEnv[开发环境]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DebugMode[调试模式]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExtendedPerms[扩展权限]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;安全原则&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Principle1[最小权限原则]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Principle2[深度防御]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Principle3[持续监控]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ProdEnv --&gt; StrictMode</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StrictMode --&gt; MinimalPerms</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MinimalPerms --&gt; Principle1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DevEnv --&gt; DebugMode</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DebugMode --&gt; ExtendedPerms</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExtendedPerms --&gt; Principle2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L103-L159" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/middleware/white_list_middleware.py#L33-L50" target="_blank" rel="noreferrer">white_list_middleware.py</a></li></ul><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>AgentChat系统的输入验证与防注入安全机制体现了多层次、全方位的安全防护理念。通过Pydantic模型验证确保输入数据的结构化安全，白名单中间件提供访问控制，沙箱环境实现代码执行隔离，这些措施共同构建了一个安全可靠的工具调用API系统。</p><p>系统的设计充分考虑了安全性与可用性的平衡，在保证功能完整性的同时，最大限度地降低了安全风险。通过持续的安全监控和配置优化，可以进一步提升系统的整体安全水平。</p>`,106)])])}const b=a(l,[["render",p]]);export{k as __pageData,b as default};
