import{_ as a,c as n,o as i,ag as l}from"./chunks/framework.7BqJGZTL.js";const c=JSON.parse('{"title":"沙箱执行安全","description":"","frontmatter":{},"headers":[],"relativePath":"安全考虑/API安全/沙箱执行安全.md","filePath":"安全考虑/API安全/沙箱执行安全.md","lastUpdated":1764244560000}'),e={name:"安全考虑/API安全/沙箱执行安全.md"};function t(p,s,r,h,o,d){return i(),n("div",null,[...s[0]||(s[0]=[l(`<h1 id="沙箱执行安全" tabindex="-1">沙箱执行安全 <a class="header-anchor" href="#沙箱执行安全" aria-label="Permalink to &quot;沙箱执行安全&quot;">​</a></h1><cite> **本文档引用的文件** - [pyodide.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py) - [__init__.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/__init__.py) - [codeact_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/codeact_agent.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#项目结构">项目结构</a></li><li><a href="#核心组件">核心组件</a></li><li><a href="#架构概览">架构概览</a></li><li><a href="#详细组件分析">详细组件分析</a></li><li><a href="#安全机制分析">安全机制分析</a></li><li><a href="#性能考虑">性能考虑</a></li><li><a href="#故障排除指南">故障排除指南</a></li><li><a href="#结论">结论</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>AgentChat中的Pyodide沙箱是一个基于Deno和WebAssembly的安全代码执行环境，专门设计用于在受控环境中执行用户提供的Python代码。该系统通过多层安全机制确保代码执行的安全性，包括细粒度的权限控制、资源限制和执行监控。</p><p>本文档深入分析了BasePyodideSandbox类如何通过Deno的权限控制系统实现细粒度的访问控制，以及PyodideSandbox和SyncPyodideSandbox两个类如何分别提供异步和同步的代码执行能力。同时探讨了内存限制、执行超时等安全防护措施，以及潜在的沙箱逃逸风险和缓解策略。</p><h2 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-label="Permalink to &quot;项目结构&quot;">​</a></h2><p>AgentChat的沙箱系统位于以下目录结构中：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;src/backend/agentchat/services/sandbox/&quot;] --&gt; B[&quot;pyodide.py&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; C[&quot;__init__.py&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[&quot;src/backend/agentchat/core/agents/&quot;] --&gt; E[&quot;codeact_agent.py&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; F[&quot;BasePyodideSandbox&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; G[&quot;PyodideSandbox&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; H[&quot;SyncPyodideSandbox&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; I[&quot;PyodideSandboxTool&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; J[&quot;CodeExecutionResult&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K[&quot;外部依赖&quot;] --&gt; L[&quot;Deno运行时&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K --&gt; M[&quot;Pyodide WebAssembly&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K --&gt; N[&quot;LangChain工具接口&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L1-L737" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/__init__.py#L1-L11" target="_blank" rel="noreferrer"><strong>init</strong>.py</a></li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L1-L50" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/__init__.py#L1-L11" target="_blank" rel="noreferrer"><strong>init</strong>.py</a></li></ul><h2 id="核心组件" tabindex="-1">核心组件 <a class="header-anchor" href="#核心组件" aria-label="Permalink to &quot;核心组件&quot;">​</a></h2><h3 id="basepyodidesandbox基础类" tabindex="-1">BasePyodideSandbox基础类 <a class="header-anchor" href="#basepyodidesandbox基础类" aria-label="Permalink to &quot;BasePyodideSandbox基础类&quot;">​</a></h3><p>BasePyodideSandbox是所有沙箱实现的基础类，提供了通用的初始化和配置逻辑。它定义了六个主要的安全权限参数：</p><ul><li><strong>allow_env</strong>: 控制环境变量访问权限</li><li><strong>allow_read</strong>: 控制文件系统读取权限</li><li><strong>allow_write</strong>: 控制文件系统写入权限</li><li><strong>allow_net</strong>: 控制网络访问权限</li><li><strong>allow_run</strong>: 控制子进程执行权限</li><li><strong>allow_ffi</strong>: 控制外部函数接口权限</li></ul><h3 id="pyodidesandbox和syncpyodidesandbox" tabindex="-1">PyodideSandbox和SyncPyodideSandbox <a class="header-anchor" href="#pyodidesandbox和syncpyodidesandbox" aria-label="Permalink to &quot;PyodideSandbox和SyncPyodideSandbox&quot;">​</a></h3><p>这两个类分别提供异步和同步的代码执行能力：</p><ul><li><strong>PyodideSandbox</strong>: 基于asyncio的异步实现，适合高并发场景</li><li><strong>SyncPyodideSandbox</strong>: 同步阻塞实现，适合传统应用</li></ul><h3 id="codeexecutionresult结果容器" tabindex="-1">CodeExecutionResult结果容器 <a class="header-anchor" href="#codeexecutionresult结果容器" aria-label="Permalink to &quot;CodeExecutionResult结果容器&quot;">​</a></h3><p>CodeExecutionResult类封装了代码执行的所有结果信息，包括：</p><ul><li>执行状态(status)</li><li>输出结果(stdout/stderr)</li><li>执行时间(execution_time)</li><li>会话元数据(session_metadata/session_bytes)</li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L66-L248" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L250-L442" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="架构概览" tabindex="-1">架构概览 <a class="header-anchor" href="#架构概览" aria-label="Permalink to &quot;架构概览&quot;">​</a></h2><p>AgentChat的沙箱执行架构采用分层设计，通过Deno作为中间层实现安全隔离：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as &quot;客户端应用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Sandbox as &quot;PyodideSandbox&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Deno as &quot;Deno子进程&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Pyodide as &quot;Pyodide运行时&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant V8 as &quot;V8引擎&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;Sandbox : execute(code, params)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Sandbox : _build_command()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Deno : subprocess.run(cmd)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Deno-&gt;&gt;Pyodide : 加载Pyodide</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Pyodide-&gt;&gt;V8 : 创建WebAssembly实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">V8-&gt;&gt;V8 : 执行Python代码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">V8--&gt;&gt;Pyodide : 返回执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Pyodide--&gt;&gt;Deno : 序列化结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Deno--&gt;&gt;Sandbox : JSON格式输出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox-&gt;&gt;Sandbox : 解析结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sandbox--&gt;&gt;Client : CodeExecutionResult</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L296-L346" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L392-L442" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="详细组件分析" tabindex="-1">详细组件分析 <a class="header-anchor" href="#详细组件分析" aria-label="Permalink to &quot;详细组件分析&quot;">​</a></h2><h3 id="basepyodidesandbox权限控制系统" tabindex="-1">BasePyodideSandbox权限控制系统 <a class="header-anchor" href="#basepyodidesandbox权限控制系统" aria-label="Permalink to &quot;BasePyodideSandbox权限控制系统&quot;">​</a></h3><p>BasePyodideSandbox通过build_permission_flag函数实现细粒度的权限控制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;权限配置&quot;] --&gt; B{&quot;权限类型&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |allow_env| C[&quot;环境变量权限&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |allow_read| D[&quot;文件读取权限&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |allow_write| E[&quot;文件写入权限&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |allow_net| F[&quot;网络访问权限&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |allow_run| G[&quot;子进程权限&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |allow_ffi| H[&quot;FFI权限&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; I{&quot;配置值类型&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; |True| J[&quot;完全访问&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; |False| K[&quot;无访问&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; |列表| L[&quot;受限访问&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J --&gt; M[&quot;构建权限标志&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L --&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">M --&gt; N[&quot;Deno命令参数&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L42-L64" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L90-L159" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h4 id="权限配置详解" tabindex="-1">权限配置详解 <a class="header-anchor" href="#权限配置详解" aria-label="Permalink to &quot;权限配置详解&quot;">​</a></h4><ol><li><p><strong>allow_env环境变量控制</strong></p><ul><li>False: 完全禁止访问环境变量（最安全）</li><li>True: 允许访问所有环境变量</li><li>列表: 仅允许特定环境变量访问</li></ul></li><li><p><strong>allow_read文件读取控制</strong></p><ul><li>默认情况下自动允许node_modules目录访问</li><li>可以限制到特定路径</li><li>防止恶意代码访问敏感文件系统</li></ul></li><li><p><strong>allow_write文件写入控制</strong></p><ul><li>默认允许写入node_modules目录</li><li>可以限制到特定输出目录</li><li>防止恶意代码修改系统文件</li></ul></li><li><p><strong>allow_net网络访问控制</strong></p><ul><li>支持域名/IP白名单</li><li>可以防止恶意网络通信</li><li>特别适用于需要网络但要限制访问的场景</li></ul></li><li><p><strong>allow_run子进程控制</strong></p><ul><li>False: 完全禁止子进程执行</li><li>True: 允许执行任何命令</li><li>列表: 仅允许特定命令执行</li></ul></li><li><p><strong>allow_ffi外部函数接口控制</strong></p><ul><li>严格限制外部库访问</li><li>防止直接调用系统级API</li><li>保护底层系统安全</li></ul></li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L116-L155" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="异步执行机制" tabindex="-1">异步执行机制 <a class="header-anchor" href="#异步执行机制" aria-label="Permalink to &quot;异步执行机制&quot;">​</a></h3><p>PyodideSandbox类实现了基于asyncio的异步代码执行：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class PyodideSandbox {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+execute(code, session_bytes, timeout_seconds, memory_limit_mb) CodeExecutionResult</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-_build_command(code, session_bytes, session_metadata, memory_limit_mb) str[]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class AsyncSubprocess {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+create_subprocess_exec(cmd) Process</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+wait_for(process, timeout) tuple</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+communicate() tuple</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class CodeExecutionResult {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Any result</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str stdout</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str stderr</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Status status</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+float execution_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+dict session_metadata</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+bytes session_bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PyodideSandbox --&gt; AsyncSubprocess : 使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PyodideSandbox --&gt; CodeExecutionResult : 返回</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L250-L346" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h4 id="异步执行流程" tabindex="-1">异步执行流程 <a class="header-anchor" href="#异步执行流程" aria-label="Permalink to &quot;异步执行流程&quot;">​</a></h4><ol><li><strong>命令构建</strong>: _build_command方法构建Deno执行命令</li><li><strong>进程启动</strong>: asyncio.create_subprocess_exec启动子进程</li><li><strong>超时控制</strong>: asyncio.wait_for设置执行超时</li><li><strong>结果解析</strong>: 解析JSON格式的执行结果</li><li><strong>异常处理</strong>: 处理超时和取消异常</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L257-L346" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="同步执行机制" tabindex="-1">同步执行机制 <a class="header-anchor" href="#同步执行机制" aria-label="Permalink to &quot;同步执行机制&quot;">​</a></h3><p>SyncPyodideSandbox提供同步阻塞的代码执行能力：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;开始执行&quot;] --&gt; B[&quot;_build_command构建命令&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[&quot;subprocess.run执行&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D{&quot;是否超时?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; |是| E[&quot;TimeoutExpired异常&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; |否| F[&quot;正常执行&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[&quot;解析JSON结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; H[&quot;构造CodeExecutionResult&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; I[&quot;设置错误状态&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; J[&quot;返回结果&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L349-L442" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h4 id="同步执行特点" tabindex="-1">同步执行特点 <a class="header-anchor" href="#同步执行特点" aria-label="Permalink to &quot;同步执行特点&quot;">​</a></h4><ol><li><strong>阻塞特性</strong>: 调用期间会阻塞当前线程</li><li><strong>简单可靠</strong>: 不涉及复杂的异步调度</li><li><strong>资源管理</strong>: 自动处理进程生命周期</li><li><strong>异常处理</strong>: 明确的超时和错误处理</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L355-L442" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h3 id="内存和执行限制" tabindex="-1">内存和执行限制 <a class="header-anchor" href="#内存和执行限制" aria-label="Permalink to &quot;内存和执行限制&quot;">​</a></h3><h4 id="内存限制机制" tabindex="-1">内存限制机制 <a class="header-anchor" href="#内存限制机制" aria-label="Permalink to &quot;内存限制机制&quot;">​</a></h4><p>系统通过V8引擎的--max-old-space-size标志实现内存限制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;memory_limit_mb参数&quot;] --&gt; B[&quot;--v8-flags=--max-old-space-size&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[&quot;Deno子进程&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[&quot;V8引擎&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; E[&quot;内存使用监控&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F{&quot;超出限制?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; |是| G[&quot;内存不足错误&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; |否| H[&quot;正常执行&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L226-L228" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h4 id="执行超时控制" tabindex="-1">执行超时控制 <a class="header-anchor" href="#执行超时控制" aria-label="Permalink to &quot;执行超时控制&quot;">​</a></h4><p>两种执行模式都支持超时控制：</p><ul><li><strong>异步模式</strong>: 使用asyncio.wait_for设置超时</li><li><strong>同步模式</strong>: 使用subprocess.run的timeout参数</li><li><strong>统一处理</strong>: 超时后都会终止进程并返回错误信息</li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L226-L229" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L304-L332" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L401-L430" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="安全机制分析" tabindex="-1">安全机制分析 <a class="header-anchor" href="#安全机制分析" aria-label="Permalink to &quot;安全机制分析&quot;">​</a></h2><h3 id="多层安全防护" tabindex="-1">多层安全防护 <a class="header-anchor" href="#多层安全防护" aria-label="Permalink to &quot;多层安全防护&quot;">​</a></h3><p>AgentChat的沙箱系统实现了多层安全防护机制：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;应用层安全&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;权限配置验证&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B[&quot;输入参数检查&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[&quot;状态管理&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;运行时安全&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[&quot;Deno权限控制&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[&quot;WebAssembly隔离&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[&quot;进程隔离&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;资源限制&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[&quot;内存限制&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[&quot;CPU时间限制&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I[&quot;网络带宽限制&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;监控审计&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J[&quot;执行日志记录&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K[&quot;异常检测&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L[&quot;性能监控&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; I</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; K</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; L</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="沙箱逃逸风险与缓解" tabindex="-1">沙箱逃逸风险与缓解 <a class="header-anchor" href="#沙箱逃逸风险与缓解" aria-label="Permalink to &quot;沙箱逃逸风险与缓解&quot;">​</a></h3><h4 id="潜在逃逸风险" tabindex="-1">潜在逃逸风险 <a class="header-anchor" href="#潜在逃逸风险" aria-label="Permalink to &quot;潜在逃逸风险&quot;">​</a></h4><ol><li><strong>权限提升</strong>: 通过恶意代码尝试获取更高权限</li><li><strong>资源耗尽</strong>: 通过无限循环或大量内存分配导致系统崩溃</li><li><strong>信息泄露</strong>: 通过侧信道攻击获取敏感信息</li><li><strong>拒绝服务</strong>: 通过恶意代码消耗系统资源</li></ol><h4 id="缓解措施" tabindex="-1">缓解措施 <a class="header-anchor" href="#缓解措施" aria-label="Permalink to &quot;缓解措施&quot;">​</a></h4><ol><li><strong>严格的权限控制</strong>: 默认禁用所有权限，按需启用</li><li><strong>资源限制</strong>: 设置内存和执行时间上限</li><li><strong>进程隔离</strong>: 使用独立的Deno子进程</li><li><strong>输入验证</strong>: 对传入代码进行基本的安全检查</li><li><strong>输出过滤</strong>: 过滤敏感信息的输出</li></ol><h3 id="最佳实践配置" tabindex="-1">最佳实践配置 <a class="header-anchor" href="#最佳实践配置" aria-label="Permalink to &quot;最佳实践配置&quot;">​</a></h3><h4 id="生产环境推荐配置" tabindex="-1">生产环境推荐配置 <a class="header-anchor" href="#生产环境推荐配置" aria-label="Permalink to &quot;生产环境推荐配置&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 最高安全性配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sandbox </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PyodideSandbox(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    stateful</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_write</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_net</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_ffi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    timeout_seconds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    memory_limit_mb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 中等安全性配置（允许网络访问）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sandbox </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PyodideSandbox(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    stateful</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PATH&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_write</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./output&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_net</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;api.example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_ffi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    timeout_seconds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    memory_limit_mb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 开发环境配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sandbox </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PyodideSandbox(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    stateful</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_write</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_net</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    allow_ffi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    timeout_seconds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">120</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    memory_limit_mb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="安全配置原则" tabindex="-1">安全配置原则 <a class="header-anchor" href="#安全配置原则" aria-label="Permalink to &quot;安全配置原则&quot;">​</a></h4><ol><li><strong>最小权限原则</strong>: 只授予必要的最小权限</li><li><strong>深度防御</strong>: 多层安全措施协同工作</li><li><strong>监控审计</strong>: 记录所有执行活动</li><li><strong>定期更新</strong>: 及时更新安全补丁</li><li><strong>备份恢复</strong>: 建立安全的备份和恢复机制</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L67-L88" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L90-L160" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="性能考虑" tabindex="-1">性能考虑 <a class="header-anchor" href="#性能考虑" aria-label="Permalink to &quot;性能考虑&quot;">​</a></h2><h3 id="执行性能优化" tabindex="-1">执行性能优化 <a class="header-anchor" href="#执行性能优化" aria-label="Permalink to &quot;执行性能优化&quot;">​</a></h3><ol><li><strong>进程复用</strong>: stateful模式可以复用Deno进程</li><li><strong>内存管理</strong>: 合理设置内存限制避免频繁GC</li><li><strong>超时控制</strong>: 设置合适的超时时间平衡安全性和性能</li><li><strong>并发控制</strong>: 在高并发场景下合理使用异步模式</li></ol><h3 id="资源使用监控" tabindex="-1">资源使用监控 <a class="header-anchor" href="#资源使用监控" aria-label="Permalink to &quot;资源使用监控&quot;">​</a></h3><p>系统提供了详细的执行时间统计，有助于性能优化：</p><ul><li><strong>execution_time</strong>: 从开始到结束的总执行时间</li><li><strong>内存使用</strong>: 通过V8内存限制监控</li><li><strong>进程开销</strong>: 子进程启动和销毁的开销</li></ul><h3 id="性能调优建议" tabindex="-1">性能调优建议 <a class="header-anchor" href="#性能调优建议" aria-label="Permalink to &quot;性能调优建议&quot;">​</a></h3><ol><li><strong>合理设置超时</strong>: 根据代码复杂度调整timeout_seconds</li><li><strong>内存优化</strong>: 根据实际需求设置memory_limit_mb</li><li><strong>状态管理</strong>: 在需要保持状态时使用stateful模式</li><li><strong>并发控制</strong>: 在高负载场景下使用异步版本</li></ol><h2 id="故障排除指南" tabindex="-1">故障排除指南 <a class="header-anchor" href="#故障排除指南" aria-label="Permalink to &quot;故障排除指南&quot;">​</a></h2><h3 id="常见问题及解决方案" tabindex="-1">常见问题及解决方案 <a class="header-anchor" href="#常见问题及解决方案" aria-label="Permalink to &quot;常见问题及解决方案&quot;">​</a></h3><h4 id="deno安装问题" tabindex="-1">Deno安装问题 <a class="header-anchor" href="#deno安装问题" aria-label="Permalink to &quot;Deno安装问题&quot;">​</a></h4><p><strong>问题</strong>: RuntimeError: Deno is not installed or not in PATH <strong>解决方案</strong>:</p><ul><li>确保Deno已正确安装</li><li>将Deno添加到系统PATH</li><li>或者设置skip_deno_check=True跳过检查</li></ul><h4 id="权限配置问题" tabindex="-1">权限配置问题 <a class="header-anchor" href="#权限配置问题" aria-label="Permalink to &quot;权限配置问题&quot;">​</a></h4><p><strong>问题</strong>: 代码无法访问所需资源 <strong>解决方案</strong>:</p><ul><li>检查权限配置是否正确</li><li>添加必要的allow_*参数</li><li>确认路径和域名配置准确</li></ul><h4 id="内存不足问题" tabindex="-1">内存不足问题 <a class="header-anchor" href="#内存不足问题" aria-label="Permalink to &quot;内存不足问题&quot;">​</a></h4><p><strong>问题</strong>: 执行过程中出现内存不足错误 <strong>解决方案</strong>:</p><ul><li>增加memory_limit_mb设置</li><li>优化代码减少内存使用</li><li>检查是否存在内存泄漏</li></ul><h4 id="执行超时问题" tabindex="-1">执行超时问题 <a class="header-anchor" href="#执行超时问题" aria-label="Permalink to &quot;执行超时问题&quot;">​</a></h4><p><strong>问题</strong>: 代码执行超过设定时间 <strong>解决方案</strong>:</p><ul><li>增加timeout_seconds设置</li><li>优化代码逻辑提高执行效率</li><li>分解复杂任务为多个小任务</li></ul><h3 id="调试技巧" tabindex="-1">调试技巧 <a class="header-anchor" href="#调试技巧" aria-label="Permalink to &quot;调试技巧&quot;">​</a></h3><ol><li><strong>启用详细日志</strong>: 检查stderr输出获取详细错误信息</li><li><strong>简化测试</strong>: 使用简单的代码片段测试沙箱功能</li><li><strong>权限测试</strong>: 逐步增加权限配置定位问题</li><li><strong>资源监控</strong>: 监控内存和CPU使用情况</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L164-L174" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L328-L332" target="_blank" rel="noreferrer">pyodide.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/sandbox/pyodide.py#L428-L430" target="_blank" rel="noreferrer">pyodide.py</a></li></ul><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>AgentChat的Pyodide沙箱系统通过多层次的安全机制，为Python代码执行提供了一个安全可靠的环境。系统的核心优势包括：</p><ol><li><strong>细粒度权限控制</strong>: 通过六个主要权限参数实现精确的访问控制</li><li><strong>双重执行模式</strong>: 同时支持异步和同步两种执行方式</li><li><strong>强大的资源限制</strong>: 内存和执行时间的双重保护</li><li><strong>完善的错误处理</strong>: 全面的异常捕获和错误报告机制</li><li><strong>灵活的状态管理</strong>: 支持有状态和无状态两种执行模式</li></ol><p>该系统特别适用于需要安全执行用户代码的AI应用场景，如代码生成、数据分析和自动化任务等。通过合理的配置和使用，可以在保证安全性的同时提供良好的用户体验和执行性能。</p><p>在实际部署中，建议根据具体的应用场景选择合适的配置参数，并建立完善的监控和审计机制，以确保系统的长期稳定运行。</p>`,117)])])}const E=a(e,[["render",t]]);export{c as __pageData,E as default};
