import{_ as a,c as i,o as n,ag as l}from"./chunks/framework.D0TaUBpX.js";const c=JSON.parse('{"title":"密码哈希与数据加密","description":"","frontmatter":{},"headers":[],"relativePath":"安全考虑/数据安全/密码哈希与数据加密.md","filePath":"安全考虑/数据安全/密码哈希与数据加密.md","lastUpdated":1764244560000}'),e={name:"安全考虑/数据安全/密码哈希与数据加密.md"};function t(p,s,h,r,k,d){return n(),i("div",null,[...s[0]||(s[0]=[l(`<h1 id="密码哈希与数据加密" tabindex="-1">密码哈希与数据加密 <a class="header-anchor" href="#密码哈希与数据加密" aria-label="Permalink to &quot;密码哈希与数据加密&quot;">​</a></h1><cite> **本文档引用的文件** - [src/backend/agentchat/utils/hash.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/utils/hash.py) - [src/backend/agentchat/database/models/user.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py) - [src/backend/agentchat/api/services/user.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/user.py) - [src/backend/agentchat/utils/constants.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/utils/constants.py) - [src/backend/agentchat/services/redis.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/redis.py) - [src/backend/agentchat/settings.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py) - [src/backend/agentchat/config.yaml](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml) - [src/backend/fastapi_jwt_auth/auth_jwt.py](https://github.com/Shy2593666979/AgentChat/src/backend/fastapi_jwt_auth/auth_jwt.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#当前密码哈希机制分析">当前密码哈希机制分析</a></li><li><a href="#数据库中的敏感数据存储">数据库中的敏感数据存储</a></li><li><a href="#安全风险评估">安全风险评估</a></li><li><a href="#升级建议与最佳实践">升级建议与最佳实践</a></li><li><a href="#其他敏感信息的加密存储">其他敏感信息的加密存储</a></li><li><a href="#密钥管理最佳实践">密钥管理最佳实践</a></li><li><a href="#总结与建议">总结与建议</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>AgentChat是一个基于FastAPI构建的智能对话平台，其安全架构涉及用户密码处理、敏感数据存储和密钥管理等多个方面。本文档深入分析当前系统的密码哈希机制，评估其安全性，并提供现代化的安全升级建议。</p><h2 id="当前密码哈希机制分析" tabindex="-1">当前密码哈希机制分析 <a class="header-anchor" href="#当前密码哈希机制分析" aria-label="Permalink to &quot;当前密码哈希机制分析&quot;">​</a></h2><h3 id="md5哈希函数实现" tabindex="-1">MD5哈希函数实现 <a class="header-anchor" href="#md5哈希函数实现" aria-label="Permalink to &quot;MD5哈希函数实现&quot;">​</a></h3><p>系统当前使用简单的MD5哈希算法来处理用户密码：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;用户输入密码&quot;] --&gt; B[&quot;md5_hash函数&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[&quot;MD5算法处理&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[&quot;十六进制字符串输出&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; E[&quot;存储到数据库&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[&quot;密码验证&quot;] --&gt; G[&quot;用户输入密码&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; H[&quot;再次MD5哈希&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I[&quot;与存储的哈希比较&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J{&quot;匹配?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J --&gt; |是| K[&quot;认证成功&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">J --&gt; |否| L[&quot;认证失败&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/utils/hash.py#L3-L6" target="_blank" rel="noreferrer">src/backend/agentchat/utils/hash.py</a></li></ul><h3 id="密码处理流程" tabindex="-1">密码处理流程 <a class="header-anchor" href="#密码处理流程" aria-label="Permalink to &quot;密码处理流程&quot;">​</a></h3><p>系统实现了多种密码处理方法：</p><ol><li><strong>MD5解密密码</strong>：用于处理加密传输的密码</li><li><strong>SHA-256加密密码</strong>：用于密码验证</li><li><strong>密码验证逻辑</strong>：比较加密后的密码</li></ol><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant U as 用户</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant S as 服务端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant D as 数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant R as Redis</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">U-&gt;&gt;S : 提交注册请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;R : 检查RSA密钥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alt RSA密钥存在</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">R--&gt;&gt;S : 返回私钥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;S : 解密密码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;S : MD5哈希处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;D : 存储用户信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D--&gt;&gt;S : 确认存储</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">U-&gt;&gt;S : 登录请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;S : SHA-256加密密码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;D : 查询用户密码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D--&gt;&gt;S : 返回存储的密码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S-&gt;&gt;S : 比较密码哈希</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alt 密码匹配</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S--&gt;&gt;U : 登录成功</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">else 密码不匹配</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">S--&gt;&gt;U : 登录失败</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/user.py#L46-L65" target="_blank" rel="noreferrer">src/backend/agentchat/api/services/user.py</a></li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/utils/hash.py#L1-L6" target="_blank" rel="noreferrer">src/backend/agentchat/utils/hash.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/user.py#L42-L65" target="_blank" rel="noreferrer">src/backend/agentchat/api/services/user.py</a></li></ul><h2 id="数据库中的敏感数据存储" tabindex="-1">数据库中的敏感数据存储 <a class="header-anchor" href="#数据库中的敏感数据存储" aria-label="Permalink to &quot;数据库中的敏感数据存储&quot;">​</a></h2><h3 id="用户模型结构" tabindex="-1">用户模型结构 <a class="header-anchor" href="#用户模型结构" aria-label="Permalink to &quot;用户模型结构&quot;">​</a></h3><p>系统使用SQLModel定义用户模型，其中包含以下关键字段：</p><table tabindex="0"><thead><tr><th>字段名</th><th>类型</th><th>描述</th><th>安全考虑</th></tr></thead><tbody><tr><td>user_id</td><td>str</td><td>主键标识符</td><td>唯一性保证</td></tr><tr><td>user_name</td><td>str</td><td>用户名</td><td>唯一索引，用户名唯一</td></tr><tr><td>user_email</td><td>str</td><td>邮箱地址</td><td>可选字段</td></tr><tr><td>user_avatar</td><td>str</td><td>用户头像</td><td>图片URL存储</td></tr><tr><td>user_description</td><td>str</td><td>用户描述</td><td>默认值：&quot;该用户很懒，没有留下一片云彩&quot;</td></tr><tr><td>user_password</td><td>str</td><td>加密后的用户密码</td><td>敏感数据存储</td></tr><tr><td>delete</td><td>bool</td><td>删除标志</td><td>软删除支持</td></tr><tr><td>create_time</td><td>datetime</td><td>创建时间</td><td>自动时间戳</td></tr><tr><td>update_time</td><td>datetime</td><td>更新时间</td><td>自动时间戳</td></tr></tbody></table><h3 id="数据库设计特点" tabindex="-1">数据库设计特点 <a class="header-anchor" href="#数据库设计特点" aria-label="Permalink to &quot;数据库设计特点&quot;">​</a></h3><ol><li><strong>软删除机制</strong>：通过<code>delete</code>字段实现软删除</li><li><strong>自动时间戳</strong>：<code>create_time</code>和<code>update_time</code>字段自动维护</li><li><strong>唯一约束</strong>：用户名字段具有唯一性约束</li><li><strong>索引优化</strong>：用户名字段建立索引以提高查询效率</li></ol><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py#L18-L43" target="_blank" rel="noreferrer">src/backend/agentchat/database/models/user.py</a></li></ul><h2 id="安全风险评估" tabindex="-1">安全风险评估 <a class="header-anchor" href="#安全风险评估" aria-label="Permalink to &quot;安全风险评估&quot;">​</a></h2><h3 id="md5算法的安全问题" tabindex="-1">MD5算法的安全问题 <a class="header-anchor" href="#md5算法的安全问题" aria-label="Permalink to &quot;MD5算法的安全问题&quot;">​</a></h3><p>当前系统使用MD5作为主要的密码哈希算法，存在以下严重安全风险：</p><h4 id="_1-易受彩虹表攻击" tabindex="-1">1. 易受彩虹表攻击 <a class="header-anchor" href="#_1-易受彩虹表攻击" aria-label="Permalink to &quot;1. 易受彩虹表攻击&quot;">​</a></h4><ul><li><strong>彩虹表攻击原理</strong>：预先计算常见密码的MD5哈希值</li><li><strong>攻击效果</strong>：可快速破解常见密码</li><li><strong>影响范围</strong>：弱密码用户面临高风险</li></ul><h4 id="_2-碰撞攻击风险" tabindex="-1">2. 碰撞攻击风险 <a class="header-anchor" href="#_2-碰撞攻击风险" aria-label="Permalink to &quot;2. 碰撞攻击风险&quot;">​</a></h4><ul><li><strong>数学特性</strong>：MD5存在已知的碰撞攻击方法</li><li><strong>攻击可能性</strong>：理论上可以找到两个不同输入产生相同哈希值</li><li><strong>实际威胁</strong>：虽然技术门槛较高，但仍构成潜在威胁</li></ul><h4 id="_3-缺乏盐值机制" tabindex="-1">3. 缺乏盐值机制 <a class="header-anchor" href="#_3-缺乏盐值机制" aria-label="Permalink to &quot;3. 缺乏盐值机制&quot;">​</a></h4><ul><li><strong>盐值缺失</strong>：当前实现未使用随机盐值</li><li><strong>攻击影响</strong>：相同密码在不同用户间产生相同的哈希值</li><li><strong>防护失效</strong>：无法防止针对特定密码的批量攻击</li></ul><h4 id="_4-无自适应参数" tabindex="-1">4. 无自适应参数 <a class="header-anchor" href="#_4-无自适应参数" aria-label="Permalink to &quot;4. 无自适应参数&quot;">​</a></h4><ul><li><strong>固定成本</strong>：MD5计算成本固定，无法随硬件发展调整</li><li><strong>性能问题</strong>：计算速度过快，便于暴力破解</li><li><strong>资源消耗</strong>：暴力破解攻击成本低</li></ul><h3 id="其他安全隐患" tabindex="-1">其他安全隐患 <a class="header-anchor" href="#其他安全隐患" aria-label="Permalink to &quot;其他安全隐患&quot;">​</a></h3><h4 id="_1-密钥管理问题" tabindex="-1">1. 密钥管理问题 <a class="header-anchor" href="#_1-密钥管理问题" aria-label="Permalink to &quot;1. 密钥管理问题&quot;">​</a></h4><ul><li><strong>硬编码密钥</strong>：配置文件中包含明文API密钥</li><li><strong>环境变量缺失</strong>：缺乏环境变量配置机制</li><li><strong>密钥轮换困难</strong>：现有架构不支持密钥定期轮换</li></ul><h4 id="_2-传输安全" tabindex="-1">2. 传输安全 <a class="header-anchor" href="#_2-传输安全" aria-label="Permalink to &quot;2. 传输安全&quot;">​</a></h4><ul><li><strong>HTTPS依赖</strong>：依赖外部HTTPS保护传输安全</li><li><strong>中间人攻击</strong>：仍可能存在TLS降级攻击风险</li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/utils/hash.py#L1-L6" target="_blank" rel="noreferrer">src/backend/agentchat/utils/hash.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L21-L129" target="_blank" rel="noreferrer">src/backend/agentchat/config.yaml</a></li></ul><h2 id="升级建议与最佳实践" tabindex="-1">升级建议与最佳实践 <a class="header-anchor" href="#升级建议与最佳实践" aria-label="Permalink to &quot;升级建议与最佳实践&quot;">​</a></h2><h3 id="推荐的密码哈希算法" tabindex="-1">推荐的密码哈希算法 <a class="header-anchor" href="#推荐的密码哈希算法" aria-label="Permalink to &quot;推荐的密码哈希算法&quot;">​</a></h3><h4 id="_1-bcrypt算法" tabindex="-1">1. bcrypt算法 <a class="header-anchor" href="#_1-bcrypt算法" aria-label="Permalink to &quot;1. bcrypt算法&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 推荐的bcrypt实现示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bcrypt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash_password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(password: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 自动生成盐值，成本因子12</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    hashed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bcrypt.hashpw(password.encode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), bcrypt.gensalt(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rounds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hashed.decode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verify_password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(password: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, hashed_password: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bcrypt.checkpw(password.encode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), hashed_password.encode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_2-argon2算法" tabindex="-1">2. Argon2算法 <a class="header-anchor" href="#_2-argon2算法" aria-label="Permalink to &quot;2. Argon2算法&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 推荐的Argon2实现示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argon2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PasswordHasher</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ph </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PasswordHasher(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    time_cost</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># CPU成本</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    memory_cost</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">65536</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 内存成本 (KB)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    parallelism</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 并行度</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    hash_len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 哈希长度</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    salt_len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 盐值长度</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash_password_argon2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(password: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ph.hash(password)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verify_password_argon2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(password: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, hashed_password: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ph.verify(hashed_password, password)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="迁移方案" tabindex="-1">迁移方案 <a class="header-anchor" href="#迁移方案" aria-label="Permalink to &quot;迁移方案&quot;">​</a></h3><h4 id="_1-渐进式迁移策略" tabindex="-1">1. 渐进式迁移策略 <a class="header-anchor" href="#_1-渐进式迁移策略" aria-label="Permalink to &quot;1. 渐进式迁移策略&quot;">​</a></h4><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[&quot;开始迁移&quot;] --&gt; B[&quot;启用新算法验证&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[&quot;旧密码验证&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D{&quot;验证成功?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; |是| E[&quot;保持当前密码&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; |否| F[&quot;尝试新算法验证&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G{&quot;新算法验证成功?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; |是| H[&quot;更新密码哈希&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G --&gt; |否| I[&quot;拒绝登录&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; J[&quot;完成迁移&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; J</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; K[&quot;提示重新设置密码&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_2-迁移代码实现要点" tabindex="-1">2. 迁移代码实现要点 <a class="header-anchor" href="#_2-迁移代码实现要点" aria-label="Permalink to &quot;2. 迁移代码实现要点&quot;">​</a></h4><ol><li><strong>双算法验证</strong>：同时支持旧算法和新算法验证</li><li><strong>渐进式更新</strong>：用户登录时自动更新密码哈希</li><li><strong>回退机制</strong>：新算法验证失败时回退到旧算法</li><li><strong>日志记录</strong>：记录迁移过程中的所有操作</li></ol><h3 id="性能优化建议" tabindex="-1">性能优化建议 <a class="header-anchor" href="#性能优化建议" aria-label="Permalink to &quot;性能优化建议&quot;">​</a></h3><h4 id="_1-成本因子调整" tabindex="-1">1. 成本因子调整 <a class="header-anchor" href="#_1-成本因子调整" aria-label="Permalink to &quot;1. 成本因子调整&quot;">​</a></h4><ul><li><strong>bcrypt</strong>：推荐成本因子12-14</li><li><strong>Argon2</strong>：推荐内存成本64MB-128MB</li><li><strong>CPU成本</strong>：根据服务器性能调整</li></ul><h4 id="_2-缓存策略" tabindex="-1">2. 缓存策略 <a class="header-anchor" href="#_2-缓存策略" aria-label="Permalink to &quot;2. 缓存策略&quot;">​</a></h4><ul><li><strong>哈希缓存</strong>：缓存频繁验证的密码哈希</li><li><strong>会话管理</strong>：合理设置会话过期时间</li><li><strong>预计算</strong>：对静态内容进行预计算</li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/user.py#L42-L65" target="_blank" rel="noreferrer">src/backend/agentchat/api/services/user.py</a></li></ul><h2 id="其他敏感信息的加密存储" tabindex="-1">其他敏感信息的加密存储 <a class="header-anchor" href="#其他敏感信息的加密存储" aria-label="Permalink to &quot;其他敏感信息的加密存储&quot;">​</a></h2><h3 id="api密钥和配置凭证" tabindex="-1">API密钥和配置凭证 <a class="header-anchor" href="#api密钥和配置凭证" aria-label="Permalink to &quot;API密钥和配置凭证&quot;">​</a></h3><p>系统中包含多种类型的敏感配置信息：</p><h4 id="_1-第三方服务api密钥" tabindex="-1">1. 第三方服务API密钥 <a class="header-anchor" href="#_1-第三方服务api密钥" aria-label="Permalink to &quot;1. 第三方服务API密钥&quot;">​</a></h4><ul><li><strong>OpenAI API Key</strong>：<code>sk-6d47d94f4c7343579030b6a75b65f31f</code></li><li><strong>阿里云API Key</strong>：<code>sk-fc40dd0604f04142a0730793ec74585f</code></li><li><strong>高德地图API Key</strong>：<code>fac0ad465078da96a3ec6ba1ccc6746f</code></li><li><strong>Tavily API Key</strong>：<code>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</code></li></ul><h4 id="_2-数据库连接凭据" tabindex="-1">2. 数据库连接凭据 <a class="header-anchor" href="#_2-数据库连接凭据" aria-label="Permalink to &quot;2. 数据库连接凭据&quot;">​</a></h4><ul><li><strong>MySQL连接</strong>：<code>mysql+pymysql://root:mingguang@localhost:3306/agentchat</code></li><li><strong>Redis连接</strong>：<code>redis://localhost:6379</code></li></ul><h4 id="_3-对称加密解决方案" tabindex="-1">3. 对称加密解决方案 <a class="header-anchor" href="#_3-对称加密解决方案" aria-label="Permalink to &quot;3. 对称加密解决方案&quot;">​</a></h4><p>对于这些敏感配置信息，建议使用对称加密：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># AES加密示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cryptography.hazmat.primitives.ciphers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Cipher, algorithms, modes</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cryptography.hazmat.backends </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> default_backend</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encrypt_sensitive_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    iv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os.urandom(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cipher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Cipher(algorithms.AES(key), modes.CFB(iv), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">default_backend())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    encryptor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cipher.encryptor()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    encrypted_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encryptor.update(data.encode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encryptor.finalize()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> iv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encrypted_data</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> decrypt_sensitive_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(encrypted_data: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    iv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encrypted_data[:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ciphertext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encrypted_data[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cipher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Cipher(algorithms.AES(key), modes.CFB(iv), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">default_backend())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    decryptor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cipher.decryptor()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    decrypted_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decryptor.update(ciphertext) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decryptor.finalize()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decrypted_data.decode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="加密存储架构" tabindex="-1">加密存储架构 <a class="header-anchor" href="#加密存储架构" aria-label="Permalink to &quot;加密存储架构&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;配置管理&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[配置文件] --&gt; B[AES加密]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[加密配置文件]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;密钥管理&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D[主密钥] --&gt; E[密钥轮换]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[密钥备份]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;应用层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[应用启动] --&gt; H[解密配置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I[加载服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; D</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L21-L129" target="_blank" rel="noreferrer">src/backend/agentchat/config.yaml</a></li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L21-L129" target="_blank" rel="noreferrer">src/backend/agentchat/config.yaml</a></li></ul><h2 id="密钥管理最佳实践" tabindex="-1">密钥管理最佳实践 <a class="header-anchor" href="#密钥管理最佳实践" aria-label="Permalink to &quot;密钥管理最佳实践&quot;">​</a></h2><h3 id="环境变量配置" tabindex="-1">环境变量配置 <a class="header-anchor" href="#环境变量配置" aria-label="Permalink to &quot;环境变量配置&quot;">​</a></h3><h4 id="_1-环境变量命名规范" tabindex="-1">1. 环境变量命名规范 <a class="header-anchor" href="#_1-环境变量命名规范" aria-label="Permalink to &quot;1. 环境变量命名规范&quot;">​</a></h4><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 数据库连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DATABASE_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mysql://user:password@host:port/dbname</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Redis连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REDIS_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">redis://host:port</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># JWT密钥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">JWT_SECRET_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">your-super-secret-jwt-key-change-in-production</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 第三方API密钥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">OPENAI_API_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${OPENAI_API_KEY}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ALIBABA_CLOUD_ACCESS_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${ALIBABA_CLOUD_ACCESS_KEY}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_2-docker环境配置" tabindex="-1">2. Docker环境配置 <a class="header-anchor" href="#_2-docker环境配置" aria-label="Permalink to &quot;2. Docker环境配置&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># docker-compose.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  backend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DATABASE_URL=\${DATABASE_URL}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">REDIS_URL=\${REDIS_URL}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">JWT_SECRET_KEY=\${JWT_SECRET_KEY}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">OPENAI_API_KEY=\${OPENAI_API_KEY}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="密钥管理系统-kms" tabindex="-1">密钥管理系统（KMS） <a class="header-anchor" href="#密钥管理系统-kms" aria-label="Permalink to &quot;密钥管理系统（KMS）&quot;">​</a></h3><h4 id="_1-aws-kms集成" tabindex="-1">1. AWS KMS集成 <a class="header-anchor" href="#_1-aws-kms集成" aria-label="Permalink to &quot;1. AWS KMS集成&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boto3</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> botocore.exceptions </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ClientError</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KMSService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, region_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;us-west-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.kms_client </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boto3.client(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;kms&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">region_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">region_name)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.key_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;alias/application-key&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encrypt_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, plaintext: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.kms_client.encrypt(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                KeyId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.key_id,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                Plaintext</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">plaintext.encode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CiphertextBlob&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        except</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ClientError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.error(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;KMS encrypt error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            raise</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> decrypt_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, ciphertext: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.kms_client.decrypt(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                CiphertextBlob</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ciphertext</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Plaintext&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].decode(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        except</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ClientError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.error(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;KMS decrypt error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            raise</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="_2-密钥轮换策略" tabindex="-1">2. 密钥轮换策略 <a class="header-anchor" href="#_2-密钥轮换策略" aria-label="Permalink to &quot;2. 密钥轮换策略&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyRotationManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, kms_service):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.kms_service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kms_service</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.rotation_interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 90</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 90天</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.last_rotation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime.now()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> should_rotate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        days_since_last </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (datetime.now() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.last_rotation).days</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> days_since_last </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.rotation_interval</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rotate_key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self):</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 生成新密钥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        new_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.kms_service.create_new_key()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 更新所有服务配置</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.update_all_services(new_key)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 更新密钥元数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.last_rotation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime.now()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="密钥安全存储" tabindex="-1">密钥安全存储 <a class="header-anchor" href="#密钥安全存储" aria-label="Permalink to &quot;密钥安全存储&quot;">​</a></h3><h4 id="_1-分层密钥架构" tabindex="-1">1. 分层密钥架构 <a class="header-anchor" href="#_1-分层密钥架构" aria-label="Permalink to &quot;1. 分层密钥架构&quot;">​</a></h4><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[根密钥] --&gt; B[应用密钥]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[服务密钥]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[会话密钥]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[硬件安全模块] --&gt; A</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F[密钥管理服务] --&gt; B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[应用密钥] --&gt; C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[临时密钥] --&gt; D</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-密钥访问控制" tabindex="-1">2. 密钥访问控制 <a class="header-anchor" href="#_2-密钥访问控制" aria-label="Permalink to &quot;2. 密钥访问控制&quot;">​</a></h4><ul><li><strong>最小权限原则</strong>：每个服务只能访问必要的密钥</li><li><strong>审计日志</strong>：记录所有密钥访问操作</li><li><strong>多因素认证</strong>：关键密钥操作需要多重认证</li></ul><p><strong>章节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml#L69-L70" target="_blank" rel="noreferrer">src/backend/agentchat/config.yaml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.yml#L69-L74" target="_blank" rel="noreferrer">docker/docker-compose.yml</a></li></ul><h2 id="总结与建议" tabindex="-1">总结与建议 <a class="header-anchor" href="#总结与建议" aria-label="Permalink to &quot;总结与建议&quot;">​</a></h2><h3 id="当前状态评估" tabindex="-1">当前状态评估 <a class="header-anchor" href="#当前状态评估" aria-label="Permalink to &quot;当前状态评估&quot;">​</a></h3><p>AgentChat当前的安全实现存在以下特点：</p><h4 id="优势" tabindex="-1">优势 <a class="header-anchor" href="#优势" aria-label="Permalink to &quot;优势&quot;">​</a></h4><ol><li><strong>基本的密码保护</strong>：使用MD5算法对密码进行哈希处理</li><li><strong>数据库设计</strong>：合理的数据模型设计，支持软删除</li><li><strong>Redis缓存</strong>：使用Redis进行会话管理和临时数据存储</li></ol><h4 id="劣势" tabindex="-1">劣势 <a class="header-anchor" href="#劣势" aria-label="Permalink to &quot;劣势&quot;">​</a></h4><ol><li><strong>算法安全性不足</strong>：MD5算法已被证明不够安全</li><li><strong>缺乏盐值机制</strong>：无法防止彩虹表攻击</li><li><strong>密钥管理薄弱</strong>：敏感信息明文存储</li><li><strong>缺少密钥轮换</strong>：长期使用同一密钥</li></ol><h3 id="改进建议优先级" tabindex="-1">改进建议优先级 <a class="header-anchor" href="#改进建议优先级" aria-label="Permalink to &quot;改进建议优先级&quot;">​</a></h3><h4 id="短期改进-1-2个月" tabindex="-1">短期改进（1-2个月） <a class="header-anchor" href="#短期改进-1-2个月" aria-label="Permalink to &quot;短期改进（1-2个月）&quot;">​</a></h4><ol><li><strong>密码哈希升级</strong>：迁移到bcrypt或Argon2算法</li><li><strong>盐值引入</strong>：为每个密码生成随机盐值</li><li><strong>HTTPS强制</strong>：确保所有通信都使用HTTPS</li></ol><h4 id="中期改进-3-6个月" tabindex="-1">中期改进（3-6个月） <a class="header-anchor" href="#中期改进-3-6个月" aria-label="Permalink to &quot;中期改进（3-6个月）&quot;">​</a></h4><ol><li><strong>密钥管理系统</strong>：部署KMS解决方案</li><li><strong>环境变量配置</strong>：使用环境变量替代明文配置</li><li><strong>安全审计</strong>：进行全面的安全审计和渗透测试</li></ol><h4 id="长期改进-6-12个月" tabindex="-1">长期改进（6-12个月） <a class="header-anchor" href="#长期改进-6-12个月" aria-label="Permalink to &quot;长期改进（6-12个月）&quot;">​</a></h4><ol><li><strong>零知识架构</strong>：实现客户端密码哈希</li><li><strong>多因素认证</strong>：引入MFA支持</li><li><strong>安全监控</strong>：部署实时安全监控系统</li></ol><h3 id="实施路线图" tabindex="-1">实施路线图 <a class="header-anchor" href="#实施路线图" aria-label="Permalink to &quot;实施路线图&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gantt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">title 安全改进实施计划</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dateFormat YYYY-MM-DD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">section 密码安全</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MD5迁移 :done, md5, 2024-01-01, 2024-01-31</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bcrypt升级 :active, bcrypt, 2024-02-01, 2024-02-28</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">密码重置 :pwdreset, 2024-03-01, 2024-03-31</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">section 密钥管理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">环境变量配置 :envvar, 2024-01-01, 2024-01-15</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KMS部署 :kms, 2024-02-01, 2024-02-28</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">密钥轮换 :rotation, 2024-03-01, 2024-03-31</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">section 安全加固</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HTTPS强制 :https, 2024-01-01, 2024-01-15</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">安全审计 :audit, 2024-03-01, 2024-03-31</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">监控系统 :monitoring, 2024-04-01, 2024-04-30</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="最终建议" tabindex="-1">最终建议 <a class="header-anchor" href="#最终建议" aria-label="Permalink to &quot;最终建议&quot;">​</a></h3><ol><li><strong>立即行动</strong>：尽快将密码哈希算法升级到bcrypt或Argon2</li><li><strong>渐进实施</strong>：采用渐进式迁移策略，确保业务连续性</li><li><strong>全面评估</strong>：进行全面的安全评估，识别其他潜在风险</li><li><strong>持续改进</strong>：建立持续的安全改进机制</li></ol><p>通过实施这些改进措施，AgentChat系统将能够达到现代Web应用的安全标准，为用户提供更加安全可靠的服务体验。</p>`,117)])])}const g=a(e,[["render",t]]);export{c as __pageData,g as default};
