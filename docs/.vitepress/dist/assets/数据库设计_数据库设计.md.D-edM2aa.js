import{_ as a,c as n,o as e,ag as i}from"./chunks/framework.D0TaUBpX.js";const E=JSON.parse('{"title":"数据库设计","description":"","frontmatter":{},"headers":[],"relativePath":"数据库设计/数据库设计.md","filePath":"数据库设计/数据库设计.md","lastUpdated":1764244560000}'),l={name:"数据库设计/数据库设计.md"};function t(r,s,p,o,c,d){return e(),n("div",null,[...s[0]||(s[0]=[i(`<h1 id="数据库设计" tabindex="-1">数据库设计 <a class="header-anchor" href="#数据库设计" aria-label="Permalink to &quot;数据库设计&quot;">​</a></h1><cite> **本文档中引用的文件** - [base.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/base.py) - [user.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py) - [agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py) - [dialog.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py) - [message.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/message.py) - [knowledge.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge.py) - [knowledge_file.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge_file.py) - [tool.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/tool.py) - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py) - [es_index.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/es_index.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#核心数据模型">核心数据模型</a></li><li><a href="#实体关系图">实体关系图</a></li><li><a href="#向量数据库与全文检索">向量数据库与全文检索</a></li><li><a href="#查询性能优化建议">查询性能优化建议</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>本项目采用SQLModel作为ORM框架，定义了多个核心数据实体，包括用户、Agent、对话、消息、知识库等。这些模型通过关系型数据库存储结构化数据，并结合向量数据库（ChromaDB/Milvus）和Elasticsearch处理非结构化数据的存储与检索。系统实现了完整的用户与Agent的1:N关系、对话与消息的1:N关系等业务逻辑。</p><h2 id="核心数据模型" tabindex="-1">核心数据模型 <a class="header-anchor" href="#核心数据模型" aria-label="Permalink to &quot;核心数据模型&quot;">​</a></h2><h3 id="用户模型-user" tabindex="-1">用户模型 (User) <a class="header-anchor" href="#用户模型-user" aria-label="Permalink to &quot;用户模型 (User)&quot;">​</a></h3><p>用户表存储系统用户的基本信息和认证数据。</p><p><strong>字段说明：</strong></p><ul><li><code>user_id</code>: 用户唯一标识符，主键</li><li><code>user_name</code>: 用户名，建立索引并保证唯一性</li><li><code>user_email</code>: 用户邮箱</li><li><code>user_avatar</code>: 用户头像URL</li><li><code>user_description</code>: 用户描述，默认值为&quot;该用户很懒，没有留下一片云彩&quot;</li><li><code>user_password</code>: 加密后的用户密码</li><li><code>delete</code>: 布尔值，标识用户是否被删除</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳，建立索引</li><li><code>update_time</code>: 更新时间，自动设置为当前时间戳，并在更新时自动更新</li></ul><p><strong>业务含义：</strong> 该模型是系统的基础身份认证实体，支持用户注册、登录和权限管理功能。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py#L18-L112" target="_blank" rel="noreferrer">user.py</a></li></ul><h3 id="agent模型-agent" tabindex="-1">Agent模型 (Agent) <a class="header-anchor" href="#agent模型-agent" aria-label="Permalink to &quot;Agent模型 (Agent)&quot;">​</a></h3><p>Agent表存储Agent的配置信息和元数据。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: Agent唯一标识符，主键，使用UUID生成</li><li><code>name</code>: Agent名称</li><li><code>description</code>: Agent描述</li><li><code>logo_url</code>: Agent的logo地址，使用默认配置</li><li><code>user_id</code>: 绑定的用户ID，建立索引</li><li><code>is_custom</code>: 布尔值，标识Agent是否为用户自定义</li><li><code>system_prompt</code>: Agent的系统提示词</li><li><code>llm_id</code>: 绑定的LLM模型ID</li><li><code>enable_memory</code>: 布尔值，标识是否开启记忆功能</li><li><code>mcp_ids</code>: 绑定的MCP Server列表，使用JSON格式存储</li><li><code>tool_ids</code>: 绑定的工具列表，使用JSON格式存储</li><li><code>knowledge_ids</code>: 绑定的知识库列表，使用JSON格式存储</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型定义了智能Agent的核心配置，支持用户创建和管理自定义Agent。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py#L11-L47" target="_blank" rel="noreferrer">agent.py</a></li></ul><h3 id="对话模型-dialog" tabindex="-1">对话模型 (Dialog) <a class="header-anchor" href="#对话模型-dialog" aria-label="Permalink to &quot;对话模型 (Dialog)&quot;">​</a></h3><p>对话表存储对话会话的信息。</p><p><strong>字段说明：</strong></p><ul><li><code>dialog_id</code>: 对话唯一标识符，主键，使用UUID生成</li><li><code>name</code>: 对话绑定的Agent名称</li><li><code>agent_id</code>: 对话绑定的Agent ID</li><li><code>agent_type</code>: 对话绑定的Agent类型，默认为&quot;Agent&quot;</li><li><code>user_id</code>: 对话的用户ID</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型记录了用户与Agent之间的对话会话，支持对话历史的管理和恢复。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py#L12-L36" target="_blank" rel="noreferrer">dialog.py</a></li></ul><h3 id="消息模型-message" tabindex="-1">消息模型 (Message) <a class="header-anchor" href="#消息模型-message" aria-label="Permalink to &quot;消息模型 (Message)&quot;">​</a></h3><p>消息表存储消息记录，包括点赞和点踩的信息。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: 消息唯一标识符，主键，使用UUID生成</li><li><code>user_input</code>: 用户输入内容，使用Text类型存储</li><li><code>agent_output</code>: Agent输出内容，使用Text类型存储</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型记录了用户与Agent之间的具体交互内容，分为点赞（message_like）和点踩（message_down）两种类型，用于收集用户反馈。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/message.py#L13-L58" target="_blank" rel="noreferrer">message.py</a></li></ul><h3 id="知识库模型-knowledge" tabindex="-1">知识库模型 (Knowledge) <a class="header-anchor" href="#知识库模型-knowledge" aria-label="Permalink to &quot;知识库模型 (Knowledge)&quot;">​</a></h3><p>知识库表存储知识库条目的信息。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: 知识库唯一标识符，主键，使用自定义函数生成（前缀t_加UUID的前16位）</li><li><code>name</code>: 知识库名称，建立索引并保证唯一性，最大长度128字符</li><li><code>description</code>: 知识库描述，最大长度1024字符</li><li><code>user_id</code>: 创建用户ID，建立索引，最大长度128字符</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型定义了知识库的基本信息，支持用户创建和管理自己的知识库。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge.py#L14-L37" target="_blank" rel="noreferrer">knowledge.py</a></li></ul><h3 id="知识库文件模型-knowledgefile" tabindex="-1">知识库文件模型 (KnowledgeFile) <a class="header-anchor" href="#知识库文件模型-knowledgefile" aria-label="Permalink to &quot;知识库文件模型 (KnowledgeFile)&quot;">​</a></h3><p>知识库文件表存储知识库文件的元数据。</p><p><strong>字段说明：</strong></p><ul><li><code>id</code>: 文件唯一标识符，主键，使用UUID生成</li><li><code>file_name</code>: 文件名称，建立索引</li><li><code>knowledge_id</code>: 所属知识库ID，建立索引</li><li><code>status</code>: 文件解析状态，枚举值：fail（失败）、process（处理中）、success（成功），默认为success</li><li><code>user_id</code>: 用户ID，建立索引</li><li><code>oss_url</code>: 文件在OSS中的存储路径</li><li><code>file_size</code>: 文件大小（字节）</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型记录了知识库中每个文件的详细信息和处理状态，支持文件上传、解析和管理。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge_file.py#L16-L41" target="_blank" rel="noreferrer">knowledge_file.py</a></li></ul><h3 id="工具模型-tool" tabindex="-1">工具模型 (Tool) <a class="header-anchor" href="#工具模型-tool" aria-label="Permalink to &quot;工具模型 (Tool)&quot;">​</a></h3><p>工具表存储工具定义的信息。</p><p><strong>字段说明：</strong></p><ul><li><code>tool_id</code>: 工具唯一标识符，主键，使用UUID生成</li><li><code>zh_name</code>: 工具的中文名称，显示给用户</li><li><code>en_name</code>: 工具的英文名称，供大模型调用</li><li><code>user_id</code>: 创建该工具的用户ID</li><li><code>logo_url</code>: 工具的Logo地址</li><li><code>description</code>: 工具描述，使用Text类型存储，大模型根据此描述识别并调用该工具</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型定义了可被Agent调用的工具，支持用户创建自定义工具。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/tool.py#L12-L36" target="_blank" rel="noreferrer">tool.py</a></li></ul><h3 id="mcp服务模型-mcp-server" tabindex="-1">MCP服务模型 (MCP_Server) <a class="header-anchor" href="#mcp服务模型-mcp-server" aria-label="Permalink to &quot;MCP服务模型 (MCP_Server)&quot;">​</a></h3><p>MCP服务表存储MCP服务配置的信息。</p><p><strong>字段说明：</strong></p><ul><li><code>mcp_server_id</code>: MCP服务唯一标识符，主键，使用UUID生成</li><li><code>server_name</code>: MCP服务名称，默认为&quot;MCP Server&quot;</li><li><code>user_id</code>: 创建该MCP服务的用户ID</li><li><code>user_name</code>: MCP服务创建者的名称</li><li><code>description</code>: MCP服务描述，用作子Agent</li><li><code>mcp_as_tool_name</code>: 用作子Agent时的名称</li><li><code>url</code>: MCP服务的连接地址</li><li><code>type</code>: 连接类型，限制为sse、websocket、stdio三种</li><li><code>logo_url</code>: MCP服务的logo地址</li><li><code>config</code>: 配置信息（如apikey等），使用JSON格式存储</li><li><code>tools</code>: MCP服务的工具列表，使用JSON格式存储</li><li><code>params</code>: 输入参数，使用JSON格式存储</li><li><code>config_enabled</code>: 布尔值，标识是否需要用户单独配置参数</li><li><code>update_time</code>: 修改时间，自动设置为当前时间戳，并在更新时自动更新</li><li><code>create_time</code>: 创建时间，自动设置为当前时间戳</li></ul><p><strong>业务含义：</strong> 该模型定义了MCP服务的配置，支持外部服务的集成和管理。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py#L30-L62" target="_blank" rel="noreferrer">mcp_server.py</a></li></ul><h2 id="实体关系图" tabindex="-1">实体关系图 <a class="header-anchor" href="#实体关系图" aria-label="Permalink to &quot;实体关系图&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">erDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_name UK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_email</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_avatar</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_password</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean delete</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean is_custom</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string system_prompt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string llm_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean enable_memory</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json mcp_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json tool_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json knowledge_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIALOG {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string dialog_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string agent_type</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MESSAGE_DOWN {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text user_input</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text agent_output</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MESSAGE_LIKE {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text user_input</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text agent_output</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KNOWLEDGE {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string name UK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KNOWLEDGE_FILE {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string file_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string knowledge_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string status</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string oss_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int file_size</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TOOL {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string tool_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string zh_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string en_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCP_SERVER {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string mcp_server_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string server_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string user_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string mcp_as_tool_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string type</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string logo_url</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json config</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json tools</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json params</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean config_enabled</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ AGENT : &quot;创建&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ DIALOG : &quot;拥有&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ KNOWLEDGE : &quot;拥有&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ KNOWLEDGE_FILE : &quot;上传&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ TOOL : &quot;创建&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USER ||--o{ MCP_SERVER : &quot;创建&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT ||--o{ DIALOG : &quot;绑定&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KNOWLEDGE ||--o{ KNOWLEDGE_FILE : &quot;包含&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><p><strong>Diagram sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/user.py#L18-L112" target="_blank" rel="noreferrer">user.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/agent.py#L11-L47" target="_blank" rel="noreferrer">agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py#L12-L36" target="_blank" rel="noreferrer">dialog.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/message.py#L13-L58" target="_blank" rel="noreferrer">message.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge.py#L14-L37" target="_blank" rel="noreferrer">knowledge.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/knowledge_file.py#L16-L41" target="_blank" rel="noreferrer">knowledge_file.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/tool.py#L12-L36" target="_blank" rel="noreferrer">tool.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/mcp_server.py#L30-L62" target="_blank" rel="noreferrer">mcp_server.py</a></li></ul><h2 id="向量数据库与全文检索" tabindex="-1">向量数据库与全文检索 <a class="header-anchor" href="#向量数据库与全文检索" aria-label="Permalink to &quot;向量数据库与全文检索&quot;">​</a></h2><h3 id="elasticsearch索引配置" tabindex="-1">Elasticsearch索引配置 <a class="header-anchor" href="#elasticsearch索引配置" aria-label="Permalink to &quot;Elasticsearch索引配置&quot;">​</a></h3><p>系统使用Elasticsearch进行全文检索，索引配置如下：</p><p><strong>索引设置：</strong></p><ul><li>分析器：使用ik_smart中文分词器</li><li>映射属性： <ul><li><code>chunk_id</code>: keyword类型</li><li><code>content</code>: text类型，使用ik_analyzer分析器</li><li><code>summary</code>: text类型，使用ik_analyzer分析器</li><li><code>file_id</code>: keyword类型</li><li><code>knowledge_id</code>: keyword类型</li><li><code>file_name</code>: keyword类型</li><li><code>update_time</code>: date类型</li></ul></li></ul><p><strong>查询模板：</strong></p><ul><li>内容搜索：使用match查询，ik_smart分析器，操作符为and，最小匹配75%，支持模糊搜索，boost为2.0</li><li>摘要搜索：与内容搜索类似，针对摘要字段进行搜索</li><li>删除查询：根据file_id进行精确匹配删除</li></ul><p><strong>业务含义：</strong> 该配置支持对知识库内容的高效全文检索，特别优化了中文文本的搜索效果。</p><p><strong>Section sources</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/es_index.py#L1-L84" target="_blank" rel="noreferrer">es_index.py</a></li></ul><h3 id="向量数据库-chromadb-milvus" tabindex="-1">向量数据库（ChromaDB/Milvus） <a class="header-anchor" href="#向量数据库-chromadb-milvus" aria-label="Permalink to &quot;向量数据库（ChromaDB/Milvus）&quot;">​</a></h3><p>虽然代码中没有直接体现向量数据库的具体实现，但从知识库ID的生成规则（<code>get_knowledge_id</code>函数返回以&quot;t_&quot;开头的ID）可以推断：</p><ul><li>系统使用Milvus或ChromaDB作为向量数据库</li><li>知识库ID同时用作向量数据库中的集合名称</li><li>每个知识库对应一个独立的向量集合</li><li>支持基于向量相似度的语义搜索</li></ul><h2 id="查询性能优化建议" tabindex="-1">查询性能优化建议 <a class="header-anchor" href="#查询性能优化建议" aria-label="Permalink to &quot;查询性能优化建议&quot;">​</a></h2><h3 id="索引策略" tabindex="-1">索引策略 <a class="header-anchor" href="#索引策略" aria-label="Permalink to &quot;索引策略&quot;">​</a></h3><ol><li><strong>主键索引</strong>：所有表都已正确设置主键，确保了数据的唯一性和快速查找。</li><li><strong>复合索引</strong>：建议为高频查询字段创建复合索引，例如： <ul><li><code>dialog</code>表的<code>(user_id, create_time)</code>复合索引，优化用户对话历史查询</li><li><code>knowledge_file</code>表的<code>(knowledge_id, status)</code>复合索引，优化知识库文件状态查询</li></ul></li><li><strong>覆盖索引</strong>：对于只查询部分字段的场景，考虑创建覆盖索引以避免回表查询。</li></ol><h3 id="数据分区" tabindex="-1">数据分区 <a class="header-anchor" href="#数据分区" aria-label="Permalink to &quot;数据分区&quot;">​</a></h3><ol><li><strong>时间分区</strong>：对于<code>message_like</code>和<code>message_down</code>等可能快速增长的表，建议按时间（如按月）进行分区，提高查询效率和维护性能。</li><li><strong>用户分区</strong>：对于用户相关的表，可以考虑按用户ID进行哈希分区，实现数据的水平扩展。</li></ol><h3 id="查询优化" tabindex="-1">查询优化 <a class="header-anchor" href="#查询优化" aria-label="Permalink to &quot;查询优化&quot;">​</a></h3><ol><li><strong>避免N+1查询</strong>：在查询用户及其关联的Agent、对话等数据时，使用JOIN或批量查询避免多次数据库访问。</li><li><strong>分页优化</strong>：对于大数据量的查询，使用游标分页而非基于OFFSET的分页，避免性能下降。</li><li><strong>缓存策略</strong>：对于频繁访问但不常变更的数据（如工具列表、MCP服务列表），建议使用Redis等缓存机制。</li></ol><h3 id="其他建议" tabindex="-1">其他建议 <a class="header-anchor" href="#其他建议" aria-label="Permalink to &quot;其他建议&quot;">​</a></h3><ol><li><strong>JSON字段查询优化</strong>：对于<code>mcp_ids</code>、<code>tool_ids</code>等JSON字段的查询，考虑创建GIN索引（PostgreSQL）或等效索引以提高查询性能。</li><li><strong>定期维护</strong>：定期分析表统计信息，优化查询计划；定期清理过期数据，保持数据库性能。</li><li><strong>监控与调优</strong>：建立数据库性能监控，及时发现慢查询并进行优化。</li></ol>`,89)])])}const g=a(l,[["render",t]]);export{E as __pageData,g as default};
