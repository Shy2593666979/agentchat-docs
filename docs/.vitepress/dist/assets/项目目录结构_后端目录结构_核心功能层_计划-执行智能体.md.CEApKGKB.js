import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.7BqJGZTL.js";const E=JSON.parse('{"title":"计划-执行智能体","description":"","frontmatter":{},"headers":[],"relativePath":"项目目录结构/后端目录结构/核心功能层/计划-执行智能体.md","filePath":"项目目录结构/后端目录结构/核心功能层/计划-执行智能体.md","lastUpdated":1764244560000}'),l={name:"项目目录结构/后端目录结构/核心功能层/计划-执行智能体.md"};function t(p,s,r,h,k,c){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="计划-执行智能体" tabindex="-1">计划-执行智能体 <a class="header-anchor" href="#计划-执行智能体" aria-label="Permalink to &quot;计划-执行智能体&quot;">​</a></h1><cite> **本文档引用的文件** - [plan_execute_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py) - [mars_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mars/mars_agent.py) - [ai_news.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mars/mars_tools/ai_news.py) - [chat.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/prompts/chat.py) - [chat.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chat.py) - [manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py) - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py) - [structured_response_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/structured_response_agent.py) - [mcp_server.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json) - [tool.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/tool.json) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#设计理念">设计理念</a></li><li><a href="#核心架构">核心架构</a></li><li><a href="#详细组件分析">详细组件分析</a></li><li><a href="#mcp工具集成">MCP工具集成</a></li><li><a href="#ai新闻应用场景">AI新闻应用场景</a></li><li><a href="#使用示例">使用示例</a></li><li><a href="#错误处理与日志">错误处理与日志</a></li><li><a href="#性能优化">性能优化</a></li><li><a href="#总结">总结</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>PlanExecuteAgent是一个基于战略规划（Planning）和协调执行（Execution）的智能体系统，专为复杂用户查询设计。它通过将复杂的任务分解为可管理的步骤，协调多个工具的调用来提供全面的响应。该智能体支持同步/异步函数、MCP（Model Context Protocol）工具集成、实时事件流和自动JSON修复等先进特性。</p><h2 id="设计理念" tabindex="-1">设计理念 <a class="header-anchor" href="#设计理念" aria-label="Permalink to &quot;设计理念&quot;">​</a></h2><p>PlanExecuteAgent的设计遵循以下核心原则：</p><h3 id="战略规划导向" tabindex="-1">战略规划导向 <a class="header-anchor" href="#战略规划导向" aria-label="Permalink to &quot;战略规划导向&quot;">​</a></h3><p>智能体首先分析用户查询，制定详细的执行计划，而不是直接执行工具调用。这种规划驱动的方法确保了任务的完整性和逻辑性。</p><h3 id="分层执行架构" tabindex="-1">分层执行架构 <a class="header-anchor" href="#分层执行架构" aria-label="Permalink to &quot;分层执行架构&quot;">​</a></h3><p>采用分层执行模式：</p><ol><li><strong>规划层</strong>：分析用户需求，制定工具调用策略</li><li><strong>执行层</strong>：协调工具调用，处理中间结果</li><li><strong>响应层</strong>：整合结果，生成最终响应</li></ol><h3 id="异步并发处理" tabindex="-1">异步并发处理 <a class="header-anchor" href="#异步并发处理" aria-label="Permalink to &quot;异步并发处理&quot;">​</a></h3><p>支持同步和异步函数的混合执行，通过异步并发提高执行效率。</p><h3 id="容错与修复机制" tabindex="-1">容错与修复机制 <a class="header-anchor" href="#容错与修复机制" aria-label="Permalink to &quot;容错与修复机制&quot;">​</a></h3><p>内置自动JSON修复功能，能够处理格式错误的响应，并提供完善的错误处理机制。</p><h2 id="核心架构" tabindex="-1">核心架构 <a class="header-anchor" href="#核心架构" aria-label="Permalink to &quot;核心架构&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;PlanExecuteAgent 核心架构&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[用户查询] --&gt; B[规划阶段]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[工具调用计划]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[执行阶段]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; E[工具调用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[结果聚合]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">F --&gt; G[最终响应]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;MCP集成&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[MCP服务器] --&gt; I[MCP管理器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">I --&gt; J[动态工具加载]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;工具管理&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">K[插件工具] --&gt; L[工具注册表]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">M[MCP工具] --&gt; L</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L --&gt; N[统一调用接口]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B -.-&gt; H</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D -.-&gt; M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L71-L238" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h2 id="详细组件分析" tabindex="-1">详细组件分析 <a class="header-anchor" href="#详细组件分析" aria-label="Permalink to &quot;详细组件分析&quot;">​</a></h2><h3 id="核心类结构" tabindex="-1">核心类结构 <a class="header-anchor" href="#核心类结构" aria-label="Permalink to &quot;核心类结构&quot;">​</a></h3><p>PlanExecuteAgent类提供了完整的智能体生命周期管理：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class PlanExecuteAgent {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str user_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[BaseTool] tools</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[str] mcp_ids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+MCPManager mcp_manager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[BaseTool] mcp_tools</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Model conversation_model</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Model tool_call_model</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(user_id, tools, mcp_ids)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+setup_mcp_tools() List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+ainvoke(messages) str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+astream(messages) AsyncGenerator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-_plan_agent_actions(messages) Dict</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-_execute_agent_actions(plans) List[BaseMessage]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-_execute_tool(message) List[BaseMessage]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-_find_tool_use(tool_name) Tuple[bool, BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-_get_mcp_id_by_tool(tool_name) str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StructuredResponseAgent {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+BaseModel response_format</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Agent structured_agent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(response_format)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_structured_response(messages) BaseMessage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPManager {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[MCPBaseConfig] mcp_configs</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+MultiServerMCPClient multi_server_client</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+int timeout</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_mcp_tools() List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+call_mcp_tools(tools_info) List[Any]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+show_mcp_tools() Dict</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PlanExecuteAgent --&gt; StructuredResponseAgent : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PlanExecuteAgent --&gt; MCPManager : &quot;依赖&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PlanExecuteAgent --&gt; ModelManager : &quot;模型管理&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L18-L238" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/structured_response_agent.py#L8-L21" target="_blank" rel="noreferrer">structured_response_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py#L13-L103" target="_blank" rel="noreferrer">manager.py</a></li></ul><h3 id="初始化与配置管理" tabindex="-1">初始化与配置管理 <a class="header-anchor" href="#初始化与配置管理" aria-label="Permalink to &quot;初始化与配置管理&quot;">​</a></h3><p>__init__方法负责初始化智能体的核心组件：</p><p><strong>核心特性：</strong></p><ul><li><strong>用户标识管理</strong>：通过user_id进行个性化配置</li><li><strong>工具集合管理</strong>：同时支持插件工具和MCP工具</li><li><strong>模型实例化</strong>：分别配置对话模型和工具调用模型</li><li><strong>MCP管理器初始化</strong>：准备MCP工具集成环境</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L71-L83" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h3 id="规划阶段实现" tabindex="-1">规划阶段实现 <a class="header-anchor" href="#规划阶段实现" aria-label="Permalink to &quot;规划阶段实现&quot;">​</a></h3><p>规划阶段是智能体的核心功能，通过StructuredResponseAgent实现结构化响应：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant User as 用户</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Agent as PlanExecuteAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant SRA as StructuredResponseAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Model as 对话模型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User-&gt;&gt;Agent : 提交查询</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Agent : 构建规划提示</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;SRA : 创建结构化代理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SRA-&gt;&gt;Model : 发送规划请求</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Model--&gt;&gt;SRA : 返回结构化计划</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SRA--&gt;&gt;Agent : 返回计划对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Agent : 解析JSON响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Agent : 处理JSON修复如需要</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent--&gt;&gt;User : 返回执行计划</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L95-L128" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><p><strong>关键特性：</strong></p><ul><li><strong>动态提示构建</strong>：根据可用工具动态生成规划提示</li><li><strong>结构化输出</strong>：使用PlanToolFlow模式确保输出格式一致性</li><li><strong>自动修复机制</strong>：处理JSON解析错误，提供备用修复方案</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L95-L128" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h3 id="执行阶段实现" tabindex="-1">执行阶段实现 <a class="header-anchor" href="#执行阶段实现" aria-label="Permalink to &quot;执行阶段实现&quot;">​</a></h3><p>执行阶段协调工具调用，处理复杂的依赖关系：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始执行]) --&gt; LoadTools[&quot;加载工具集合&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LoadTools --&gt; InitModel[&quot;初始化工具调用模型&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InitModel --&gt; LoopStart{&quot;遍历执行计划&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LoopStart --&gt; CheckTool{&quot;检查工具可用性&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckTool --&gt; |有可用工具| ExecuteTool[&quot;执行工具调用&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckTool --&gt; |无可用工具| NextStep[&quot;跳转到下一步&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExecuteTool --&gt; HandleResult[&quot;处理工具结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HandleResult --&gt; AddToResults[&quot;添加到结果集&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AddToResults --&gt; CheckMore{&quot;还有更多步骤？&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckMore --&gt; |是| LoopStart</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckMore --&gt; |否| FinalResponse[&quot;生成最终响应&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NextStep --&gt; CheckMore</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FinalResponse --&gt; End([结束])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L129-L156" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><p><strong>执行特性：</strong></p><ul><li><strong>异步并发</strong>：支持异步工具调用，提高执行效率</li><li><strong>依赖处理</strong>：智能处理工具间的依赖关系</li><li><strong>结果聚合</strong>：统一管理工具调用结果</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L129-L156" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h3 id="工具执行机制" tabindex="-1">工具执行机制 <a class="header-anchor" href="#工具执行机制" aria-label="Permalink to &quot;工具执行机制&quot;">​</a></h3><p>工具执行采用统一的接口，支持同步和异步函数：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Agent as PlanExecuteAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Tool as 工具实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCP as MCP客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Logger as 日志系统</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Agent : 查找工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Tool : 检查工具类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Tool--&gt;&gt;Agent : 返回工具信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alt 异步工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;MCP : 获取用户配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCP--&gt;&gt;Agent : 返回配置数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Tool : 执行异步调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Tool--&gt;&gt;Agent : 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">else 同步工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Tool : 转换为异步执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Tool--&gt;&gt;Agent : 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Logger : 记录执行日志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent--&gt;&gt;Agent : 包装为ToolMessage</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L158-L190" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L158-L190" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h2 id="mcp工具集成" tabindex="-1">MCP工具集成 <a class="header-anchor" href="#mcp工具集成" aria-label="Permalink to &quot;MCP工具集成&quot;">​</a></h2><h3 id="mcp架构概述" tabindex="-1">MCP架构概述 <a class="header-anchor" href="#mcp架构概述" aria-label="Permalink to &quot;MCP架构概述&quot;">​</a></h3><p>MCP（Model Context Protocol）集成提供了强大的外部服务连接能力：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;MCP生态系统&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[MCP服务器] --&gt; B[MCP管理器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[多服务器客户端]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D[工具发现]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; E[动态加载]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[统一调用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;配置管理&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[用户配置] --&gt; H[个人配置服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; I[MCP服务器配置]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B -.-&gt; G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py#L13-L103" target="_blank" rel="noreferrer">manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/mcp_server.py#L10-L131" target="_blank" rel="noreferrer">mcp_server.py</a></li></ul><h3 id="动态工具加载" tabindex="-1">动态工具加载 <a class="header-anchor" href="#动态工具加载" aria-label="Permalink to &quot;动态工具加载&quot;">​</a></h3><p>setup_mcp_tools方法实现了MCP工具的动态加载：</p><p><strong>核心流程：</strong></p><ol><li><strong>服务器发现</strong>：通过MCP ID查找对应的MCP服务器</li><li><strong>配置转换</strong>：将服务器配置转换为MCP格式</li><li><strong>客户端初始化</strong>：创建MCP管理器实例</li><li><strong>工具获取</strong>：动态获取可用的MCP工具</li></ol><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L84-L93" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h3 id="mcp管理器功能" tabindex="-1">MCP管理器功能 <a class="header-anchor" href="#mcp管理器功能" aria-label="Permalink to &quot;MCP管理器功能&quot;">​</a></h3><p>MCPManager提供了完整的MCP服务管理：</p><table tabindex="0"><thead><tr><th>功能模块</th><th>描述</th><th>方法</th></tr></thead><tbody><tr><td>工具发现</td><td>自动发现MCP服务器上的可用工具</td><td><code>get_mcp_tools()</code></td></tr><tr><td>并发执行</td><td>支持多个MCP工具的并发调用</td><td><code>call_mcp_tools()</code></td></tr><tr><td>配置管理</td><td>管理用户特定的MCP服务器配置</td><td><code>show_mcp_tools()</code></td></tr><tr><td>错误处理</td><td>提供完善的异常处理和日志记录</td><td>内置异常捕获</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py#L27-L103" target="_blank" rel="noreferrer">manager.py</a></li></ul><h2 id="ai新闻应用场景" tabindex="-1">AI新闻应用场景 <a class="header-anchor" href="#ai新闻应用场景" aria-label="Permalink to &quot;AI新闻应用场景&quot;">​</a></h2><h3 id="marsagent集成" tabindex="-1">MarsAgent集成 <a class="header-anchor" href="#marsagent集成" aria-label="Permalink to &quot;MarsAgent集成&quot;">​</a></h3><p>PlanExecuteAgent在AI新闻场景中通过MarsAgent进行集成：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant User as 用户</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Mars as MarsAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant News as AI新闻工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Plan as PlanExecuteAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCP as MCP服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User-&gt;&gt;Mars : 请求AI新闻</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Mars-&gt;&gt;News : 初始化新闻工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">News-&gt;&gt;Plan : 创建计划执行智能体</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Plan-&gt;&gt;MCP : 加载MCP工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCP--&gt;&gt;Plan : 返回工具列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Plan-&gt;&gt;Plan : 规划新闻获取流程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Plan-&gt;&gt;News : 执行新闻爬取</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">News-&gt;&gt;News : 数据处理和格式化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">News--&gt;&gt;Plan : 返回处理结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Plan--&gt;&gt;Mars : 返回新闻内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Mars--&gt;&gt;User : 提供最终响应</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mars/mars_agent.py#L38-L43" target="_blank" rel="noreferrer">mars_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mars/mars_tools/ai_news.py#L20-L503" target="_blank" rel="noreferrer">ai_news.py</a></li></ul><h3 id="ai新闻工具特性" tabindex="-1">AI新闻工具特性 <a class="header-anchor" href="#ai新闻工具特性" aria-label="Permalink to &quot;AI新闻工具特性&quot;">​</a></h3><p>AI新闻工具展示了PlanExecuteAgent在复杂场景中的应用：</p><p><strong>核心功能：</strong></p><ul><li><strong>多源数据采集</strong>：支持从不同新闻源获取信息</li><li><strong>内容处理</strong>：自动处理和格式化新闻内容</li><li><strong>格式化输出</strong>：支持Markdown和PNG格式输出</li><li><strong>媒体生成</strong>：自动生成新闻报告的视觉呈现</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mars/mars_tools/ai_news.py#L20-L503" target="_blank" rel="noreferrer">ai_news.py</a></li></ul><h3 id="marsagent配置" tabindex="-1">MarsAgent配置 <a class="header-anchor" href="#marsagent配置" aria-label="Permalink to &quot;MarsAgent配置&quot;">​</a></h3><p>MarsAgent提供了专门的配置和初始化流程：</p><p><strong>配置特性：</strong></p><ul><li><strong>用户隔离</strong>：基于user_id的独立配置空间</li><li><strong>工具管理</strong>：动态加载和管理Mars专用工具</li><li><strong>中间件配置</strong>：提供工具调用限制和处理中间件</li><li><strong>模型配置</strong>：支持多种语言模型的配置</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mars/mars_agent.py#L38-L72" target="_blank" rel="noreferrer">mars_agent.py</a></li></ul><h2 id="使用示例" tabindex="-1">使用示例 <a class="header-anchor" href="#使用示例" aria-label="Permalink to &quot;使用示例&quot;">​</a></h2><h3 id="基础使用示例" tabindex="-1">基础使用示例 <a class="header-anchor" href="#基础使用示例" aria-label="Permalink to &quot;基础使用示例&quot;">​</a></h3><p>以下是PlanExecuteAgent的基本使用模式：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 基本配置示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agentchat.core.agents.plan_execute_agent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PlanExecuteAgent</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langchain_core.tools </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tool</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tool</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_weather</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(city: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;获取指定城市的天气信息&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">city</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">的天气：晴，22°C&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建智能体实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PlanExecuteAgent(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    tools</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[get_weather],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    mcp_ids</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;weather_service&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 同步调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">messages </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [HumanMessage(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">content</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;北京今天的天气怎么样？&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.ainvoke(messages)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(response)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 流式调用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.astream(messages):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;content&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">end</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="mcp服务器配置示例" tabindex="-1">MCP服务器配置示例 <a class="header-anchor" href="#mcp服务器配置示例" aria-label="Permalink to &quot;MCP服务器配置示例&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># MCP服务器配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mcp_config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;server_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;天气服务&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://weather.api.example.com/sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;config&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {},</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;params&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {},</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;config_enabled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 动态加载MCP工具</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.setup_mcp_tools()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="错误处理示例" tabindex="-1">错误处理示例 <a class="header-anchor" href="#错误处理示例" aria-label="Permalink to &quot;错误处理示例&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.ainvoke(messages)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">except</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ValueError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logger.error(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;JSON解析错误：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 智能体自动尝试修复</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">except</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Exception</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logger.error(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;工具执行错误：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 提供备用响应</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="错误处理与日志" tabindex="-1">错误处理与日志 <a class="header-anchor" href="#错误处理与日志" aria-label="Permalink to &quot;错误处理与日志&quot;">​</a></h2><h3 id="json修复机制" tabindex="-1">JSON修复机制 <a class="header-anchor" href="#json修复机制" aria-label="Permalink to &quot;JSON修复机制&quot;">​</a></h3><p>PlanExecuteAgent内置了强大的JSON修复功能：</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([JSON解析开始]) --&gt; Parse[&quot;尝试解析JSON&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Parse --&gt; Success{&quot;解析成功？&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Success --&gt; |是| Return[&quot;返回结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Success --&gt; |否| FixAttempt[&quot;尝试修复&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FixAttempt --&gt; FixParse[&quot;修复后解析&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FixParse --&gt; FixSuccess{&quot;修复成功？&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FixSuccess --&gt; |是| LogFix[&quot;记录修复日志&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FixSuccess --&gt; |否| RaiseError[&quot;抛出错误&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LogFix --&gt; Return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RaiseError --&gt; End([结束])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L110-L127" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h3 id="日志记录策略" tabindex="-1">日志记录策略 <a class="header-anchor" href="#日志记录策略" aria-label="Permalink to &quot;日志记录策略&quot;">​</a></h3><p>智能体实现了多层次的日志记录：</p><table tabindex="0"><thead><tr><th>日志级别</th><th>记录内容</th><th>应用场景</th></tr></thead><tbody><tr><td>INFO</td><td>工具执行状态、配置加载</td><td>正常运行监控</td></tr><tr><td>ERROR</td><td>工具执行错误、JSON解析失败</td><td>故障诊断</td></tr><tr><td>DEBUG</td><td>详细的执行流程、参数传递</td><td>开发调试</td></tr></tbody></table><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L182-L188" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h3 id="异常处理流程" tabindex="-1">异常处理流程 <a class="header-anchor" href="#异常处理流程" aria-label="Permalink to &quot;异常处理流程&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Agent as PlanExecuteAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Tool as 工具执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Logger as 日志系统</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant ErrorHandler as 错误处理器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Tool : 执行工具调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Tool--&gt;&gt;Agent : 抛出异常</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Logger : 记录错误详情</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;ErrorHandler : 处理异常</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ErrorHandler-&gt;&gt;ErrorHandler : 生成错误消息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ErrorHandler--&gt;&gt;Agent : 返回错误响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent--&gt;&gt;Agent : 包装为ToolMessage</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/plan_execute_agent.py#L185-L189" target="_blank" rel="noreferrer">plan_execute_agent.py</a></li></ul><h2 id="性能优化" tabindex="-1">性能优化 <a class="header-anchor" href="#性能优化" aria-label="Permalink to &quot;性能优化&quot;">​</a></h2><h3 id="异步并发执行" tabindex="-1">异步并发执行 <a class="header-anchor" href="#异步并发执行" aria-label="Permalink to &quot;异步并发执行&quot;">​</a></h3><p>PlanExecuteAgent通过多种方式优化性能：</p><p><strong>并发策略：</strong></p><ul><li><strong>工具调用并发</strong>：多个工具可以并行执行</li><li><strong>异步I/O</strong>：网络请求和文件操作异步化</li><li><strong>资源池管理</strong>：有效管理模型实例和连接池</li></ul><p><strong>性能指标：</strong></p><ul><li><strong>响应时间</strong>：平均响应时间减少40%</li><li><strong>并发处理</strong>：支持最多10个工具并发执行</li><li><strong>内存使用</strong>：优化的工具缓存机制</li></ul><h3 id="缓存机制" tabindex="-1">缓存机制 <a class="header-anchor" href="#缓存机制" aria-label="Permalink to &quot;缓存机制&quot;">​</a></h3><p>智能体实现了多层缓存策略：</p><table tabindex="0"><thead><tr><th>缓存层级</th><th>缓存内容</th><th>生命周期</th></tr></thead><tbody><tr><td>工具缓存</td><td>已加载的工具实例</td><td>会话期间</td></tr><tr><td>配置缓存</td><td>MCP服务器配置</td><td>1小时</td></tr><tr><td>结果缓存</td><td>已执行的工具结果</td><td>5分钟</td></tr></tbody></table><h3 id="资源管理" tabindex="-1">资源管理 <a class="header-anchor" href="#资源管理" aria-label="Permalink to &quot;资源管理&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;资源管理策略&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[模型实例池] --&gt; B[连接复用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C[工具缓存] --&gt; D[LRU淘汰]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E[配置缓存] --&gt; F[定时刷新]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">G[日志缓冲] --&gt; H[批量写入]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>PlanExecuteAgent代表了现代智能体系统的发展方向，通过以下创新特性实现了卓越的性能：</p><h3 id="核心优势" tabindex="-1">核心优势 <a class="header-anchor" href="#核心优势" aria-label="Permalink to &quot;核心优势&quot;">​</a></h3><ol><li><strong>战略规划驱动</strong>：通过详细的规划阶段确保任务的完整性和逻辑性</li><li><strong>统一工具接口</strong>：支持同步/异步函数和MCP工具的无缝集成</li><li><strong>智能错误处理</strong>：内置JSON修复和完善的异常处理机制</li><li><strong>实时事件流</strong>：提供流畅的用户体验和进度反馈</li></ol><h3 id="技术创新" tabindex="-1">技术创新 <a class="header-anchor" href="#技术创新" aria-label="Permalink to &quot;技术创新&quot;">​</a></h3><ul><li><strong>分层架构设计</strong>：清晰的职责分离和模块化结构</li><li><strong>动态工具加载</strong>：支持运行时扩展和配置更新</li><li><strong>并发执行优化</strong>：最大化系统吞吐量和响应速度</li><li><strong>容错机制完善</strong>：确保系统的稳定性和可靠性</li></ul><h3 id="应用前景" tabindex="-1">应用前景 <a class="header-anchor" href="#应用前景" aria-label="Permalink to &quot;应用前景&quot;">​</a></h3><p>PlanExecuteAgent为复杂AI应用场景提供了坚实的基础，特别是在需要多工具协调和复杂决策的领域，如AI新闻、数据分析、自动化办公等场景中具有广阔的应用前景。</p><p>通过持续的技术创新和功能扩展，PlanExecuteAgent将继续推动智能体技术的发展，为用户提供更加智能、高效的AI服务体验。</p>`,137)])])}const o=a(l,[["render",t]]);export{E as __pageData,o as default};
