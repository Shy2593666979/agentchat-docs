import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.7BqJGZTL.js";const g=JSON.parse('{"title":"对话API技术文档","description":"","frontmatter":{},"headers":[],"relativePath":"API参考/对话API.md","filePath":"API参考/对话API.md","lastUpdated":1764244560000}'),l={name:"API参考/对话API.md"};function t(p,s,r,h,k,E){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="对话api技术文档" tabindex="-1">对话API技术文档 <a class="header-anchor" href="#对话api技术文档" aria-label="Permalink to &quot;对话API技术文档&quot;">​</a></h1><cite> **本文档引用的文件** - [router.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/router.py) - [chat.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py) - [chat.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py) - [chat.py](https://github.com/Shy2593666979/AgentChat/src/frontend/src/apis/chat.ts) - [chatPage.vue](https://github.com/Shy2593666979/AgentChat/src/frontend/src/pages/conversation/chatPage/chatPage.vue) - [dialog.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/dialog.py) - [dialog.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/dialog.py) - [history.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/history.py) - [react_agent.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/react_agent.py) - [build.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/build.py) - [manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/manager.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#项目架构概览">项目架构概览</a></li><li><a href="#核心api端点">核心API端点</a></li><li><a href="#websocket连接机制">WebSocket连接机制</a></li><li><a href="#消息流式响应处理">消息流式响应处理</a></li><li><a href="#对话管理">对话管理</a></li><li><a href="#agent执行流程">Agent执行流程</a></li><li><a href="#前端集成示例">前端集成示例</a></li><li><a href="#错误处理与超时策略">错误处理与超时策略</a></li><li><a href="#最佳实践">最佳实践</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>AgentChat是一个基于FastAPI构建的实时对话交互平台，支持多种Agent类型和丰富的对话功能。本文档详细介绍了对话API的核心功能，包括发起新对话、发送消息、WebSocket连接建立以及消息流式响应处理等关键特性。</p><h2 id="项目架构概览" tabindex="-1">项目架构概览 <a class="header-anchor" href="#项目架构概览" aria-label="Permalink to &quot;项目架构概览&quot;">​</a></h2><p>系统采用前后端分离架构，后端基于FastAPI框架，前端使用Vue.js技术栈。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;前端层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FE[Vue.js 前端应用]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API_CLIENT[API客户端]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WS_CLIENT[WebSocket客户端]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;后端服务层&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FASTAPI[FastAPI服务器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ROUTER[路由处理器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHAT_SERVICE[聊天服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT_SERVICE[Agent服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;核心组件&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">STREAM_AGENT[流式Agent]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REACT_AGENT[ReAct Agent]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MEMORY[记忆系统]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HISTORY[历史记录]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph &quot;数据存储&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MYSQL[MySQL数据库]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">VECTOR_DB[向量数据库]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REDIS[Redis缓存]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FE --&gt; API_CLIENT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FE --&gt; WS_CLIENT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API_CLIENT --&gt; FASTAPI</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WS_CLIENT --&gt; FASTAPI</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FASTAPI --&gt; ROUTER</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ROUTER --&gt; CHAT_SERVICE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHAT_SERVICE --&gt; AGENT_SERVICE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AGENT_SERVICE --&gt; STREAM_AGENT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">STREAM_AGENT --&gt; REACT_AGENT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REACT_AGENT --&gt; MEMORY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHAT_SERVICE --&gt; HISTORY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HISTORY --&gt; MYSQL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MEMORY --&gt; VECTOR_DB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHAT_SERVICE --&gt; REDIS</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/router.py#L1-L50" target="_blank" rel="noreferrer">router.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py#L1-L50" target="_blank" rel="noreferrer">chat.py</a></li></ul><h2 id="核心api端点" tabindex="-1">核心API端点 <a class="header-anchor" href="#核心api端点" aria-label="Permalink to &quot;核心API端点&quot;">​</a></h2><h3 id="发起新对话-api-v1-dialog" tabindex="-1">发起新对话 (/api/v1/dialog) <a class="header-anchor" href="#发起新对话-api-v1-dialog" aria-label="Permalink to &quot;发起新对话 (/api/v1/dialog)&quot;">​</a></h3><p>创建新的对话会话，为用户分配唯一的对话ID。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as 客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant API as 对话API</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Service as 对话服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant DB as 数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;API : POST /api/v1/dialog</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;API : 验证用户身份</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Service : create_dialog()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service-&gt;&gt;DB : 插入对话记录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB--&gt;&gt;Service : 返回对话ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Service--&gt;&gt;API : 对话信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API--&gt;&gt;Client : {dialog_id, name, agent_id}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/dialog.py#L29-L37" target="_blank" rel="noreferrer">dialog.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/dialog.py#L12-L16" target="_blank" rel="noreferrer">dialog.py</a></li></ul><p><strong>端点详情：</strong></p><ul><li><strong>路径</strong>: <code>/api/v1/dialog</code></li><li><strong>方法</strong>: <code>POST</code></li><li><strong>请求体</strong>:<div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;对话名称&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;agent_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;智能体ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;agent_type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Agent&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><strong>响应</strong>: 包含新创建对话的唯一标识符</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/dialog.py#L29-L37" target="_blank" rel="noreferrer">dialog.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/dialog.py#L12-L16" target="_blank" rel="noreferrer">dialog.py</a></li></ul><h3 id="发送消息-api-v1-chat" tabindex="-1">发送消息 (/api/v1/chat) <a class="header-anchor" href="#发送消息-api-v1-chat" aria-label="Permalink to &quot;发送消息 (/api/v1/chat)&quot;">​</a></h3><p>处理用户消息并返回流式响应。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as 客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant API as 聊天API</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Agent as 流式Agent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Memory as 记忆系统</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant History as 历史服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;API : POST /api/v1/chat</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;API : 获取Agent配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Agent : 初始化Agent实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Memory : 检索相关历史</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Memory--&gt;&gt;API : 历史上下文</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;Agent : astream(messages)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Agent : 处理工具调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent-&gt;&gt;Agent : 生成响应流</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Agent--&gt;&gt;API : 流式响应块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API-&gt;&gt;History : 保存对话记录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">API--&gt;&gt;Client : SSE流式响应</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py#L49-L121" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py#L229-L266" target="_blank" rel="noreferrer">chat.py</a></li></ul><p><strong>端点详情：</strong></p><ul><li><strong>路径</strong>: <code>/api/v1/chat</code></li><li><strong>方法</strong>: <code>POST</code></li><li><strong>请求体</strong>:<div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;dialog_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;对话ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;user_input&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;用户输入文本&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;file_url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;文件URL（可选）&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py#L49-L121" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/frontend/src/apis/chat.ts#L16-L61" target="_blank" rel="noreferrer">chat.py</a></li></ul><h2 id="websocket连接机制" tabindex="-1">WebSocket连接机制 <a class="header-anchor" href="#websocket连接机制" aria-label="Permalink to &quot;WebSocket连接机制&quot;">​</a></h2><p>系统支持WebSocket连接，主要用于实时性要求更高的场景，如自动构建工具等。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([客户端连接]) --&gt; Auth[JWT认证]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Auth --&gt; Connected{认证成功?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connected --&gt; |是| Accept[接受WebSocket连接]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connected --&gt; |否| Reject[拒绝连接]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Accept --&gt; Init[初始化客户端管理器]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Init --&gt; Run[运行聊天循环]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Run --&gt; Message{收到消息?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Message --&gt; |是| Process[处理消息]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Message --&gt; |否| Timeout{超时检查}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Process --&gt; Send[发送响应]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Send --&gt; Message</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Timeout --&gt; |未超时| Message</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Timeout --&gt; |超时| Disconnect[断开连接]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Disconnect --&gt; Cleanup[清理资源]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Reject --&gt; End([结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Cleanup --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/build.py#L15-L40" target="_blank" rel="noreferrer">build.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/manager.py#L45-L67" target="_blank" rel="noreferrer">manager.py</a></li></ul><p><strong>WebSocket特性：</strong></p><ul><li><strong>认证</strong>: 基于JWT的WebSocket认证</li><li><strong>连接管理</strong>: 自动化的连接生命周期管理</li><li><strong>错误处理</strong>: 完善的异常捕获和连接恢复机制</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/build.py#L15-L40" target="_blank" rel="noreferrer">build.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/manager.py#L13-L67" target="_blank" rel="noreferrer">manager.py</a></li></ul><h2 id="消息流式响应处理" tabindex="-1">消息流式响应处理 <a class="header-anchor" href="#消息流式响应处理" aria-label="Permalink to &quot;消息流式响应处理&quot;">​</a></h2><p>系统采用Server-Sent Events (SSE) 实现流式响应，支持实时消息传输。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class WatchedStreamingResponse {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+callback : Callable</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(content, callback)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+listen_for_disconnect(receive)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StreamingAgent {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+agent_config : AgentConfig</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+event_queue : Queue</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+stop_streaming : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+astream(messages)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+stop_streaming_callback()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+wrap_event(data)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class ReactAgent {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+model : BaseChatModel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+tools : List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+graph : StateGraph</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+astream(messages)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_call_tool_node(state)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_execute_tool_node(state)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WatchedStreamingResponse --&gt; StreamingAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StreamingAgent --&gt; ReactAgent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReactAgent --&gt; BaseChatModel</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py#L25-L48" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py#L103-L267" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/react_agent.py#L39-L279" target="_blank" rel="noreferrer">react_agent.py</a></li></ul><p><strong>流式响应格式：</strong></p><ul><li><strong>响应块</strong>: <code>data: {&quot;type&quot;: &quot;response_chunk&quot;, &quot;data&quot;: {&quot;chunk&quot;: &quot;文本片段&quot;}}</code></li><li><strong>事件通知</strong>: <code>data: {&quot;type&quot;: &quot;event&quot;, &quot;data&quot;: {&quot;title&quot;: &quot;工具名称&quot;, &quot;status&quot;: &quot;START&quot;}}</code></li><li><strong>错误处理</strong>: 自动兜底机制，确保响应完整性</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py#L25-L48" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py#L229-L267" target="_blank" rel="noreferrer">chat.py</a></li></ul><h2 id="对话管理" tabindex="-1">对话管理 <a class="header-anchor" href="#对话管理" aria-label="Permalink to &quot;对话管理&quot;">​</a></h2><h3 id="对话生命周期" tabindex="-1">对话生命周期 <a class="header-anchor" href="#对话生命周期" aria-label="Permalink to &quot;对话生命周期&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stateDiagram-v2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[*] --&gt; Created : 创建对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Created --&gt; Active : 开始对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Active --&gt; Processing : 处理消息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Processing --&gt; Active : 返回响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Active --&gt; Paused : 暂停对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Paused --&gt; Active : 恢复对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Active --&gt; Archived : 归档对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Archived --&gt; [*] : 删除对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Active --&gt; TimedOut : 超时处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TimedOut --&gt; [*] : 自动清理</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="对话历史管理" tabindex="-1">对话历史管理 <a class="header-anchor" href="#对话历史管理" aria-label="Permalink to &quot;对话历史管理&quot;">​</a></h3><p>系统提供两种历史记录模式：</p><ul><li><strong>传统模式</strong>: 基于数据库的历史记录查询</li><li><strong>向量化模式</strong>: 基于语义搜索的记忆检索</li></ul><p><strong>历史记录特性：</strong></p><ul><li><strong>持久化</strong>: 所有对话都保存到MySQL数据库</li><li><strong>检索</strong>: 支持基于相似度的上下文检索</li><li><strong>清理</strong>: 自动清理长时间未活动的对话</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/history.py#L17-L88" target="_blank" rel="noreferrer">history.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/dialog.py#L9-L64" target="_blank" rel="noreferrer">dialog.py</a></li></ul><h2 id="agent执行流程" tabindex="-1">Agent执行流程 <a class="header-anchor" href="#agent执行流程" aria-label="Permalink to &quot;Agent执行流程&quot;">​</a></h2><h3 id="react-agent工作流程" tabindex="-1">ReAct Agent工作流程 <a class="header-anchor" href="#react-agent工作流程" aria-label="Permalink to &quot;ReAct Agent工作流程&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始]) --&gt; Init[初始化Agent]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Init --&gt; SystemPrompt[添加系统提示词]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SystemPrompt --&gt; Messages[构建消息序列]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Messages --&gt; CallTool[调用工具节点]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CallTool --&gt; HasTools{有工具调用?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HasTools --&gt; |是| ExecuteTool[执行工具节点]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HasTools --&gt; |否| Generate[生成响应]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExecuteTool --&gt; ToolResult[获取工具结果]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ToolResult --&gt; Messages</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Generate --&gt; Stream[流式输出]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Stream --&gt; End([结束])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/react_agent.py#L82-L279" target="_blank" rel="noreferrer">react_agent.py</a></li></ul><h3 id="agent配置结构" tabindex="-1">Agent配置结构 <a class="header-anchor" href="#agent配置结构" aria-label="Permalink to &quot;Agent配置结构&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class AgentConfig {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_ids : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+knowledge_ids : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+tool_ids : List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+system_prompt : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+enable_memory : bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+name : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+user_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+llm_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StreamingAgent {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+agent_config : AgentConfig</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+tools : List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_agent_as_tools : List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+init_agent()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+astream(messages)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AgentConfig --&gt; StreamingAgent</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>图表来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py#L33-L42" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py#L103-L267" target="_blank" rel="noreferrer">chat.py</a></li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/agents/react_agent.py#L39-L279" target="_blank" rel="noreferrer">react_agent.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/chat.py#L33-L42" target="_blank" rel="noreferrer">chat.py</a></li></ul><h2 id="前端集成示例" tabindex="-1">前端集成示例 <a class="header-anchor" href="#前端集成示例" aria-label="Permalink to &quot;前端集成示例&quot;">​</a></h2><h3 id="使用fetcheventsource的集成" tabindex="-1">使用fetchEventSource的集成 <a class="header-anchor" href="#使用fetcheventsource的集成" aria-label="Permalink to &quot;使用fetchEventSource的集成&quot;">​</a></h3><p>前端使用Microsoft提供的fetchEventSource库实现SSE连接：</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 基本消息发送示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Chat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">onclose</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ctrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  fetchEventSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/v1/chat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;application/json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;Authorization&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Bearer \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">localStorage</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getItem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;token&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;}\`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    body: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      dialog_id: data.dialogId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      user_input: data.userInput,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      file_url: data.fileUrl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    signal: ctrl.signal,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    openWhenHidden: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onmessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        onmessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;处理消息时出错:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onclose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      onclose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onerror</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;聊天连接错误:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ctrl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">abort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctrl;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="vue-js组件集成" tabindex="-1">Vue.js组件集成 <a class="header-anchor" href="#vue-js组件集成" aria-label="Permalink to &quot;Vue.js组件集成&quot;">​</a></h3><p>前端Vue组件展示了完整的对话界面实现：</p><p><strong>功能特性：</strong></p><ul><li><strong>实时消息流</strong>: 支持增量消息显示</li><li><strong>工具调用状态</strong>: 实时显示工具执行状态</li><li><strong>文件上传</strong>: 支持附件消息</li><li><strong>错误处理</strong>: 完善的异常处理机制</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/frontend/src/apis/chat.ts#L16-L61" target="_blank" rel="noreferrer">chat.ts</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/frontend/src/pages/conversation/chatPage/chatPage.vue#L173-L200" target="_blank" rel="noreferrer">chatPage.vue</a></li></ul><h2 id="错误处理与超时策略" tabindex="-1">错误处理与超时策略 <a class="header-anchor" href="#错误处理与超时策略" aria-label="Permalink to &quot;错误处理与超时策略&quot;">​</a></h2><h3 id="错误处理机制" tabindex="-1">错误处理机制 <a class="header-anchor" href="#错误处理机制" aria-label="Permalink to &quot;错误处理机制&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Request[接收请求] --&gt; Validate[验证输入]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validate --&gt; Valid{输入有效?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Valid --&gt; |否| BadRequest[400 Bad Request]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Valid --&gt; |是| Process[处理请求]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Process --&gt; Success{处理成功?}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Success --&gt; |是| Response[返回响应]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Success --&gt; |否| Error[捕获异常]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Error --&gt; Log[记录日志]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Log --&gt; Fallback[兜底响应]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Fallback --&gt; Response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BadRequest --&gt; End([结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Response --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="超时与重试策略" tabindex="-1">超时与重试策略 <a class="header-anchor" href="#超时与重试策略" aria-label="Permalink to &quot;超时与重试策略&quot;">​</a></h3><ul><li><strong>连接超时</strong>: WebSocket连接超时自动重连</li><li><strong>处理超时</strong>: Agent处理超时返回默认消息</li><li><strong>内存清理</strong>: 定期清理过期对话和缓存</li><li><strong>降级处理</strong>: 网络异常时的本地缓存回退</li></ul><p><strong>节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/v1/chat.py#L253-L262" target="_blank" rel="noreferrer">chat.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/autobuild/manager.py#L55-L67" target="_blank" rel="noreferrer">manager.py</a></li></ul><h2 id="最佳实践" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践" aria-label="Permalink to &quot;最佳实践&quot;">​</a></h2><h3 id="api使用建议" tabindex="-1">API使用建议 <a class="header-anchor" href="#api使用建议" aria-label="Permalink to &quot;API使用建议&quot;">​</a></h3><ol><li><p><strong>对话管理</strong></p><ul><li>始终使用有效的对话ID</li><li>及时清理不需要的对话</li><li>合理设置对话超时时间</li></ul></li><li><p><strong>消息发送</strong></p><ul><li>控制单次消息长度</li><li>处理文件上传的并发限制</li><li>实现消息去重机制</li></ul></li><li><p><strong>错误处理</strong></p><ul><li>实现优雅的降级策略</li><li>提供清晰的错误信息</li><li>记录详细的调试信息</li></ul></li><li><p><strong>性能优化</strong></p><ul><li>使用连接池管理WebSocket连接</li><li>实现消息缓冲和批处理</li><li>合理使用缓存机制</li></ul></li></ol><h3 id="安全考虑" tabindex="-1">安全考虑 <a class="header-anchor" href="#安全考虑" aria-label="Permalink to &quot;安全考虑&quot;">​</a></h3><ul><li><strong>身份验证</strong>: 所有API请求都需要有效的JWT令牌</li><li><strong>输入验证</strong>: 严格验证用户输入内容</li><li><strong>速率限制</strong>: 实施API调用频率限制</li><li><strong>数据保护</strong>: 敏感数据加密存储</li></ul><h3 id="监控与维护" tabindex="-1">监控与维护 <a class="header-anchor" href="#监控与维护" aria-label="Permalink to &quot;监控与维护&quot;">​</a></h3><ul><li><strong>日志记录</strong>: 完整的请求和响应日志</li><li><strong>性能监控</strong>: 关键指标的实时监控</li><li><strong>健康检查</strong>: 定期的服务健康状态检查</li><li><strong>容量规划</strong>: 基于使用情况的资源规划</li></ul>`,93)])])}const d=a(l,[["render",t]]);export{g as __pageData,d as default};
