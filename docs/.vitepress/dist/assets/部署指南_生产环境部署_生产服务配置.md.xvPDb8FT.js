import{_ as a,c as r,o as l,ag as i}from"./chunks/framework.D0TaUBpX.js";const g=JSON.parse('{"title":"生产服务配置","description":"","frontmatter":{},"headers":[],"relativePath":"部署指南/生产环境部署/生产服务配置.md","filePath":"部署指南/生产环境部署/生产服务配置.md","lastUpdated":1764244560000}'),o={name:"部署指南/生产环境部署/生产服务配置.md"};function n(t,e,s,h,c,d){return l(),r("div",null,[...e[0]||(e[0]=[i(`<h1 id="生产服务配置" tabindex="-1">生产服务配置 <a class="header-anchor" href="#生产服务配置" aria-label="Permalink to &quot;生产服务配置&quot;">​</a></h1><cite> **本文档引用的文件** - [docker-compose.prod.yml](https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml) - [Dockerfile](https://github.com/Shy2593666979/AgentChat/docker/Dockerfile) - [Dockerfile.frontend.prod](https://github.com/Shy2593666979/AgentChat/docker/Dockerfile.frontend.prod) - [nginx.conf](https://github.com/Shy2593666979/AgentChat/docker/nginx.conf) - [start.sh](https://github.com/Shy2593666979/AgentChat/docker/start.sh) - [settings.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py) - [main.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#项目结构">项目结构</a></li><li><a href="#后端服务配置">后端服务配置</a></li><li><a href="#前端服务配置">前端服务配置</a></li><li><a href="#数据库服务配置">数据库服务配置</a></li><li><a href="#缓存服务配置">缓存服务配置</a></li><li><a href="#资源限制与性能优化">资源限制与性能优化</a></li><li><a href="#镜像构建与安全实践">镜像构建与安全实践</a></li><li><a href="#服务管理与监控">服务管理与监控</a></li><li><a href="#配置调整建议">配置调整建议</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>本文档详细说明基于<code>docker-compose.prod.yml</code>的生产级服务配置，涵盖后端、前端、MySQL数据库和Redis缓存的配置细节。文档重点解析Gunicorn多工作进程部署、前端构建优化、数据库性能调优、缓存持久化机制等关键配置，并提供资源限制设置原则和服务器规格调整建议。</p><h2 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-label="Permalink to &quot;项目结构&quot;">​</a></h2><p>本项目采用微服务架构，通过Docker Compose管理多个服务容器。主要包含后端API服务、前端Web界面、MySQL数据库和Redis缓存四个核心组件。所有服务配置通过Docker Compose文件定义，使用多阶段构建优化镜像大小和构建效率。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[前端 Frontend :8090] --&gt; B[后端 Backend :7860]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[MySQL :3306]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; D[Redis :6379]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style A fill:#4FC08D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style B fill:#009688</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style C fill:#4479A1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style D fill:#DC382D</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li></ul><h2 id="后端服务配置" tabindex="-1">后端服务配置 <a class="header-anchor" href="#后端服务配置" aria-label="Permalink to &quot;后端服务配置&quot;">​</a></h2><p>后端服务采用FastAPI框架，通过Gunicorn作为WSGI服务器实现多工作进程部署，以提升并发处理能力。在生产环境中，Gunicorn配置了4个工作进程，使用Uvicorn工作进程类来处理异步请求。</p><p>Gunicorn的关键配置参数包括：</p><ul><li><strong>worker数量</strong>: 设置为4个，充分利用多核CPU的并行处理能力</li><li><strong>worker类</strong>: 使用<code>uvicorn.workers.UvicornWorker</code>以支持ASGI应用</li><li><strong>绑定地址</strong>: 绑定到<code>0.0.0.0:7860</code>，允许外部访问</li><li><strong>预加载</strong>: 未显式配置，使用默认行为</li></ul><p>环境变量配置确保了生产环境的安全性和稳定性：</p><ul><li><code>APP_ENV=production</code>: 标识生产环境</li><li><code>LOG_LEVEL=warning</code>: 设置日志级别为警告，减少日志输出</li><li><code>DEBUG=false</code>: 关闭调试模式，提高安全性</li><li><code>HOT_RELOAD=false</code>: 关闭热重载，避免生产环境中的意外重启</li></ul><p>健康检查配置确保服务的可用性，通过定期调用<code>/health</code>端点验证服务状态。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L6-L20" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/main.py#L1-L108" target="_blank" rel="noreferrer">main.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/settings.py#L1-L62" target="_blank" rel="noreferrer">settings.py</a></li></ul><h2 id="前端服务配置" tabindex="-1">前端服务配置 <a class="header-anchor" href="#前端服务配置" aria-label="Permalink to &quot;前端服务配置&quot;">​</a></h2><p>前端服务采用Vue3 + Vite技术栈，通过多阶段Docker构建实现生产环境优化。构建过程分为两个阶段：构建阶段和生产运行阶段。</p><h3 id="构建流程" tabindex="-1">构建流程 <a class="header-anchor" href="#构建流程" aria-label="Permalink to &quot;构建流程&quot;">​</a></h3><ol><li><p><strong>构建阶段</strong>: 使用Node.js 18 Alpine镜像安装依赖并构建生产版本</p><ul><li>设置npm镜像源为国内镜像，加速依赖下载</li><li>使用<code>npm ci</code>安装生产依赖，确保依赖版本一致性</li><li>执行<code>npm run build</code>生成优化的静态资源</li></ul></li><li><p><strong>生产运行阶段</strong>: 使用Nginx Alpine镜像提供静态文件服务</p><ul><li>复制构建结果到Nginx默认目录</li><li>使用优化的Nginx配置提供高效静态文件服务</li></ul></li></ol><h3 id="优化策略" tabindex="-1">优化策略 <a class="header-anchor" href="#优化策略" aria-label="Permalink to &quot;优化策略&quot;">​</a></h3><p>前端配置实现了多项性能优化策略：</p><ul><li><strong>静态资源压缩</strong>: Nginx配置启用Gzip压缩，减少传输数据量</li><li><strong>缓存哈希</strong>: 静态资源文件名包含内容哈希，实现长期缓存</li><li><strong>资源缓存</strong>: 对JS、CSS、图片等静态资源设置1年缓存期</li><li><strong>HTML不缓存</strong>: HTML文件设置为不缓存，确保用户获取最新版本</li></ul><p>Nginx配置还包含安全设置，如隐藏服务器版本信息、防止点击劫持等。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[Node.js构建环境] --&gt; |安装依赖| B[依赖安装]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; |构建| C[生产版本构建]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; |复制| D[Nginx运行环境]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; |服务| E[静态文件服务]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[客户端浏览器]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/Dockerfile.frontend.prod#L1-L41" target="_blank" rel="noreferrer">Dockerfile.frontend.prod</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L1-L101" target="_blank" rel="noreferrer">nginx.conf</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/Dockerfile.frontend.prod#L1-L41" target="_blank" rel="noreferrer">Dockerfile.frontend.prod</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/nginx.conf#L1-L101" target="_blank" rel="noreferrer">nginx.conf</a></li></ul><h2 id="数据库服务配置" tabindex="-1">数据库服务配置 <a class="header-anchor" href="#数据库服务配置" aria-label="Permalink to &quot;数据库服务配置&quot;">​</a></h2><p>MySQL数据库在生产环境中进行了多项性能调优配置，以确保高并发场景下的稳定性和响应速度。</p><h3 id="性能调优参数" tabindex="-1">性能调优参数 <a class="header-anchor" href="#性能调优参数" aria-label="Permalink to &quot;性能调优参数&quot;">​</a></h3><ul><li><strong>InnoDB缓冲池大小</strong>: 设置为1GB (<code>--innodb-buffer-pool-size=1G</code>)，这是MySQL最重要的性能参数，用于缓存数据和索引，减少磁盘I/O</li><li><strong>最大连接数</strong>: 设置为1000 (<code>--max-connections=1000</code>)，支持高并发连接</li><li><strong>查询缓存</strong>: 启用查询缓存，大小设置为256MB (<code>--query-cache-size=256M</code>)，缓存SELECT查询结果</li></ul><h3 id="安全配置" tabindex="-1">安全配置 <a class="header-anchor" href="#安全配置" aria-label="Permalink to &quot;安全配置&quot;">​</a></h3><ul><li><strong>认证插件</strong>: 使用<code>mysql_native_password</code>作为默认认证插件，确保兼容性</li><li><strong>密码管理</strong>: 通过环境变量注入密码，避免硬编码</li></ul><p>这些配置在<code>docker-compose.prod.yml</code>中通过command指令直接传递给MySQL容器，确保了生产环境的性能需求。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L36-L48" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li></ul><h2 id="缓存服务配置" tabindex="-1">缓存服务配置 <a class="header-anchor" href="#缓存服务配置" aria-label="Permalink to &quot;缓存服务配置&quot;">​</a></h2><p>Redis作为缓存和会话存储服务，在生产环境中配置了持久化机制和内存管理策略。</p><h3 id="持久化机制" tabindex="-1">持久化机制 <a class="header-anchor" href="#持久化机制" aria-label="Permalink to &quot;持久化机制&quot;">​</a></h3><p>配置了AOF（Append Only File）持久化模式：</p><ul><li><code>--appendonly yes</code>: 启用AOF持久化，将每个写操作追加到日志文件中</li><li>这种配置在性能和数据安全性之间取得了平衡，相比RDB快照模式，AOF能提供更好的数据持久性</li></ul><h3 id="内存管理" tabindex="-1">内存管理 <a class="header-anchor" href="#内存管理" aria-label="Permalink to &quot;内存管理&quot;">​</a></h3><ul><li><strong>最大内存</strong>: 设置为512MB (<code>--maxmemory 512mb</code>)，防止Redis占用过多内存</li><li><strong>内存淘汰策略</strong>: 配置为<code>allkeys-lru</code>，当内存达到上限时，使用LRU（最近最少使用）算法淘汰键值对</li></ul><p>这种配置确保了Redis在内存受限的情况下仍能有效工作，同时通过AOF持久化保证了数据的可靠性。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L49-L52" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li></ul><h2 id="资源限制与性能优化" tabindex="-1">资源限制与性能优化 <a class="header-anchor" href="#资源限制与性能优化" aria-label="Permalink to &quot;资源限制与性能优化&quot;">​</a></h2><p>虽然当前配置中未显式设置Docker资源限制，但根据最佳实践，建议为各服务设置合理的CPU和内存限制。</p><h3 id="资源限制原则" tabindex="-1">资源限制原则 <a class="header-anchor" href="#资源限制原则" aria-label="Permalink to &quot;资源限制原则&quot;">​</a></h3><ul><li><strong>后端服务</strong>: 建议设置内存限制为1-2GB，CPU限制为1-2个核心</li><li><strong>前端服务</strong>: 由于是静态文件服务，资源需求较低，建议内存限制为256MB</li><li><strong>MySQL</strong>: 建议内存限制为总内存的50-75%，CPU限制为2-4个核心</li><li><strong>Redis</strong>: 建议内存限制略高于<code>maxmemory</code>配置，如600MB</li></ul><h3 id="性能优化建议" tabindex="-1">性能优化建议 <a class="header-anchor" href="#性能优化建议" aria-label="Permalink to &quot;性能优化建议&quot;">​</a></h3><ul><li><strong>连接池</strong>: 在应用层配置数据库连接池，避免频繁创建连接</li><li><strong>查询优化</strong>: 使用索引、避免N+1查询等问题</li><li><strong>缓存策略</strong>: 合理使用Redis缓存热点数据</li><li><strong>监控</strong>: 配置服务监控，及时发现性能瓶颈</li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/README.md#L1-L272" target="_blank" rel="noreferrer">README.md</a></li></ul><h2 id="镜像构建与安全实践" tabindex="-1">镜像构建与安全实践 <a class="header-anchor" href="#镜像构建与安全实践" aria-label="Permalink to &quot;镜像构建与安全实践&quot;">​</a></h2><p>镜像构建过程遵循安全与性能最佳实践，通过多阶段构建和精简基础镜像来优化。</p><h3 id="安全实践" tabindex="-1">安全实践 <a class="header-anchor" href="#安全实践" aria-label="Permalink to &quot;安全实践&quot;">​</a></h3><ul><li><strong>基础镜像</strong>: 使用Alpine Linux等轻量级基础镜像，减少攻击面</li><li><strong>依赖管理</strong>: 使用<code>pip install --no-cache-dir</code>避免缓存敏感信息</li><li><strong>环境变量</strong>: 敏感信息通过环境变量注入，不硬编码在镜像中</li><li><strong>权限控制</strong>: 运行容器时使用非root用户（建议）</li></ul><h3 id="性能实践" tabindex="-1">性能实践 <a class="header-anchor" href="#性能实践" aria-label="Permalink to &quot;性能实践&quot;">​</a></h3><ul><li><strong>多阶段构建</strong>: 分离构建环境和运行环境，减小最终镜像大小</li><li><strong>依赖优化</strong>: 使用<code>npm ci</code>和<code>--only=production</code>确保只安装生产依赖</li><li><strong>缓存利用</strong>: Docker层缓存加速重复构建</li><li><strong>镜像精简</strong>: 清理构建过程中的临时文件和包管理器缓存</li></ul><p>后端Dockerfile使用Python 3.12-slim基础镜像，安装必要的系统依赖后，复制并安装Python依赖，最后复制应用代码。这种分层构建方式充分利用了Docker的缓存机制。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/Dockerfile#L1-L39" target="_blank" rel="noreferrer">Dockerfile</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/Dockerfile.frontend.prod#L1-L41" target="_blank" rel="noreferrer">Dockerfile.frontend.prod</a></li></ul><h2 id="服务管理与监控" tabindex="-1">服务管理与监控 <a class="header-anchor" href="#服务管理与监控" aria-label="Permalink to &quot;服务管理与监控&quot;">​</a></h2><p>项目提供了一套完整的服务管理脚本，简化部署和维护操作。</p><h3 id="启动脚本" tabindex="-1">启动脚本 <a class="header-anchor" href="#启动脚本" aria-label="Permalink to &quot;启动脚本&quot;">​</a></h3><p><code>start.sh</code>脚本实现了自动化启动流程：</p><ol><li>检查环境变量配置文件，不存在时自动创建</li><li>创建必要的数据和日志目录</li><li>使用<code>docker-compose up --build -d</code>构建并启动所有服务</li><li>显示服务状态和访问信息</li></ol><h3 id="停止脚本" tabindex="-1">停止脚本 <a class="header-anchor" href="#停止脚本" aria-label="Permalink to &quot;停止脚本&quot;">​</a></h3><p><code>stop.sh</code>脚本提供了优雅的停止机制：</p><ol><li>停止所有容器</li><li>询问是否删除数据卷和构建缓存</li><li>提供清理选项，避免误删重要数据</li></ol><h3 id="监控建议" tabindex="-1">监控建议 <a class="header-anchor" href="#监控建议" aria-label="Permalink to &quot;监控建议&quot;">​</a></h3><ul><li>使用<code>docker stats</code>监控容器资源使用情况</li><li>配置健康检查，确保服务可用性</li><li>集中日志管理，便于故障排查</li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/start.sh#L1-L52" target="_blank" rel="noreferrer">start.sh</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/stop.sh#L1-L35" target="_blank" rel="noreferrer">stop.sh</a></li></ul><h2 id="配置调整建议" tabindex="-1">配置调整建议 <a class="header-anchor" href="#配置调整建议" aria-label="Permalink to &quot;配置调整建议&quot;">​</a></h2><p>根据服务器规格，建议调整配置以优化性能和资源利用率。</p><h3 id="小型服务器-4gb内存" tabindex="-1">小型服务器（4GB内存） <a class="header-anchor" href="#小型服务器-4gb内存" aria-label="Permalink to &quot;小型服务器（4GB内存）&quot;">​</a></h3><ul><li>减少Gunicorn工作进程到2个</li><li>MySQL缓冲池设置为512MB</li><li>Redis最大内存设置为256MB</li><li>总体资源使用控制在3GB以内</li></ul><h3 id="中型服务器-8gb内存" tabindex="-1">中型服务器（8GB内存） <a class="header-anchor" href="#中型服务器-8gb内存" aria-label="Permalink to &quot;中型服务器（8GB内存）&quot;">​</a></h3><ul><li>保持当前配置或增加Gunicorn工作进程到6个</li><li>MySQL缓冲池设置为2GB</li><li>Redis最大内存设置为1GB</li><li>可考虑增加应用实例实现负载均衡</li></ul><h3 id="大型服务器-16gb-内存" tabindex="-1">大型服务器（16GB+内存） <a class="header-anchor" href="#大型服务器-16gb-内存" aria-label="Permalink to &quot;大型服务器（16GB+内存）&quot;">​</a></h3><ul><li>增加Gunicorn工作进程到8-12个</li><li>MySQL缓冲池设置为4-8GB</li><li>Redis最大内存设置为2-4GB</li><li>考虑数据库和缓存的主从复制</li></ul><p>所有配置调整都应基于实际负载测试结果，避免过度配置导致资源浪费。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/docker/docker-compose.prod.yml#L1-L52" target="_blank" rel="noreferrer">docker-compose.prod.yml</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/docker/README.md#L1-L272" target="_blank" rel="noreferrer">README.md</a></li></ul>`,94)])])}const u=a(o,[["render",n]]);export{g as __pageData,u as default};
