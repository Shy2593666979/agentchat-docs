import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.7BqJGZTL.js";const E=JSON.parse('{"title":"MCP服务","description":"","frontmatter":{},"headers":[],"relativePath":"项目目录结构/后端目录结构/服务层/MCP服务.md","filePath":"项目目录结构/后端目录结构/服务层/MCP服务.md","lastUpdated":1764244560000}'),l={name:"项目目录结构/后端目录结构/服务层/MCP服务.md"};function p(t,s,r,h,c,k){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="mcp服务" tabindex="-1">MCP服务 <a class="header-anchor" href="#mcp服务" aria-label="Permalink to &quot;MCP服务&quot;">​</a></h1><cite> **本文档引用的文件** - [manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py) - [sessions.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/sessions.py) - [multi_client.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py) - [mcp_manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py) - [mcp_client.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py) - [mcp_arxiv.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/arxiv/mcp_arxiv.py) - [mcp_weather.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py) - [mcp_server.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/mcp_server.py) - [main.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py) - [mcp_server.json](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#mcp服务概述">MCP服务概述</a></li><li><a href="#mcp客户端管理">MCP客户端管理</a></li><li><a href="#会话生命周期管理">会话生命周期管理</a></li><li><a href="#多客户端连接支持">多客户端连接支持</a></li><li><a href="#openai兼容协议交互">OpenAI兼容协议交互</a></li><li><a href="#外部工具集成示例">外部工具集成示例</a></li><li><a href="#mcp服务扩展指南">MCP服务扩展指南</a></li></ol><h2 id="mcp服务概述" tabindex="-1">MCP服务概述 <a class="header-anchor" href="#mcp服务概述" aria-label="Permalink to &quot;MCP服务概述&quot;">​</a></h2><p>MCP（Modular Capability Provider）服务是一种模块化能力提供者架构，旨在通过标准化协议集成各种外部工具和服务。该架构允许系统动态加载和管理多个MCP服务器，为智能代理提供丰富的工具集。MCP服务的核心设计包括客户端管理、会话生命周期控制、多服务器连接支持以及与主流AI平台的兼容性。</p><p>MCP服务通过分层架构实现了灵活性和可扩展性，主要组件包括：</p><ul><li><strong>MCPManager</strong>：负责MCP客户端的加载、初始化和工具调用管理</li><li><strong>Sessions</strong>：处理不同传输类型的会话创建和管理</li><li><strong>MultiClient</strong>：支持连接多个MCP服务器</li><li><strong>MCP-OpenAI适配器</strong>：实现与OpenAI兼容的协议交互</li></ul><p>该服务架构支持多种传输协议，包括stdio、SSE（Server-Sent Events）、WebSocket和可流式HTTP，确保了与不同部署环境的兼容性。</p><h2 id="mcp客户端管理" tabindex="-1">MCP客户端管理 <a class="header-anchor" href="#mcp客户端管理" aria-label="Permalink to &quot;MCP客户端管理&quot;">​</a></h2><p>MCP客户端管理的核心是<code>manager.py</code>文件中的<code>MCPManager</code>类，它负责MCP客户端的加载、初始化和会话生命周期管理。该类通过配置化的连接信息管理多个MCP服务器实例。</p><p><code>MCPManager</code>的初始化过程接收一个MCP配置列表，将每个服务器的连接信息存储在<code>connection_info</code>字典中，并创建<code>MultiServerMCPClient</code>实例来管理这些连接。这种设计实现了配置与实现的分离，便于动态添加或移除MCP服务器。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPManager {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_configs List[MCPBaseConfig]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+multi_server_client MultiServerMCPClient</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+timeout int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(mcp_configs, timeout)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_mcp_tools() List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+show_mcp_tools() Dict</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+call_mcp_tools(tools_info) List</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MultiServerMCPClient {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+connections Dict[str, Connection]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(connections)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session(server_name) AsyncIterator[ClientSession]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_tools(server_name) List[BaseTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_prompt(server_name, prompt_name) List[Message]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+get_resources(server_name, uris) List[Blob]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager --&gt; MultiServerMCPClient : &quot;使用&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py#L13-L103" target="_blank" rel="noreferrer">manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py#L42-L226" target="_blank" rel="noreferrer">multi_client.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/manager.py#L13-L103" target="_blank" rel="noreferrer">manager.py</a></li></ul><h2 id="会话生命周期管理" tabindex="-1">会话生命周期管理 <a class="header-anchor" href="#会话生命周期管理" aria-label="Permalink to &quot;会话生命周期管理&quot;">​</a></h2><p>会话管理是MCP服务的核心功能之一，由<code>sessions.py</code>文件实现。该模块提供了对不同MCP传输类型（stdio、SSE、WebSocket、可流式HTTP）的连接配置和会话管理。</p><p>会话管理模块定义了四种主要的连接类型：</p><ul><li><strong>StdioConnection</strong>：用于通过标准输入/输出与MCP服务器通信</li><li><strong>SSEConnection</strong>：用于通过服务器发送事件（Server-Sent Events）与MCP服务器通信</li><li><strong>StreamableHttpConnection</strong>：用于通过可流式HTTP协议与MCP服务器通信</li><li><strong>WebsocketConnection</strong>：用于通过WebSocket协议与MCP服务器通信</li></ul><p>每个连接类型都包含特定的配置参数，如传输类型、URL、超时设置等。核心的<code>create_session</code>函数作为异步上下文管理器，根据连接配置的传输类型创建相应的会话。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class Connection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&lt;union&gt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StdioConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport &quot;stdio&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+command str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+args list[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+env dict[str, str] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+cwd str | Path | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+encoding str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+encoding_error_handler EncodingErrorHandler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class SSEConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport &quot;sse&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+headers dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+timeout float</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+sse_read_timeout float</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+httpx_client_factory McpHttpClientFactory | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+auth httpx.Auth</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class StreamableHttpConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport &quot;streamable_http&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+headers dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+timeout timedelta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+sse_read_timeout timedelta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+terminate_on_close bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+httpx_client_factory McpHttpClientFactory | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+auth httpx.Auth</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class WebsocketConnection {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+transport &quot;websocket&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+url str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session_kwargs dict[str, Any] | None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connection &lt;|-- StdioConnection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connection &lt;|-- SSEConnection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connection &lt;|-- StreamableHttpConnection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connection &lt;|-- WebsocketConnection</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/sessions.py#L60-L177" target="_blank" rel="noreferrer">sessions.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/sessions.py#L1-L412" target="_blank" rel="noreferrer">sessions.py</a></li></ul><h2 id="多客户端连接支持" tabindex="-1">多客户端连接支持 <a class="header-anchor" href="#多客户端连接支持" aria-label="Permalink to &quot;多客户端连接支持&quot;">​</a></h2><p><code>multi_client.py</code>文件实现了<code>MultiServerMCPClient</code>类，为系统提供了连接多个MCP服务器的能力。该类是MCP架构的关键组件，允许同时管理多个外部服务。</p><p><code>MultiServerMCPClient</code>的核心功能包括：</p><ul><li><strong>会话管理</strong>：通过<code>session()</code>方法为指定服务器创建和管理会话</li><li><strong>工具获取</strong>：通过<code>get_tools()</code>方法从一个或所有连接的服务器获取工具列表</li><li><strong>提示词获取</strong>：通过<code>get_prompt()</code>方法从指定服务器获取提示词</li><li><strong>资源获取</strong>：通过<code>get_resources()</code>方法从指定服务器获取资源</li></ul><p>该类的设计采用了异步上下文管理器模式，确保会话的正确创建和清理。<code>get_tools()</code>方法支持并发获取多个服务器的工具，提高了系统响应速度。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Client as &quot;客户端&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MultiClient as &quot;MultiServerMCPClient&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant Session as &quot;ClientSession&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant MCP as &quot;MCP服务器&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Client-&gt;&gt;MultiClient : get_tools()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiClient-&gt;&gt;MultiClient : 遍历所有连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop 每个连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiClient-&gt;&gt;Session : create_session()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session-&gt;&gt;MCP : 建立连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session-&gt;&gt;MCP : initialize()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCP--&gt;&gt;Session : 服务器信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Session-&gt;&gt;MultiClient : 返回会话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiClient-&gt;&gt;MCP : list_tools()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCP--&gt;&gt;MultiClient : 工具列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiClient-&gt;&gt;MultiClient : 转换为LangChain工具</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiClient--&gt;&gt;Client : 返回所有工具</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py#L42-L226" target="_blank" rel="noreferrer">multi_client.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp/multi_client.py#L42-L226" target="_blank" rel="noreferrer">multi_client.py</a></li></ul><h2 id="openai兼容协议交互" tabindex="-1">OpenAI兼容协议交互 <a class="header-anchor" href="#openai兼容协议交互" aria-label="Permalink to &quot;OpenAI兼容协议交互&quot;">​</a></h2><p><code>mcp_openai/</code>目录下的组件实现了与OpenAI兼容的MCP协议交互，使系统能够与遵循OpenAI API规范的AI模型进行通信。核心组件是<code>mcp_manager.py</code>中的<code>MCPManager</code>类。</p><p>该实现的主要特点包括：</p><ul><li><strong>多模型支持</strong>：支持Anthropic和OpenAI客户端</li><li><strong>工具集成</strong>：能够将MCP服务器的工具注册为AI模型可用的函数工具</li><li><strong>对话处理</strong>：实现完整的对话循环，包括工具调用和结果处理</li></ul><p><code>MCPManager</code>通过<code>enter_mcp_server()</code>方法添加MCP服务器地址，然后通过<code>connect_client()</code>方法建立连接。<code>list_all_server_tools()</code>方法收集所有MCP服务器的可用工具，并将其转换为OpenAI兼容的函数工具格式。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPManager {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_server_stack List[str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+chat_client Union[DeepAsyncAnthropic, DeepAnthropic]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+mcp_clients List[MCPClient]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_client_dict Dict[str, MCPClient]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+server_path_env_dict Dict[str, str]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+callable_mcp_tools Dict[str, FunctionTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+enter_mcp_server(server_path, server_env)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+connect_client()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+list_all_server_tools() List[FunctionTool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_chat_model(messages, available_tools)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+process_query(messages)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+_get_tool_response(name, arguments)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MCPClient {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+session Optional[ClientSession]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+exit_stack AsyncExitStack</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+connect_to_server(server_path, server_env)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+list_server_tools() List[Tool]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+list_server_prompts() List[Prompt]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+list_server_resources() List[Resource]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+call_server_tool(name, arguments) CallToolResult</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class FunctionTool {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+name str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+description str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+params_json_schema Dict[str, Any]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+on_run_tool Callable[[str], Awaitable[Any]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+strict_json_schema bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__init__(name, description, params_json_schema, on_run_tool, strict_json_schema)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager --&gt; MCPClient : &quot;管理&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPManager --&gt; FunctionTool : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MCPClient --&gt; ClientSession : &quot;使用&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py#L13-L118" target="_blank" rel="noreferrer">mcp_manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_client.py#L10-L53" target="_blank" rel="noreferrer">mcp_client.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/mcp_openai/mcp_manager.py#L13-L118" target="_blank" rel="noreferrer">mcp_manager.py</a></li></ul><h2 id="外部工具集成示例" tabindex="-1">外部工具集成示例 <a class="header-anchor" href="#外部工具集成示例" aria-label="Permalink to &quot;外部工具集成示例&quot;">​</a></h2><p>MCP架构通过具体的实现示例展示了外部工具的集成流程。以下是几个典型的MCP实现：</p><h3 id="arxiv集成" tabindex="-1">Arxiv集成 <a class="header-anchor" href="#arxiv集成" aria-label="Permalink to &quot;Arxiv集成&quot;">​</a></h3><p><code>mcp_arxiv.py</code>文件展示了如何集成Arxiv学术论文搜索功能。该实现使用<code>langchain_community.utilities</code>中的<code>ArxivAPIWrapper</code>来查询学术论文。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mcp.server.fastmcp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FastMCP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langchain_community.utilities </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArxivAPIWrapper</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arxiv_wrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArxivAPIWrapper()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mcp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FastMCP(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MCP-Arxiv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@mcp.tool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_arxiv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(query: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;为用户提供Arxiv上的论文</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        query: 用户问题</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    docs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arxiv_wrapper.run(query)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> docs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="天气服务集成" tabindex="-1">天气服务集成 <a class="header-anchor" href="#天气服务集成" aria-label="Permalink to &quot;天气服务集成&quot;">​</a></h3><p><code>mcp_weather.py</code>文件实现了天气查询功能，通过调用外部天气API获取指定位置的天气信息。该实现展示了如何处理环境变量和API密钥。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requests</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mcp.server </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FastMCP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dotenv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> load_dotenv</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">load_dotenv()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mcp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FastMCP(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MCP-Weather&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">weather_api_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;weather_api_key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">weather_endpoint </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;weather_endpoint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@mcp.tool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_weather</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(location: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;帮助用户想要查询的天气</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        location: 查询天气的位置</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 实现细节...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="飞书集成" tabindex="-1">飞书集成 <a class="header-anchor" href="#飞书集成" aria-label="Permalink to &quot;飞书集成&quot;">​</a></h3><p>飞书（Lark）集成通过<code>lark_mcp/</code>目录实现，展示了更复杂的工具集注册模式。<code>mcp_server.py</code>文件通过<code>register_mcp_server()</code>函数集中注册多个工具。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> register_mcp_server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mcp: FastMCP):</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 用户管理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mcp.tool(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">batch_get_user_info.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__doc__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(batch_get_user_info)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 日程管理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mcp.tool(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">create_calendar_event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__doc__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(create_calendar_event)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ...其他工具</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这些示例展示了MCP工具集成的通用模式：</p><ol><li>创建<code>FastMCP</code>实例</li><li>定义工具函数并使用<code>@mcp.tool()</code>装饰器注册</li><li>在<code>if __name__ == &quot;__main__&quot;:</code>块中启动服务器</li></ol><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/arxiv/mcp_arxiv.py#L1-L19" target="_blank" rel="noreferrer">mcp_arxiv.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py#L1-L63" target="_blank" rel="noreferrer">mcp_weather.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/mcp_server.py#L1-L54" target="_blank" rel="noreferrer">mcp_server.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/main.py#L1-L31" target="_blank" rel="noreferrer">main.py</a></li></ul><h2 id="mcp服务扩展指南" tabindex="-1">MCP服务扩展指南 <a class="header-anchor" href="#mcp服务扩展指南" aria-label="Permalink to &quot;MCP服务扩展指南&quot;">​</a></h2><h3 id="注册新的mcp服务器" tabindex="-1">注册新的MCP服务器 <a class="header-anchor" href="#注册新的mcp服务器" aria-label="Permalink to &quot;注册新的MCP服务器&quot;">​</a></h3><p>要注册新的MCP服务器，需要在<code>config/mcp_server.json</code>文件中添加服务器配置。该文件是一个JSON数组，每个元素代表一个MCP服务器。</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;server_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;服务器名称&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;服务器URL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;传输类型(sse/stdio/streamable-http)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;config&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;params&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {},</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;config_enabled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;logo_url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;服务器logo URL&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="定义工具集" tabindex="-1">定义工具集 <a class="header-anchor" href="#定义工具集" aria-label="Permalink to &quot;定义工具集&quot;">​</a></h3><p>定义MCP工具集的基本步骤：</p><ol><li>创建新的Python文件或模块</li><li>导入必要的依赖</li><li>创建<code>FastMCP</code>实例</li><li>使用<code>@mcp.tool()</code>装饰器定义工具函数</li><li>在主程序块中启动服务器</li></ol><p>工具函数的参数会自动转换为JSON Schema，文档字符串（docstring）中的<code>Args</code>部分会作为参数描述。</p><h3 id="处理响应格式" tabindex="-1">处理响应格式 <a class="header-anchor" href="#处理响应格式" aria-label="Permalink to &quot;处理响应格式&quot;">​</a></h3><p>MCP工具的响应格式需要遵循特定规范：</p><ul><li>返回字符串或结构化数据</li><li>使用<code>CallToolResult</code>处理复杂响应</li><li>对于错误情况，抛出<code>ToolException</code>或返回错误信息</li></ul><h3 id="配置管理" tabindex="-1">配置管理 <a class="header-anchor" href="#配置管理" aria-label="Permalink to &quot;配置管理&quot;">​</a></h3><p>MCP服务器支持环境变量配置，可以通过<code>os.getenv()</code>获取配置值。对于需要用户配置的参数，可以在<code>config</code>字段中定义配置项。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">weather_api_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;weather_api_key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="传输协议选择" tabindex="-1">传输协议选择 <a class="header-anchor" href="#传输协议选择" aria-label="Permalink to &quot;传输协议选择&quot;">​</a></h3><p>根据部署需求选择合适的传输协议：</p><ul><li><strong>stdio</strong>：适用于本地运行的服务器</li><li><strong>sse</strong>：适用于Web服务，支持服务器推送</li><li><strong>streamable-http</strong>：适用于需要流式响应的场景</li><li><strong>websocket</strong>：适用于双向通信需求</li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config/mcp_server.json#L1-L40" target="_blank" rel="noreferrer">mcp_server.json</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/arxiv/mcp_arxiv.py#L1-L19" target="_blank" rel="noreferrer">mcp_arxiv.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/weather/mcp_weather.py#L1-L63" target="_blank" rel="noreferrer">mcp_weather.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/mcp_servers/lark_mcp/mcp_server.py#L1-L54" target="_blank" rel="noreferrer">mcp_server.py</a></li></ul>`,81)])])}const d=a(l,[["render",p]]);export{E as __pageData,d as default};
