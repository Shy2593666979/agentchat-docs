import{_ as a,c as n,o as e,ag as i}from"./chunks/framework.D0TaUBpX.js";const k=JSON.parse('{"title":"文本向量化","description":"","frontmatter":{},"headers":[],"relativePath":"数据库设计/向量存储架构/文档解析与向量化/文本向量化.md","filePath":"数据库设计/向量存储架构/文档解析与向量化/文本向量化.md","lastUpdated":1764244560000}'),r={name:"数据库设计/向量存储架构/文档解析与向量化/文本向量化.md"};function l(t,s,p,h,c,g){return e(),n("div",null,[...s[0]||(s[0]=[i(`<h1 id="文本向量化" tabindex="-1">文本向量化 <a class="header-anchor" href="#文本向量化" aria-label="Permalink to &quot;文本向量化&quot;">​</a></h1><cite> **本文档中引用的文件** - [embedding.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py) - [embedding.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/embedding.py) - [parser.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py) - [chunk.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chunk.py) - [manager.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/manager.py) - [chroma.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py) - [milvus.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/milvus.py) - [vector_stores/__init__.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/__init__.py) - [rag_handler.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py) - [config.yaml](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#简介">简介</a></li><li><a href="#项目结构">项目结构</a></li><li><a href="#核心组件">核心组件</a></li><li><a href="#架构概述">架构概述</a></li><li><a href="#详细组件分析">详细组件分析</a></li><li><a href="#依赖分析">依赖分析</a></li><li><a href="#性能考虑">性能考虑</a></li><li><a href="#故障排除指南">故障排除指南</a></li><li><a href="#结论">结论</a></li></ol><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>本文档详细说明了AgentChat系统中文本向量化的实现过程。重点分析了<code>embedding.py</code>如何利用<code>ModelManager</code>加载配置的嵌入模型（如text-embedding系列），并将<code>parser.py</code>输出的文本块（ChunkModel）批量转换为向量表示。文档解释了向量化过程中的批处理机制、并发控制、错误重试策略以及与向量数据库（如Chroma/Milvus）的写入集成方式。通过代码示例展示了从文本块到向量存储的完整流水线，包括元数据注入、向量维度一致性校验和性能调优参数（如batch_size）。同时讨论了模型切换、向量质量评估及资源消耗监控等高级话题。</p><h2 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-label="Permalink to &quot;项目结构&quot;">​</a></h2><p>AgentChat项目的文本向量化功能主要分布在<code>src/backend/agentchat</code>目录下的多个子模块中。核心功能分布在<code>core/models</code>和<code>services/rag</code>两个主要目录中，其中<code>core/models</code>包含基础模型管理，<code>services/rag</code>包含文档解析和向量处理服务。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[文本向量化系统] --&gt; B[文档解析]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; C[嵌入模型]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A --&gt; D[向量存储]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; B1[parser.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; B2[doc_parser/]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; C1[embedding.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; C2[ModelManager]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; D1[ChromaDB]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D --&gt; D2[Milvus]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B1 --&gt; |输出文本块| C1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C1 --&gt; |生成向量| D1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C1 --&gt; |生成向量| D2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L1-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py#L1-L60" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py#L1-L255" target="_blank" rel="noreferrer">chroma.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/milvus.py" target="_blank" rel="noreferrer">milvus.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py" target="_blank" rel="noreferrer">embedding.py</a></li></ul><h2 id="核心组件" tabindex="-1">核心组件 <a class="header-anchor" href="#核心组件" aria-label="Permalink to &quot;核心组件&quot;">​</a></h2><p>文本向量化流程的核心组件包括文档解析器（DocParser）、嵌入模型（EmbeddingModel）、模型管理器（ModelManager）和向量存储（VectorStore）。文档解析器负责将各种格式的文档分割成文本块，嵌入模型负责将文本块转换为向量表示，模型管理器负责加载和管理嵌入模型实例，向量存储负责持久化存储生成的向量。</p><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py#L7-L60" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L13-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/manager.py#L10-L63" target="_blank" rel="noreferrer">manager.py</a></li></ul><h2 id="架构概述" tabindex="-1">架构概述 <a class="header-anchor" href="#架构概述" aria-label="Permalink to &quot;架构概述&quot;">​</a></h2><p>文本向量化系统的整体架构采用分层设计，从文档输入到向量存储形成完整的处理流水线。系统首先通过文档解析器将原始文档解析为结构化的文本块，然后通过嵌入模型将文本块转换为向量表示，最后将向量及其元数据存储到向量数据库中。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 文档 as 原始文档</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 解析器 as DocParser</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 嵌入模型 as EmbeddingModel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 向量存储 as VectorStore</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">文档-&gt;&gt;解析器 : 上传文档</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">解析器-&gt;&gt;解析器 : 解析文档格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">解析器-&gt;&gt;解析器 : 分割为文本块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">解析器-&gt;&gt;嵌入模型 : 发送文本块列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;嵌入模型 : 批量生成向量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;向量存储 : 发送向量和元数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">向量存储-&gt;&gt;向量存储 : 存储到Chroma/Milvus</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">向量存储--&gt;&gt;嵌入模型 : 存储确认</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型--&gt;&gt;解析器 : 向量化完成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">解析器--&gt;&gt;文档 : 处理完成通知</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note over 嵌入模型,向量存储 : 批量处理10个文本块&lt;br/&gt;并发限制为5个任务</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L13-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py#L27-L59" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py#L113-L129" target="_blank" rel="noreferrer">chroma.py</a></li></ul><h2 id="详细组件分析" tabindex="-1">详细组件分析 <a class="header-anchor" href="#详细组件分析" aria-label="Permalink to &quot;详细组件分析&quot;">​</a></h2><h3 id="文档解析组件分析" tabindex="-1">文档解析组件分析 <a class="header-anchor" href="#文档解析组件分析" aria-label="Permalink to &quot;文档解析组件分析&quot;">​</a></h3><p>文档解析组件（DocParser）负责处理多种格式的文档（PDF、DOCX、TXT、MD等），将其解析为统一的文本块结构。解析器根据文件后缀选择相应的解析器实现，并支持在解析后对文本块生成摘要。</p><h4 id="类图" tabindex="-1">类图 <a class="header-anchor" href="#类图" aria-label="Permalink to &quot;类图&quot;">​</a></h4><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class DocParser {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+parse_doc_into_chunks(file_id, file_path, knowledge_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+generate_summary(chunk, semaphore)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class ChunkModel {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+chunk_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+content</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+file_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+file_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+knowledge_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+summary</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+to_dict()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class MarkdownParser {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+parse_into_chunks(file_id, file_path, knowledge_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class PdfParser {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+parse_into_chunks(file_id, file_path, knowledge_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class DocxParser {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+parse_into_chunks(file_id, file_path, knowledge_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class TextParser {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+parse_into_chunks(file_id, file_path, knowledge_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DocParser --&gt; ChunkModel : &quot;生成&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DocParser --&gt; MarkdownParser : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DocParser --&gt; PdfParser : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DocParser --&gt; DocxParser : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DocParser --&gt; TextParser : &quot;使用&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MarkdownParser --&gt; ChunkModel : &quot;生成&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PdfParser --&gt; ChunkModel : &quot;生成&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DocxParser --&gt; ChunkModel : &quot;生成&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TextParser --&gt; ChunkModel : &quot;生成&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L13-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chunk.py#L1-L20" target="_blank" rel="noreferrer">chunk.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/markdown.py" target="_blank" rel="noreferrer">markdown.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/doc_parser/pdf.py" target="_blank" rel="noreferrer">pdf.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py#L13-L58" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/chunk.py#L1-L20" target="_blank" rel="noreferrer">chunk.py</a></li></ul><h3 id="嵌入模型组件分析" tabindex="-1">嵌入模型组件分析 <a class="header-anchor" href="#嵌入模型组件分析" aria-label="Permalink to &quot;嵌入模型组件分析&quot;">​</a></h3><p>嵌入模型组件（EmbeddingModel）负责将文本内容转换为向量表示。模型通过ModelManager从配置中加载，并支持同步和异步两种调用方式。对于大量文本的处理，模型实现了批处理和并发控制机制。</p><h4 id="序列图" tabindex="-1">序列图 <a class="header-anchor" href="#序列图" aria-label="Permalink to &quot;序列图&quot;">​</a></h4><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 应用 as 应用程序</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 模型管理器 as ModelManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant 嵌入模型 as EmbeddingModel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">participant OpenAI as OpenAI API</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">应用-&gt;&gt;模型管理器 : get_embedding_model()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">模型管理器-&gt;&gt;模型管理器 : 从配置加载参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">模型管理器--&gt;&gt;应用 : 返回EmbeddingModel实例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">应用-&gt;&gt;嵌入模型 : embed_async(文本列表)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;嵌入模型 : 检查列表长度</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alt 文本数量 ≤ 10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;OpenAI : 单次API调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">OpenAI--&gt;&gt;嵌入模型 : 返回向量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">else 文本数量 &gt; 10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;嵌入模型 : 分割为10个一批的批次</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;嵌入模型 : 创建信号量(并发数=5)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop 每个批次</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;OpenAI : 并发API调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型-&gt;&gt;嵌入模型 : 合并所有结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">嵌入模型--&gt;&gt;应用 : 返回向量列表</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py#L7-L59" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/manager.py#L57-L63" target="_blank" rel="noreferrer">manager.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py#L7-L59" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/manager.py#L57-L63" target="_blank" rel="noreferrer">manager.py</a></li></ul><h3 id="向量存储组件分析" tabindex="-1">向量存储组件分析 <a class="header-anchor" href="#向量存储组件分析" aria-label="Permalink to &quot;向量存储组件分析&quot;">​</a></h3><p>向量存储组件负责将生成的向量及其元数据持久化存储到向量数据库中。系统支持Chroma和Milvus两种向量数据库，并通过统一的接口进行管理。</p><h4 id="流程图" tabindex="-1">流程图 <a class="header-anchor" href="#流程图" aria-label="Permalink to &quot;流程图&quot;">​</a></h4><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始]) --&gt; CheckDB[&quot;检查向量数据库类型&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckDB --&gt; |Chroma| ChromaDB[&quot;初始化ChromaDB&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckDB --&gt; |Milvus| MilvusDB[&quot;初始化Milvus&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ChromaDB --&gt; CreateCol[&quot;创建或获取集合&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MilvusDB --&gt; CreateCol</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CreateCol --&gt; PrepareData[&quot;准备数据:&lt;br/&gt;- 向量列表&lt;br/&gt;- 元数据列表&lt;br/&gt;- ID列表&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PrepareData --&gt; InsertData[&quot;调用insert方法&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InsertData --&gt; Validate[&quot;验证插入结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validate --&gt; |成功| Success[&quot;返回成功状态&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Validate --&gt; |失败| Error[&quot;记录错误并重试&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Error --&gt; Retry[&quot;重试机制&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Retry --&gt; InsertData</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Success --&gt; End([结束])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Error --&gt; End</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py#L23-L129" target="_blank" rel="noreferrer">chroma.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/milvus.py" target="_blank" rel="noreferrer">milvus.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/__init__.py#L4-L14" target="_blank" rel="noreferrer">vector_stores/<strong>init</strong>.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py#L23-L129" target="_blank" rel="noreferrer">chroma.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/__init__.py#L4-L14" target="_blank" rel="noreferrer">vector_stores/<strong>init</strong>.py</a></li></ul><h2 id="依赖分析" tabindex="-1">依赖分析 <a class="header-anchor" href="#依赖分析" aria-label="Permalink to &quot;依赖分析&quot;">​</a></h2><p>文本向量化系统的组件之间存在明确的依赖关系。文档解析器依赖于嵌入模型进行向量化处理，嵌入模型依赖于模型管理器进行实例化，而向量存储则依赖于嵌入模型生成的向量数据。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A[parser.py] --&gt; B[embedding.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; C[manager.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; D[config.yaml]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C --&gt; D</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B --&gt; E[vector_stores/]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; F[chroma.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">E --&gt; G[milvus.py]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H[rag_handler.py] --&gt; B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">H --&gt; E</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style A fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style B fill:#bbf,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style C fill:#f96,stroke:#333</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/manager.py" target="_blank" rel="noreferrer">manager.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py" target="_blank" rel="noreferrer">chroma.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag_handler.py" target="_blank" rel="noreferrer">rag_handler.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/rag/parser.py" target="_blank" rel="noreferrer">parser.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/manager.py" target="_blank" rel="noreferrer">manager.py</a></li></ul><h2 id="性能考虑" tabindex="-1">性能考虑 <a class="header-anchor" href="#性能考虑" aria-label="Permalink to &quot;性能考虑&quot;">​</a></h2><p>文本向量化系统的性能优化主要体现在以下几个方面：</p><ol><li><strong>批处理机制</strong>：系统将文本块按每批10个进行分组处理，减少了API调用次数，提高了处理效率。</li><li><strong>并发控制</strong>：通过<code>asyncio.Semaphore(5)</code>限制并发数为5，避免了对嵌入模型API的过度请求。</li><li><strong>异步处理</strong>：采用异步编程模型，允许在等待API响应时处理其他任务，提高了资源利用率。</li><li><strong>配置优化</strong>：通过配置文件集中管理嵌入模型的参数，便于性能调优和模型切换。</li></ol><p>这些优化措施确保了系统在处理大量文档时仍能保持良好的性能表现。</p><h2 id="故障排除指南" tabindex="-1">故障排除指南 <a class="header-anchor" href="#故障排除指南" aria-label="Permalink to &quot;故障排除指南&quot;">​</a></h2><p>在文本向量化过程中可能遇到的常见问题及解决方案：</p><ol><li><strong>API调用失败</strong>：检查<code>config.yaml</code>中的API密钥和基础URL配置是否正确。</li><li><strong>向量维度不一致</strong>：确保同一知识库中所有文档使用相同的嵌入模型。</li><li><strong>内存溢出</strong>：对于超大文档，调整批处理大小或增加系统内存。</li><li><strong>向量数据库连接失败</strong>：检查Chroma/Milvus服务是否正常运行，网络连接是否通畅。</li></ol><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/core/models/embedding.py#L41-L42" target="_blank" rel="noreferrer">embedding.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/services/memory/vector_stores/chroma.py#L23-L255" target="_blank" rel="noreferrer">chroma.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/config.yaml" target="_blank" rel="noreferrer">config.yaml</a></li></ul><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>AgentChat系统的文本向量化实现了一个高效、可扩展的文档处理流水线。通过合理的架构设计和性能优化，系统能够稳定地将各种格式的文档转换为向量表示，并存储到向量数据库中。未来可以进一步优化的方向包括：实现更智能的批处理策略、增加向量质量评估机制、优化资源消耗监控等。</p>`,65)])])}const d=a(r,[["render",l]]);export{k as __pageData,d as default};
