import{_ as s,c as e,o as n,ag as i}from"./chunks/framework.7BqJGZTL.js";const k=JSON.parse('{"title":"消息记录数据模型","description":"","frontmatter":{},"headers":[],"relativePath":"数据库设计/关系型数据模型/消息记录数据模型.md","filePath":"数据库设计/关系型数据模型/消息记录数据模型.md","lastUpdated":1764244560000}'),t={name:"数据库设计/关系型数据模型/消息记录数据模型.md"};function l(r,a,p,h,o,d){return n(),e("div",null,[...a[0]||(a[0]=[i(`<h1 id="消息记录数据模型" tabindex="-1">消息记录数据模型 <a class="header-anchor" href="#消息记录数据模型" aria-label="Permalink to &quot;消息记录数据模型&quot;">​</a></h1><cite> **本文档引用的文件** - [message.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/schema/message.py) - [history.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py) - [dialog.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py) - [history.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/api/services/history.py) - [history.py](https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/history.py) </cite><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ol><li><a href="#引言">引言</a></li><li><a href="#核心数据结构">核心数据结构</a></li><li><a href="#字段语义与技术细节">字段语义与技术细节</a></li><li><a href="#与对话模型的关联">与对话模型的关联</a></li><li><a href="#文本存储与token计数">文本存储与Token计数</a></li><li><a href="#大规模存储性能挑战">大规模存储性能挑战</a></li><li><a href="#dao层实现与查询机制">DAO层实现与查询机制</a></li><li><a href="#索引优化建议">索引优化建议</a></li><li><a href="#结论">结论</a></li></ol><h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>在AgentChat系统中，消息记录是对话历史的基本单元，承载着用户与AI代理之间的交互内容。本文件深入阐述Message模型的设计与实现，重点分析其作为对话历史基本单元的重要性，以及如何通过<code>dialog_id</code>与Dialog模型建立强关联。我们将探讨<code>content</code>字段的文本存储策略、<code>token_count</code>的计算时机与用途（如成本统计），并分析大规模消息存储下的性能挑战。结合DAO层实现，说明分页查询、按对话加载历史消息的实现方式，并提供索引优化建议。</p><h2 id="核心数据结构" tabindex="-1">核心数据结构 <a class="header-anchor" href="#核心数据结构" aria-label="Permalink to &quot;核心数据结构&quot;">​</a></h2><p>消息记录在系统中主要通过<code>HistoryTable</code>类来表示，该类定义了消息的核心属性和行为。<code>HistoryTable</code>继承自<code>SQLModelSerializable</code>，并映射到数据库中的<code>history</code>表。每个消息实例都包含角色、内容、对话ID、事件信息以及创建和更新时间戳等关键字段。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class HistoryTable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str content</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str dialog_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+str role</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+List[dict] events</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[datetime] update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+Optional[datetime] create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+__tablename__ : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : content : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : dialog_id : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : role : str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : events : List[dict]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : update_time : Optional[datetime]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : create_time : Optional[datetime]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HistoryTable : __tablename__ : str</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py#L11-L36" target="_blank" rel="noreferrer">history.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py#L11-L36" target="_blank" rel="noreferrer">history.py</a></li></ul><h2 id="字段语义与技术细节" tabindex="-1">字段语义与技术细节 <a class="header-anchor" href="#字段语义与技术细节" aria-label="Permalink to &quot;字段语义与技术细节&quot;">​</a></h2><h3 id="角色字段-role" tabindex="-1">角色字段 (role) <a class="header-anchor" href="#角色字段-role" aria-label="Permalink to &quot;角色字段 (role)&quot;">​</a></h3><p><code>role</code>字段用于标识消息的发送者类型，其值限定为&quot;assistant&quot;、&quot;system&quot;或&quot;user&quot;三种字面量之一。这一设计确保了消息来源的明确性，便于后续处理和展示。在服务层，通过常量<code>Assistant_Role</code>和<code>User_Role</code>来引用这些值，提高了代码的可读性和维护性。</p><h3 id="内容字段-content" tabindex="-1">内容字段 (content) <a class="header-anchor" href="#内容字段-content" aria-label="Permalink to &quot;内容字段 (content)&quot;">​</a></h3><p><code>content</code>字段存储消息的实际文本内容，使用<code>Text</code>类型进行数据库列定义，支持大文本存储。该字段被设计为可变长度文本，能够容纳用户输入和AI生成的长篇回复。在应用层面，内容字段直接映射到LangChain框架中的<code>BaseMessage</code>对象，实现了与外部组件的无缝集成。</p><h3 id="对话id字段-dialog-id" tabindex="-1">对话ID字段 (dialog_id) <a class="header-anchor" href="#对话id字段-dialog-id" aria-label="Permalink to &quot;对话ID字段 (dialog_id)&quot;">​</a></h3><p><code>dialog_id</code>字段是消息模型与对话模型建立关联的关键。每个消息都必须归属于一个特定的对话，通过<code>dialog_id</code>外键引用<code>dialog</code>表的主键。这种设计实现了消息的组织化存储，使得按对话查询历史记录成为可能。</p><h3 id="创建时间字段-created-at" tabindex="-1">创建时间字段 (created_at) <a class="header-anchor" href="#创建时间字段-created-at" aria-label="Permalink to &quot;创建时间字段 (created_at)&quot;">​</a></h3><p><code>create_time</code>字段记录消息的创建时间，使用<code>DateTime</code>类型存储，并设置了数据库级别的默认值<code>CURRENT_TIMESTAMP</code>。该字段对于实现时间序列查询、按时间排序消息历史等功能至关重要。同时，它也是计算对话活跃度、统计用户行为等分析任务的基础数据。</p><h2 id="与对话模型的关联" tabindex="-1">与对话模型的关联 <a class="header-anchor" href="#与对话模型的关联" aria-label="Permalink to &quot;与对话模型的关联&quot;">​</a></h2><p>消息模型与对话模型之间存在明确的一对多关系，即一个对话可以包含多条消息，而每条消息只能属于一个对话。这种关系通过<code>HistoryTable</code>中的<code>dialog_id</code>字段与<code>DialogTable</code>中的<code>dialog_id</code>主键建立。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">erDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIALOG {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str dialog_id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str agent_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str agent_type</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str user_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HISTORY {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str id PK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str content</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str dialog_id FK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str role</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">List[dict] events</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime update_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime create_time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIALOG ||--o{ HISTORY : &quot;包含&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py#L11-L36" target="_blank" rel="noreferrer">history.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py#L11-L36" target="_blank" rel="noreferrer">dialog.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/history.py#L11-L36" target="_blank" rel="noreferrer">history.py</a></li><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/models/dialog.py#L11-L36" target="_blank" rel="noreferrer">dialog.py</a></li></ul><h2 id="文本存储与token计数" tabindex="-1">文本存储与Token计数 <a class="header-anchor" href="#文本存储与token计数" aria-label="Permalink to &quot;文本存储与Token计数&quot;">​</a></h2><h3 id="文本存储策略" tabindex="-1">文本存储策略 <a class="header-anchor" href="#文本存储策略" aria-label="Permalink to &quot;文本存储策略&quot;">​</a></h3><p><code>content</code>字段采用<code>Text</code>类型存储，能够支持大容量文本内容。数据库层面通过<code>sa_column=Column(Text)</code>配置，确保了对长文本的良好支持。这种设计允许系统处理复杂的对话内容，包括代码片段、长篇回答等。</p><h3 id="token计数的计算时机与用途" tabindex="-1">Token计数的计算时机与用途 <a class="header-anchor" href="#token计数的计算时机与用途" aria-label="Permalink to &quot;Token计数的计算时机与用途&quot;">​</a></h3><p>虽然当前代码中未直接体现<code>token_count</code>字段，但其计算逻辑隐含在消息处理流程中。通常，Token计数会在消息创建时或AI生成响应后进行计算，主要用于成本统计和资源管理。例如，在调用LLM API时，可以根据输入和输出的Token数量来计算服务成本。此外，Token计数还可用于限制单次请求的长度，防止超出模型的最大上下文窗口。</p><h2 id="大规模存储性能挑战" tabindex="-1">大规模存储性能挑战 <a class="header-anchor" href="#大规模存储性能挑战" aria-label="Permalink to &quot;大规模存储性能挑战&quot;">​</a></h2><p>随着系统使用时间的增长，消息表将积累大量数据，可能达到数百万甚至更多记录。这带来了以下几个主要性能挑战：</p><ol><li><strong>查询性能下降</strong>：全表扫描或复杂查询的执行时间会显著增加。</li><li><strong>索引维护成本</strong>：大型表的索引更新和维护需要更多资源。</li><li><strong>存储空间压力</strong>：大量文本数据会快速消耗存储空间。</li><li><strong>备份与恢复时间</strong>：数据库备份和恢复操作的时间会大幅延长。</li></ol><p>为应对这些挑战，系统采用了分页查询和按对话加载的策略，避免一次性加载过多数据。</p><h2 id="dao层实现与查询机制" tabindex="-1">DAO层实现与查询机制 <a class="header-anchor" href="#dao层实现与查询机制" aria-label="Permalink to &quot;DAO层实现与查询机制&quot;">​</a></h2><h3 id="分页查询实现" tabindex="-1">分页查询实现 <a class="header-anchor" href="#分页查询实现" aria-label="Permalink to &quot;分页查询实现&quot;">​</a></h3><p>DAO层通过<code>select_history_from_time</code>方法实现了基于时间的分页查询。该方法接收<code>dialog_id</code>和<code>k</code>参数，返回指定对话的最近<code>k</code>条消息。查询结果首先按创建时间降序排列，然后截取前<code>k</code>条记录，最后反转顺序以保持从旧到新的时间序列。</p><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start([开始]) --&gt; QueryDB[&quot;执行数据库查询&lt;br/&gt;SELECT * FROM history&lt;br/&gt;WHERE dialog_id = ?&lt;br/&gt;ORDER BY create_time DESC&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">QueryDB --&gt; GetResults[&quot;获取查询结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GetResults --&gt; CheckCount{&quot;结果数量 &gt; k?&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckCount --&gt; |是| Truncate[&quot;截取前k条记录&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CheckCount --&gt; |否| KeepAll[&quot;保留所有记录&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Truncate --&gt; Reverse[&quot;反转结果顺序&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KeepAll --&gt; Reverse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Reverse --&gt; ReturnResults[&quot;返回结果&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ReturnResults --&gt; End([结束])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>图示来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/history.py#L21-L32" target="_blank" rel="noreferrer">history.py</a></li></ul><p><strong>本节来源</strong></p><ul><li><a href="https://github.com/Shy2593666979/AgentChat/src/backend/agentchat/database/dao/history.py#L21-L32" target="_blank" rel="noreferrer">history.py</a></li></ul><h3 id="按对话加载历史消息" tabindex="-1">按对话加载历史消息 <a class="header-anchor" href="#按对话加载历史消息" aria-label="Permalink to &quot;按对话加载历史消息&quot;">​</a></h3><p>服务层的<code>get_dialog_history</code>方法提供了按对话加载完整历史消息的功能。该方法调用DAO层的对应实现，返回指定对话的所有消息记录，并按创建时间升序排列，确保消息的时序正确性。</p><h2 id="索引优化建议" tabindex="-1">索引优化建议 <a class="header-anchor" href="#索引优化建议" aria-label="Permalink to &quot;索引优化建议&quot;">​</a></h2><p>为了优化大规模消息存储下的查询性能，建议在以下字段上建立复合索引：</p><ul><li><strong>(dialog_id, create_time)</strong>：此复合索引能显著加速按对话ID和时间范围查询消息的操作。由于大多数查询都是针对特定对话的历史记录，且通常需要按时间排序，该索引能有效减少查询扫描的数据量。</li><li><strong>create_time</strong>：单独在创建时间字段上建立索引，有助于全局时间序列分析和统计查询。</li></ul><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 建议的索引创建语句</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_dialog_time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> history (dialog_id, create_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_create_time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> history (create_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这些索引将大大提高<code>select_history_from_time</code>和<code>get_dialog_history</code>等关键查询的性能，特别是在数据量庞大的情况下。</p><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>Message模型作为AgentChat系统中对话历史的基本单元，其设计充分考虑了功能性、性能和可扩展性。通过<code>dialog_id</code>与Dialog模型建立的强关联，实现了消息的组织化存储和高效查询。<code>content</code>字段的文本存储策略支持大容量内容，而潜在的Token计数机制为成本统计和资源管理提供了基础。面对大规模存储的性能挑战，系统通过分页查询和按对话加载的策略进行应对，并建议通过复合索引进一步优化查询性能。整体设计体现了良好的数据建模实践，为系统的稳定运行和未来发展奠定了坚实基础。</p>`,55)])])}const b=s(t,[["render",l]]);export{k as __pageData,b as default};
